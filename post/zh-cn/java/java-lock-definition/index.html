<!DOCTYPE html><html lang="en" class="scroll-smooth" data-astro-cid-37fxchfa> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.ico" type="image/x-icon"><!-- <link rel="icon" type="image/svg+xml" href="/favicon1.svg" /> --><meta name="generator" content="Astro v4.16.2"><!-- Canonical URL --><link rel="canonical" href="https://blog-template-gray.vercel.app/post/zh-cn/java/java-lock-definition/"><!-- Primary Meta Tags --><title>ReentrantLock &amp; synchronized &amp; ReentrantReadWriteLock • 知道的越多,才知知道的越少</title><!-- ViewTransitions  --><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><!-- SEO --><meta name="title" content="ReentrantLock &#38; synchronized &#38; ReentrantReadWriteLock • 知道的越多,才知知道的越少"><meta name="description" content="Java 常用锁的介绍 &#38; 底层代码"><meta name="author" content="chou403"><!-- Open Graph / Facebook --><meta property="og:type" content="article"><meta property="og:url" content="https://blog-template-gray.vercel.app/post/zh-cn/java/java-lock-definition/"><meta property="og:title" content="ReentrantLock &#38; synchronized &#38; ReentrantReadWriteLock"><meta property="og:description" content="Java 常用锁的介绍 &#38; 底层代码"><meta property="og:image" content="https://blog-template-gray.vercel.app/_astro/triger-5.jpg"><meta property="article:author" content="chou403"><meta property="article:published_time" content="2024-08-09T14:46:19.000Z"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog-template-gray.vercel.app/post/zh-cn/java/java-lock-definition/"><meta property="twitter:title" content="ReentrantLock &#38; synchronized &#38; ReentrantReadWriteLock"><meta property="twitter:description" content="Java 常用锁的介绍 &#38; 底层代码"><meta property="twitter:image" content="https://blog-template-gray.vercel.app/_astro/triger-5.jpg"><!-- RSS auto-discovery --><link rel="alternate" type="application/rss+xml" title="知道的越多,才知知道的越少" href="/rss.xml"><link as="font" crossorigin rel="preload" href="/fonts/Manrope-Bold.woff2" type="font/woff2"><style>@font-face {font-weight: 200;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-ExtraLight.woff2)} @font-face {font-weight: 300;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-Light.woff2)} @font-face {font-weight: 400;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-Regular.woff2)} @font-face {font-weight: 500;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-Medium.woff2)} @font-face {font-weight: 600;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-SemiBold.woff2)} @font-face {font-weight: 700;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-Bold.woff2)} @font-face {font-weight: 800;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-ExtraBold.woff2)} @font-face { font-family: '_font_fallback_1114385179943'; size-adjust: 103.76%; src: local('Arial'); ascent-override: 102.74%; descent-override: 28.91%; line-gap-override: 0.00%; }</style><script>
	function getTheme() {
		const storedTheme = typeof localStorage !== 'undefined' && localStorage.getItem('theme')

		return (
			storedTheme || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark')
		)
	}

	function setTheme(newTheme) {
		const html = document.documentElement
		const isDark = newTheme === 'dark'

		html.classList.toggle('dark', isDark)
		html.classList.toggle('light', !isDark)

		localStorage.setItem('theme', newTheme)
	}

	// set initial theme
	setTheme(getTheme())
	document.addEventListener('astro:after-swap', () => setTheme(getTheme()))

	document.addEventListener('theme-change', (e) => {
		setTheme(e.detail.theme)
	})
</script><script>
	if (!('animations' in localStorage)) {
		localStorage.setItem('animations', 'true')
	} else {
		localStorage.setItem('animations', 'false')
	}
</script><link rel="stylesheet" href="/_astro/_page_.CCiJ3j76.css">
<link rel="stylesheet" href="/_astro/_slug_.Ba2ksmBT.css"><script type="module" src="/_astro/hoisted.D9DAUC0s.js"></script></head> <body class="mx-auto bg-white dark:bg-slate-900 dark:text-slate-400 dark:text-white" data-astro-cid-37fxchfa> <main class="mt-4 grid gap-12 overflow-hidden px-5 antialiased sm:mx-auto sm:max-w-2xl sm:px-8 md:max-w-6xl md:overflow-visible lg:px-0" data-astro-cid-37fxchfa> <header class="fixed left-0 top-0 z-50 flex h-12 w-full items-center bg-[#f8f9fa99] px-5 py-2.5 font-semibold dark:border-slate-50/[0.06] dark:bg-slate-900/60"> <a class="mr-auto text-lg" href="/">Home</a> <div id="astro-header-drawer" class="absolute right-1 top-12 z-50 translate-x-96 rounded-l-lg bg-white p-4 text-slate-500 shadow transition-transform duration-300 ease-in dark:bg-[#0a0910] md:static md:h-auto md:translate-x-0 md:rounded-none md:border-none md:bg-transparent md:p-0 md:shadow-none dark:md:bg-transparent"> <nav class="flex h-full justify-between gap-2 text-left md:w-full md:flex-row md:gap-5"> <div class="flex flex-col gap-4 border-black pr-4 dark:border-white md:flex-row md:border-r-2"> <a href="/tags" class="text-opacity-60 flex items-center gap-1 text-2xl md:text-base" rel="noopener noreferrer ">  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 md:w-6" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path> <path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path> <path d="M6 9h-.01"></path> </svg> Tags
 </a> </div> <div class="flex items-center justify-center gap-3 md:justify-end md:p-0"> <a href="https://github.com/chou403/chou403.github.io" class="text-opacity-60" rel="noopener noreferrer " target="_blank" aria-label="Github">  <span><svg viewBox="0 0 16 16" class="h-5 w-5" fill="currentColor" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg> </span>  </a> </div> <!-- <LanguageSwitcher client:load /> --> </nav> </div> <div class="flex items-center gap-3 text-slate-500 md:pl-3" data-astro-transition-persist="navbar"> <div> <site-search id="search" class="ms-auto"> <button data-open-modal disabled class="flex items-center justify-center rounded-md gap-1"> <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="m19 19-3.5-3.5"></path><circle cx="11" cy="11" r="6"></circle></svg> <!-- <span class='md:hidden text-2xl'> Search</span> --> </button> <dialog aria-label="search" class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-white dark:bg-[#0a0910ec] shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md opacity-0"> <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6"> <button data-close-modal class="ms-auto cursor-pointer rounded-full bg-black text-white px-4 py-2 dark:bg-white dark:text-black">Close</button> <div class="search-container dark:text-white"> <div id="pagefind__search"></div> </div> </div> </dialog> </site-search>   </div>  <theme-toggle class="relative h-6 w-6"> <button id="toggle-theme" class="group" aria-label="Toggle Theme"> <span class="absolute left-0 right-0 top-0 opacity-0 group-aria-pressed:opacity-100"> <svg viewBox="0 0 24 24" fill="none" class="h-6 w-6"><path fill-rule="evenodd" clip-rule="evenodd" d="M17.715 15.15A6.5 6.5 0 0 1 9 6.035C6.106 6.922 4 9.645 4 12.867c0 3.94 3.153 7.136 7.042 7.136 3.101 0 5.734-2.032 6.673-4.853Z" class="fill-sky-400/20"></path><path d="m17.715 15.15.95.316a1 1 0 0 0-1.445-1.185l.495.869ZM9 6.035l.846.534a1 1 0 0 0-1.14-1.49L9 6.035Zm8.221 8.246a5.47 5.47 0 0 1-2.72.718v2a7.47 7.47 0 0 0 3.71-.98l-.99-1.738Zm-2.72.718A5.5 5.5 0 0 1 9 9.5H7a7.5 7.5 0 0 0 7.5 7.5v-2ZM9 9.5c0-1.079.31-2.082.845-2.93L8.153 5.5A7.47 7.47 0 0 0 7 9.5h2Zm-4 3.368C5 10.089 6.815 7.75 9.292 6.99L8.706 5.08C5.397 6.094 3 9.201 3 12.867h2Zm6.042 6.136C7.718 19.003 5 16.268 5 12.867H3c0 4.48 3.588 8.136 8.042 8.136v-2Zm5.725-4.17c-.81 2.433-3.074 4.17-5.725 4.17v2c3.552 0 6.553-2.327 7.622-5.537l-1.897-.632Z" class="fill-sky-500"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M17 3a1 1 0 0 1 1 1 2 2 0 0 0 2 2 1 1 0 1 1 0 2 2 2 0 0 0-2 2 1 1 0 1 1-2 0 2 2 0 0 0-2-2 1 1 0 1 1 0-2 2 2 0 0 0 2-2 1 1 0 0 1 1-1Z" class="fill-sky-500"></path></svg> </span> <span class="absolute left-0 right-0 top-0 opacity-0 group-aria-[pressed=false]:opacity-100"> <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" class="fill-sky-400/20 stroke-sky-500"></path><path d="M12 4v1M17.66 6.344l-.828.828M20.005 12.004h-1M17.66 17.664l-.828-.828M12 20.01V19M6.34 17.664l.835-.836M3.995 12.004h1.01M6 6l.835.836" class="stroke-sky-500"></path></svg> </span> </button> </theme-toggle> <script>
	const button = document.getElementById('toggle-theme')

	function setButtonPresssed() {
		const bodyThemeIsDark = document.documentElement.classList.contains('dark')
		button.setAttribute('aria-pressed', String(bodyThemeIsDark))
	}
	setButtonPresssed()
</script> <button id="toggleMenu" class="md:ml-6 md:hidden"> <svg width="24" height="24"><path d="M5 6h14M5 12h14M5 18h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path></svg> </button> <button id="astro-header-drawer-button" type="button" class="md:ml-6 md:hidden"> <svg width="24" height="24" fill="none" aria-hidden="true"><path d="M12 6v.01M12 12v.01M12 18v.01M12 7a1 1 0 1 1 0-2 1 1 0 0 1 0 2Zm0 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Zm0 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg> <span class="sr-only">Show Menu</span> </button> </div> </header>  <div class="pointer-events-none absolute inset-x-0 top-0 z-[60] flex justify-center overflow-hidden"> <div class="flex w-[108rem] flex-none justify-end"> <picture> <source srcset="/_astro/docs.BiePeNN8.avif" type="image/avif"> <img src="/_astro/docs.BeNwu2rW_1CTG48.webp" class="w-[71.75rem] max-w-none flex-none dark:hidden" alt="img of docs" width="200" height="200" loading="lazy" decoding="async"> </picture> <picture> <source srcset="/_astro/docs-dark.C7CksN2y.avif" type="image/avif"> <img src="/_astro/docs-dark.Bsq-hjJH_17S3ea.webp" class="hidden w-[90rem] max-w-none flex-none dark:block" alt="img of docs-dark" width="200" height="200" loading="lazy" decoding="async"> </picture> </div> </div>  <article class="mt-12 min-w-full sm:max-w-none md:max-w-none md:py-4"> <header class="mb-3 flex flex-col gap-6"> <div class="flex flex-wrap gap-2"> <div class="flex items-center justify-center"> <h1 class="text-4xl font-semibold md:pb-2.5 md:text-4xl"> Java 常用锁的介绍 &amp; 底层代码 </h1> </div> </div> <div class="flex gap-x-1"> <p class="text-center text-sm font-bold text-opacity-50"> chou403 </p> <p class="text-center text-sm font-bold text-opacity-50">
/ Java </p> <p class="text-center text-sm text-opacity-50">
/ <time class="text-sm font-bold text-opacity-60" datetime="2022-09-25T15:20:35.000Z"> Sep 25, 2022 </time> </p> <p class="text-center text-sm font-bold text-opacity-50">
/ 71 min read </p> <!-- {
					data.updatedDate && (
						<span class="text-quote rounded-lg p-1">
							Last Updated:
							<FormattedDate date={data.updatedDate} />
						</span>
					)
				} --> </div> </header> <!-- annotate blog post image --> <!-- <>
			{
				heroImage && (
					<Image
						src={heroImage}
						width={1000}
						height={500}
						quality={100}
						format="jpg"
						loading="eager"
						class="my-8 max-h-[300px] w-full rounded-md object-cover md:max-h-[500px]"
						alt={`img of ${title}`}
					/>
				)
			}
		</> --> <hr> <div>   <div class="mt-8 grid grid-cols-1 gap-10"> <!-- aside  --> <!-- Left menu bar comments --> <!-- <aside class="hidden flex-col gap-8 md:flex">
			<div class="sticky top-12 z-10 hidden self-start transition-all duration-200 md:block">
				{headings && headings.length > 0 && <TableOfContents {headings} />}
			</div>
		</aside> --> <!-- post --> <article class="grid w-full max-w-full"> <div class="prose prose-lg mb-12 min-w-full dark:prose-invert md:prose-xl"> <h2 id="java-中锁的分类">Java 中锁的分类</h2>
<ol>
<li>
<p><strong>可重入锁,不可重入锁</strong></p>
<p>Java 中提供的 synchronized,ReentrantLock,ReentrantReadWriteLock 都是可重入锁。</p>
<p><strong>重入</strong>: 当前线程获取到 A 锁,在获取之后尝试再次获取 A 锁是可以直接拿到的</p>
<p><strong>不可重入</strong>: 当前线程获取到 A 锁,在获取之后尝试再次获取 A 锁,无法获取到的,因为 A 锁被当前线程占用着,需要等待自己释放锁再获取锁。</p>
</li>
<li>
<p><strong>乐观锁,悲观锁</strong></p>
<p>Java 中提供的 synchronized,ReentrantLock,ReentrantReadWriteLock 都是悲观锁。</p>
<p>Java 中提供的 CAS 操作,就是乐观锁的一种实现。</p>
<p><strong>悲观锁</strong>: 获取不到资源时,会将当前线程挂起(进入 BLOCKED,WAITING),线程挂起会涉及到用户态和内核态的切换,而这种切换是比较消耗资源的。</p>
<ul>
<li>用户态: JVM 可以自行执行的指令,不需要借助操作系统执行。</li>
<li>内核态: JVM 不可以自行执行,需要操作系统才可以执行。</li>
</ul>
<p><strong>乐观锁</strong>: 获取不到资源,可以再次让 CPU 调度,重新尝试获取锁资源。</p>
<p>Atomic 原子性类中,就是基于 CAS 乐观锁实现的。</p>
</li>
<li>
<p><strong>公平锁,非公平锁</strong></p>
<p>Java 中提供的 synchronized 只能是非公平锁。</p>
<p>Java 中提供的 ReentrantLock,ReentrantReadWriteLock 可以实现公平锁和非公平锁。</p>
<p><strong>公平锁</strong>: 线程 A 获取到了锁资源,线程 B 没有获得,线程 B 去排队,线程 C 来了,锁被 A 持有,同时线程 B 在排队,直接排到 B 的后面,等待 B 拿到锁资源或者 B 取消后,才可以尝试去竞争锁资源。</p>
<p><strong>非公平锁</strong>: 线程 A 获取到了锁资源,线程 B 没有获得,线程 B 去排队,线程 C 来了,先尝试竞争一波。</p>
<ul>
<li>拿到锁资源: 开心,插队成功。</li>
<li>没有拿到锁资源: 依然要排到 B 的后面,等待 B 拿到锁资源或者 B 取消后,才可以尝试去竞争锁资源。</li>
</ul>
</li>
<li>
<p><strong>互斥锁,共享锁</strong></p>
<p>Java 中提供的 synchronized,ReentrantLock 是互斥锁。</p>
<p>Java 中提供的 ReentrantReadWriteLock 有互斥锁也有共享锁。</p>
<p><strong>互斥锁</strong>: 同一个时间点,只会有一个线程持有者当前互斥锁。</p>
<p><strong>共享锁</strong>: 同一个时间点,当前共享锁可以被多个线程同时持有。</p>
</li>
</ol>
<h2 id="reentrantlock">ReentrantLock</h2>
<p>实现加锁 lock() ----&gt; 线程阻塞:</p>
<ul>
<li>wait() 可以阻塞线程,但是必须要结合synchronized 一起使用。</li>
<li>sleep() 可以阻塞线程,但是必须指定时间,只能通过中断方式唤醒。</li>
<li>park() 可以阻塞线程,unpark() 进行唤醒。</li>
<li>while(true)  可以阻塞线程,cas。</li>
</ul>
<h3 id="公平锁">公平锁</h3>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> FairSync</span><span style="color:#F97583"> extends</span><span style="color:#B392F0"> Sync</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> long</span><span style="color:#E1E4E8"> serialVersionUID </span><span style="color:#F97583">=</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">3000897897090466540L</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    /**</span></span>
<span class="line"><span style="color:#6A737D">     * Fair version of tryAcquire.  Don&#39;t grant access unless</span></span>
<span class="line"><span style="color:#6A737D">     * recursive call or no waiters or is first.</span></span>
<span class="line"><span style="color:#6A737D">     */</span></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">ReservedStackAccess</span><span style="color:#F97583"> private</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> tryAcquire</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#FFAB70"> acquires</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        final</span><span style="color:#E1E4E8"> Thread current </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Thread.</span><span style="color:#B392F0">currentThread</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getState</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">        // state 0 加锁</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (c </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">            // hasQueuedPredecessors() 被设计为用于公平的同步器,以避免碰撞</span></span>
<span class="line"><span style="color:#6A737D">            // 如果当前线程之前有一个排队线程,则为true,如果当前线程位于队列的头部或者队列为空,则为false</span></span>
<span class="line"><span style="color:#6A737D">            // compareAndSetState(0, acquires) cas</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#B392F0">hasQueuedPredecessors</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#B392F0">                    compareAndSetState</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, acquires)) {</span></span>
<span class="line"><span style="color:#B392F0">                setExclusiveOwnerThread</span><span style="color:#E1E4E8">(current);</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#6A737D">        // 判断加锁线程是否为当前线程 state+1 重入</span></span>
<span class="line"><span style="color:#F97583">        else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (current </span><span style="color:#F97583">==</span><span style="color:#B392F0"> getExclusiveOwnerThread</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">            int</span><span style="color:#E1E4E8"> nextc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> acquires;</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (nextc </span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">                throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Maximum lock count exceeded&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">            setState</span><span style="color:#E1E4E8">(nextc);</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#6A737D">        // 加锁失败</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> hasQueuedPredecessors</span><span style="color:#E1E4E8">(){</span></span>
<span class="line"><span style="color:#E1E4E8">        Node h,s;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8">((h</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">head)</span><span style="color:#F97583">!=</span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">){</span></span>
<span class="line"><span style="color:#6A737D">        // (s = h.next) == null 防止空指针的标准写法,除了防止空指针,还会将当前节点复制到h变量上</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8">((s</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">h.next)</span><span style="color:#F97583">==</span><span style="color:#79B8FF">null</span><span style="color:#F97583">||</span><span style="color:#E1E4E8">s.waitStatus</span><span style="color:#F97583">&gt;</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">){</span></span>
<span class="line"><span style="color:#E1E4E8">        s</span><span style="color:#F97583">=</span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// traverse in case of concurrent cancellation</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8">(Node p</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">tail;p</span><span style="color:#F97583">!=</span><span style="color:#E1E4E8">h</span><span style="color:#F97583">&amp;&amp;</span><span style="color:#E1E4E8">p</span><span style="color:#F97583">!=</span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">;p</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">p.prev){</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8">(p.waitStatus</span><span style="color:#F97583">&lt;=</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        s</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">p;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8">(s</span><span style="color:#F97583">!=</span><span style="color:#79B8FF">null</span><span style="color:#F97583">&amp;&amp;</span><span style="color:#E1E4E8">s.thread</span><span style="color:#F97583">!=</span><span style="color:#E1E4E8">Thread.</span><span style="color:#B392F0">currentThread</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span></code></pre> </div> 
<h3 id="非公平锁">非公平锁</h3>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> NonfairSync</span><span style="color:#F97583"> extends</span><span style="color:#B392F0"> Sync</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> long</span><span style="color:#E1E4E8"> serialVersionUID </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 7316153563782823691L</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> tryAcquire</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#FFAB70"> acquires</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> nonfairTryAcquire</span><span style="color:#E1E4E8">(acquires);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> nonfairTryAcquire</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> acquires){</span></span>
<span class="line"><span style="color:#F97583">final</span><span style="color:#E1E4E8"> Thread current</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">Thread.</span><span style="color:#B392F0">currentThread</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> c</span><span style="color:#F97583">=</span><span style="color:#B392F0">getState</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8">(c</span><span style="color:#F97583">==</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">){</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">compareAndSetState</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">,acquires)){</span></span>
<span class="line"><span style="color:#B392F0">        setExclusiveOwnerThread</span><span style="color:#E1E4E8">(current);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8">(current</span><span style="color:#F97583">==</span><span style="color:#B392F0">getExclusiveOwnerThread</span><span style="color:#E1E4E8">()){</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> nextc</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">c</span><span style="color:#F97583">+</span><span style="color:#E1E4E8">acquires;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8">(nextc</span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) </span><span style="color:#6A737D">// overflow</span></span>
<span class="line"><span style="color:#F97583">        throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Maximum lock count exceeded&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">        setState</span><span style="color:#E1E4E8">(nextc);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span></code></pre> </div> 
<h2 id="synchronized-在-jdk16-的优化">synchronized 在 JDK1.6 的优化</h2>
<p>在JDK1.5 的时候 Doug lee 推出了 ReentrantLock,lock 的性能远高于 synchronized,所以 JDK1.6 的时候团队就对 synchronized 进行了大量的优化。</p>
<p><strong>锁消除</strong>: 在 synchronized 修饰的代码中,如果不存在操作临界资源的情况,会触发锁消除,你即便写了 synchronized,也不会触发。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> synchronized</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> method</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">  // 没有操作临界资源</span></span>
<span class="line"><span style="color:#6A737D">  // 此时这个方法的 synchronized 可以认为没有</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p><strong>锁膨胀</strong>: 如果在一个循环中,频繁的获取和释放资源,这样带来的消耗很大,锁膨胀就是将锁的范围放大,避免频繁的竞争和获取锁资源带来不必要的消耗。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> method</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">  for</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, i </span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 99999</span><span style="color:#E1E4E8">;i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    synchronized</span><span style="color:#E1E4E8">(对象) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#6A737D">// 这时上面的锁会触发锁膨胀</span></span>
<span class="line"></span></code></pre> </div> 
<p><strong>锁升级</strong>: ReentrantLock 的实现,是先基于乐观锁的 CAS 尝试获取锁资源,如果拿不到锁资源,才会挂起线程。</p>
<p>synchronized 在 JDK1.6 之前,完全就是获取不到锁,立即挂起当前线程,所以 synchronized 性能很差。</p>
<p>synchronized 就在 JDK1.6 做了锁升级的优化。</p>
<ul>
<li><strong>无锁,匿名偏向</strong>: 当前线程没有作为锁的存在。</li>
<li><strong>偏向锁</strong>: 如果当前锁资源,只有一个线程在频繁的获取和释放,那么这个线程过来,只需要判断,当前指向的线程是否当前线程。
<ul>
<li>如果是,直接拿着锁资源走。</li>
<li>如果不是,基于 CAS 的方式,尝试将偏向锁指向当前线程,如果获取不到,触发锁升级,升级为轻量级锁。(偏向锁状态出现了所竞争的情况)</li>
</ul>
</li>
<li><strong>轻量级锁</strong>: 会采用自旋锁的方式去频繁的以 CAS 的形式获取锁资源(采用的是自适应自旋锁)
<ul>
<li>如果成功获取到,拿着锁资源走。</li>
<li>如果自旋了一定的次数,没拿到锁,锁升级。</li>
</ul>
</li>
<li><strong>重量级锁</strong>: 就是最传统的 synchronized 方式,拿不到锁资源,就挂起当前线程。(用户态&amp;内核态)</li>
</ul>
<h2 id="synchronized-的实现原理">synchronized 的实现原理</h2>
<p>synchronized 是基于对象实现的。</p>
<p>synchronized 的底层实现是完全依赖JVM虚拟机的,所以先看看对象的存储结构。</p>
<h3 id="对象结构">对象结构</h3>
<p>JVM是虚拟机,是一种标准规范,主要作用就是运行java的类文件的。而虚拟机有很多实现版本,HotSpot就是虚拟机的一种实现,是基于热点代码探测的,有JIT即时编译功能,能提供更高质量的本地代码。HotSpot 虚拟机中对象在内存中可分为对象头(Header),实例数据(Instance Data)和对齐填充(Padding)。其组成结构如下图:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202402281129677.png" alt="image-20230825223549259"/></p>
<p>1)实例数据: 存放类的属性数据信息,包括父类的属性信息。如果是数组,那么实例部分还包括数组的长度,这部分内存按4字节对齐。</p>
<p>2)对齐填充: 虚拟机要求对象起始地址必须是8字节的整数倍。填充数据不是必须存在的,仅仅是为了字节对齐。</p>
<p>3)对象头</p>
<p>对于元数据指针,虚拟机通过这个指针来确定这个对象是哪个类的实例;</p>
<p>对于标记字段,用于存储对象自身的运行时数据,其组成如下图</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202402281129588.png" alt="img"/></p>
<p>锁信息占3位)在jdk1.6之前只有重量级锁,而1.6后对其进行了优化,就有了偏向锁和轻量级锁。</p>
<h3 id="上锁的原理">上锁的原理</h3>
<p>JVM规范中描述: 每个对象有一个监视器锁(monitor)。</p>
<p>monitorenter指向同步代码块开始的位置,monitorexit指向同步代码块结束的位置。</p>
<p>当monitor被占用时就会处于锁定状态,线程执行monitorenter指令时尝试获取monitor的所有权,执行monitorexit 释放所有权,过程如下:</p>
<ol>
<li>如果monitor的进入数为0,则该线程进入monitor,然后将进入数设置为1,该线程即为monitor的所有者。</li>
<li>如果线程已经占有该monitor,只是重新进入,则进入monitor的进入数加1。</li>
<li>如果其他线程已经占用了monitor,则该线程进入阻塞状态,直到monitor的进入数为0,再重新尝试获取monitor的所有权。</li>
</ol>
<p>Synchronized的语义底层是通过一个monitor的对象来完成,其实wait/notify等方法也依赖于monitor对象。</p>
<p>这就是为什么只有在同步的块或者方法中才能调用wait/notify等方法,否则会抛出java.lang.IllegalMonitorStateException的异常的原因。</p>
<p><strong>Synchronized是通过对象内部的一个叫做监视器锁(monitor)来实现的。</strong></p>
<p>但是监视器锁本质又是依赖于底层的操作系统的互斥锁(Mutex Lock)来实现的。而操作系统实现线程之间的切换这就需要从用户态转换到核心态,这个成本非常高,状态之间的转换需要相对比较长的时间,这就是为什么Synchronized效率低的原因。</p>
<p>因此,这种依赖于操作系统互斥锁(Mutex Lock)所实现的锁我们称之为”重量级锁”。</p>
<h2 id="reentrantlock和synchronized的区别">ReentrantLock和synchronized的区别</h2>
<p>在 Java 中,常用的锁有两种: synchronized(内置锁)和 ReentrantLock(可重入锁)。</p>
<h3 id="用法不同">用法不同</h3>
<p><strong>synchronized 可用来修饰普通方法,静态方法和代码块,而 ReentrantLock 只能用在代码块上。</strong></p>
<p>使用 synchronized 修饰代码块:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> method</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">  // 加锁代码</span></span>
<span class="line"><span style="color:#F97583">  synchronized</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">    //...</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>ReentrantLock 在使用之前需要先创建 ReentrantLock 对象,然后使用 lock 方法进行加锁,使用完之后再调用 unlock 方法释放锁,具体使用如下:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> lockExample</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> ReentrantLock lcok </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> ReentrantLock</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">  public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> method</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">    // lock 加锁操作</span></span>
<span class="line"><span style="color:#E1E4E8">    lock.</span><span style="color:#B392F0">lock</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // ...</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">finally</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // 释放锁</span></span>
<span class="line"><span style="color:#E1E4E8">      lock.</span><span style="color:#B392F0">unlock</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h3 id="获取锁和释放锁方式不同">获取锁和释放锁方式不同</h3>
<p><strong>synchronized 会自动加锁和释放锁</strong>,当进入 synchronized 修饰的代码块之后会自动加锁,当离开 synchronized 的代码段之后会自动释放锁,如下图所示:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> APP</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> method</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> count </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    synchronized</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      for</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;i </span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 10</span><span style="color:#E1E4E8">;i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        count</span><span style="color:#F97583">++</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    System.out.</span><span style="color:#B392F0">println</span><span style="color:#E1E4E8">(count);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p><strong>而 ReentrantLock 需要手动加锁和释放锁</strong>,如下图所示:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> lockExample</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> ReentrantLock lcok </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> ReentrantLock</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">  public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> method</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">    // lock 加锁操作</span></span>
<span class="line"><span style="color:#E1E4E8">    lock.</span><span style="color:#B392F0">lock</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // ...</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">finally</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // 释放锁</span></span>
<span class="line"><span style="color:#E1E4E8">      lock.</span><span style="color:#B392F0">unlock</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<blockquote>
<p>PS: 在使用 ReentrantLock 时要特别小心,unlock 释放锁的操作一定要放在 finally 中,否者有可能会出现锁一直被占用,从而导致其他线程一直阻塞的问题。</p>
</blockquote>
<h3 id="锁类型不同">锁类型不同</h3>
<p><strong>synchronized 属于非公平锁,而 ReentrantLock 既可以是公平锁也可以是非公平锁。</strong> 默认情况下 ReentrantLock 为非公平锁,这点查看源码可知:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#B392F0"> ReentrantLock</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">  sync </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> NonfairSync</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>使用 new ReentrantLock(true) 可以创建公平锁,查看源码可知:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#B392F0"> ReentrantLock</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">boolean</span><span style="color:#E1E4E8"> fair) {</span></span>
<span class="line"><span style="color:#E1E4E8">  sync </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> fair </span><span style="color:#F97583">?</span><span style="color:#B392F0"> FairSync</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">:</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> NonfairSync</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h3 id="响应中断不同">响应中断不同</h3>
<p><strong>ReentrantLock 可以使用 lockInterruptibly 获取锁并响应中断指令,而 synchronized 不能响应中断,也就是如果发生了死锁,使用 synchronized 会一直等待下去,而使用 ReentrantLock 可以响应中断并释放锁,从而解决死锁的问题</strong>,比如以下 ReentrantLock 响应中断的示例:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202402281129252.jpg" alt="img"/></p>
<p>以上程序的执行结果如下所示:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202402281129878.jpg" alt="img"/></p>
<h3 id="底层实现不同">底层实现不同</h3>
<p><strong>synchronized 是 JVM 层面通过监视器(Monitor)实现的,而 ReentrantLock 是通过 AQS(AbstractQueuedSynchronizer)程序级别的 API 实现。</strong> synchronized 通过监视器实现,可通过观察编译后的字节码得出结论,如下图所示:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202402281129738.jpg" alt="img"/></p>
<p>其中 monitorenter 表示进入监视器,相当于加锁操作,而 monitorexit 表示退出监视器,相当于释放锁的操作。 ReentrantLock 是通过 AQS 实现,可通过观察 ReentrantLock 的源码得出结论,核心实现源码如下:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202402281137689.jpg" alt="img"/></p>
<h2 id="reentrantreadwritelock的实现原理">ReentrantReadWriteLock的实现原理</h2>
<p>在很多场景下,我们用到的都是互斥锁,线程间相互竞争资源;但是有时候我们的场景会存在读多写少的情况,这个时候如果还是使用互斥锁,就会导致资源的浪费,为什么呢?</p>
<p>因为如果同时都在读的时候,是不需要锁资源的,只有读和写在同时工作的时候才需要锁资源,所以如果直接用互斥锁,肯定会导致资源的浪费。</p>
<h3 id="提供的方法">提供的方法</h3>
<ul>
<li>readLock(): 获取读锁对象(不是获取锁资源)</li>
<li>writeLock(): 获取写锁对象(不是获取锁资源)</li>
<li>getReadLockCount(): 获取当前读锁被获取的次数,包括线程重入的次数</li>
<li>getReadHoldCount(): 返回当前线程获取读锁的次数</li>
<li>isWriteLocked(): 判断写锁是否被获取</li>
<li>getWriteHoldCount(): 返回当前写锁被获取的次数</li>
</ul>
<p><strong>ReentrantReadWriteLock 还是基于 AQS 实现的,还是对 state 进行操作,拿到锁资源就去干活,如果没有拿到,依然去 AQS 队列中排队。</strong></p>
<p><strong>读锁操作: 基于 state 高 16 位进行操作。</strong></p>
<p><strong>写锁操作: 基于 state 低 16 位进行操作。</strong></p>
<p><strong>ReentrantReadWriteLock 依然是可重入锁。</strong></p>
<p><strong>写锁重入</strong>: 读写锁中写锁的重入方式,基本和 ReentrantLock 一致,没有什么区别,依然是对 state + 1 操作即可,只要确认持有锁资源的线程,是当前写锁线程即可,只不过之前 ReentrantLock 的重入次数是 state 的正数取值范围,但是读写锁中写锁范围就小了。</p>
<p><strong>读锁重入</strong>: 因为读锁是共享锁,读锁在获取锁资源操作时,是要对 state 的高 16 位进行 +1 操作。因为读锁是共享锁,所以同一时间会有多个读线程持有读锁资源。这样一来,多个读操作在持有读锁时,无法确认每个线程读锁重入的次数。为了去记录读锁重入的次数,每个读操作的线程,都会有一个 ThreadLocal 记录重入的次数。</p>
<p><strong>写锁的饥饿问题</strong>: 读锁是共享锁,当有线程持有读锁资源时,再来一个线程想要获取读锁,直接对 state 修改即可。在读锁资源先被占用后,来了一个写锁资源,此时,大量的需要获取读锁的线程请求锁资源,如果可以绕过写锁,直接拿资源,会造成写锁长时间无法获取写锁资源。</p>
<p><strong>锁降级</strong>: 当前线程先获取到写锁,然后再获取读锁,再把写锁释放,最后释放读锁。</p>
<p><strong>读锁在拿到锁资源后,如果再有读线程需要获取读锁资源,需要去 AQS 队列排队,如果队列的前面需要获取写锁资源的线程,那么后续读线程是无法拿到锁资源的。持有读锁的线程,只会让写锁线程之前的读线程拿到锁资源。</strong></p>
<h3 id="写锁的获取与释放">写锁的获取与释放</h3>
<p>获取锁的源码:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> tryAcquire</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> acquires) {</span></span>
<span class="line"><span style="color:#6A737D">    /*</span></span>
<span class="line"><span style="color:#6A737D">     * Walkthrough:</span></span>
<span class="line"><span style="color:#6A737D">     * 1. If read count nonzero or write count nonzero</span></span>
<span class="line"><span style="color:#6A737D">     *    and owner is a different thread, fail.</span></span>
<span class="line"><span style="color:#6A737D">     * 2. If count would saturate, fail. (This can only</span></span>
<span class="line"><span style="color:#6A737D">     *    happen if count is already nonzero.)</span></span>
<span class="line"><span style="color:#6A737D">     * 3. Otherwise, this thread is eligible for lock if</span></span>
<span class="line"><span style="color:#6A737D">     *    it is either a reentrant acquire or</span></span>
<span class="line"><span style="color:#6A737D">     *    queue policy allows it. If so, update state</span></span>
<span class="line"><span style="color:#6A737D">     *    and set owner.</span></span>
<span class="line"><span style="color:#6A737D">     */</span></span>
<span class="line"><span style="color:#E1E4E8">    Thread current </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Thread.</span><span style="color:#B392F0">currentThread</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getState</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> w </span><span style="color:#F97583">=</span><span style="color:#B392F0"> exclusiveCount</span><span style="color:#E1E4E8">(c);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (c </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">        // (Note: if c != 0 and w == 0 then shared count != 0)</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (w </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> current </span><span style="color:#F97583">!=</span><span style="color:#B392F0"> getExclusiveOwnerThread</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (w </span><span style="color:#F97583">+</span><span style="color:#B392F0"> exclusiveCount</span><span style="color:#E1E4E8">(acquires) </span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> MAX_COUNT)</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Maximum lock count exceeded&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">        // Reentrant acquire</span></span>
<span class="line"><span style="color:#B392F0">        setState</span><span style="color:#E1E4E8">(c </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> acquires);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">writerShouldBlock</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">||</span></span>
<span class="line"><span style="color:#F97583">        !</span><span style="color:#B392F0">compareAndSetState</span><span style="color:#E1E4E8">(c, c </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> acquires))</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">    setExclusiveOwnerThread</span><span style="color:#E1E4E8">(current);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>释放锁的源码:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> tryRelease</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> releases) {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#B392F0">isHeldExclusively</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#F97583">        throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> IllegalMonitorStateException</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> nextc </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getState</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> releases;</span></span>
<span class="line"><span style="color:#F97583">    boolean</span><span style="color:#E1E4E8"> free </span><span style="color:#F97583">=</span><span style="color:#B392F0"> exclusiveCount</span><span style="color:#E1E4E8">(nextc) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (free)</span></span>
<span class="line"><span style="color:#B392F0">        setExclusiveOwnerThread</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">    setState</span><span style="color:#E1E4E8">(nextc);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> free;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h3 id="读锁的获取与释放">读锁的获取与释放</h3>
<p>获取锁的源码:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#B392F0"> tryAcquireShared</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> unused) {</span></span>
<span class="line"><span style="color:#6A737D">    /*</span></span>
<span class="line"><span style="color:#6A737D">     * Walkthrough:</span></span>
<span class="line"><span style="color:#6A737D">     * 1. If write lock held by another thread, fail.</span></span>
<span class="line"><span style="color:#6A737D">     * 2. Otherwise, this thread is eligible for</span></span>
<span class="line"><span style="color:#6A737D">     *    lock wrt state, so ask if it should block</span></span>
<span class="line"><span style="color:#6A737D">     *    because of queue policy. If not, try</span></span>
<span class="line"><span style="color:#6A737D">     *    to grant by CASing state and updating count.</span></span>
<span class="line"><span style="color:#6A737D">     *    Note that step does not check for reentrant</span></span>
<span class="line"><span style="color:#6A737D">     *    acquires, which is postponed to full version</span></span>
<span class="line"><span style="color:#6A737D">     *    to avoid having to check hold count in</span></span>
<span class="line"><span style="color:#6A737D">     *    the more typical non-reentrant case.</span></span>
<span class="line"><span style="color:#6A737D">     * 3. If step 2 fails either because thread</span></span>
<span class="line"><span style="color:#6A737D">     *    apparently not eligible or CAS fails or count</span></span>
<span class="line"><span style="color:#6A737D">     *    saturated, chain to version with full retry loop.</span></span>
<span class="line"><span style="color:#6A737D">     */</span></span>
<span class="line"><span style="color:#E1E4E8">    Thread current </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Thread.</span><span style="color:#B392F0">currentThread</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getState</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">exclusiveCount</span><span style="color:#E1E4E8">(c) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> &amp;&amp;</span></span>
<span class="line"><span style="color:#B392F0">        getExclusiveOwnerThread</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">!=</span><span style="color:#E1E4E8"> current)</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> r </span><span style="color:#F97583">=</span><span style="color:#B392F0"> sharedCount</span><span style="color:#E1E4E8">(c);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#B392F0">readerShouldBlock</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8">        r </span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8"> MAX_COUNT </span><span style="color:#F97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#B392F0">        compareAndSetState</span><span style="color:#E1E4E8">(c, c </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> SHARED_UNIT)) {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (r </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            firstReader </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> current;</span></span>
<span class="line"><span style="color:#E1E4E8">            firstReaderHoldCount </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (firstReader </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> current) {</span></span>
<span class="line"><span style="color:#E1E4E8">            firstReaderHoldCount</span><span style="color:#F97583">++</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            HoldCounter rh </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cachedHoldCounter;</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (rh </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span></span>
<span class="line"><span style="color:#E1E4E8">                rh.tid </span><span style="color:#F97583">!=</span><span style="color:#E1E4E8"> LockSupport.</span><span style="color:#B392F0">getThreadId</span><span style="color:#E1E4E8">(current))</span></span>
<span class="line"><span style="color:#E1E4E8">                cachedHoldCounter </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> rh </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> readHolds.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">            else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (rh.count </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                readHolds.</span><span style="color:#B392F0">set</span><span style="color:#E1E4E8">(rh);</span></span>
<span class="line"><span style="color:#E1E4E8">            rh.count</span><span style="color:#F97583">++</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> fullTryAcquireShared</span><span style="color:#E1E4E8">(current);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>释放锁的源码:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> tryReleaseShared</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> unused) {</span></span>
<span class="line"><span style="color:#E1E4E8">    Thread current </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Thread.</span><span style="color:#B392F0">currentThread</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (firstReader </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> current) {</span></span>
<span class="line"><span style="color:#6A737D">        // assert firstReaderHoldCount &gt; 0;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (firstReaderHoldCount </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">            firstReader </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        else</span></span>
<span class="line"><span style="color:#E1E4E8">            firstReaderHoldCount</span><span style="color:#F97583">--</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        HoldCounter rh </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cachedHoldCounter;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (rh </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span></span>
<span class="line"><span style="color:#E1E4E8">            rh.tid </span><span style="color:#F97583">!=</span><span style="color:#E1E4E8"> LockSupport.</span><span style="color:#B392F0">getThreadId</span><span style="color:#E1E4E8">(current))</span></span>
<span class="line"><span style="color:#E1E4E8">            rh </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> readHolds.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> count </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> rh.count;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (count </span><span style="color:#F97583">&lt;=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            readHolds.</span><span style="color:#B392F0">remove</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (count </span><span style="color:#F97583">&lt;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">                throw</span><span style="color:#B392F0"> unmatchedUnlockException</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        --</span><span style="color:#E1E4E8">rh.count;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (;;) {</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">=</span><span style="color:#B392F0"> getState</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> nextc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> SHARED_UNIT;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">compareAndSetState</span><span style="color:#E1E4E8">(c, nextc))</span></span>
<span class="line"><span style="color:#6A737D">            // Releasing the read lock has no effect on readers,</span></span>
<span class="line"><span style="color:#6A737D">            // but it may allow waiting writers to proceed if</span></span>
<span class="line"><span style="color:#6A737D">            // both read and write locks are now free.</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> nextc </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h2 id="死锁">死锁</h2>
<h3 id="形成死锁的四个必要条件">形成死锁的四个必要条件</h3>
<ol>
<li><strong>互斥条件</strong>: 进程要求对所分配的资源(如打印机)进行排他性控制,即在一段时间内莫资源仅为一个进程所占有。此时若有其他进程请求资源,则请求进程只能等待。</li>
<li><strong>不可剥夺条件</strong>: 进程所获得的资源在未使用完毕之前,不能被其他进程强行夺走,即只能由获得该资源的进程自己来释放(只能是主动释放)。</li>
<li><strong>请求与保持条件</strong>: 进程已经保持了至少一个资源,但又提出了新的资源请求,而该资源已被其他进程占有,此时请求进程被阻塞,但对自己获得的资源保持不放。</li>
<li><strong>循环等待条件</strong>: 存在一种进程资源的循环等待链,链中每一个进程已获取的资源同时被链中下一个进程所请求。即存在一个处于等待状态的进程集合
<code>{P1,P2,...Pn}</code>,其中Pi等待的资源被 P(i+1)占有(i=0,1,…n-1),Pn等待的资源被P0占有。</li>
</ol>
<p>以上四个条件是死锁的必要条件,只要系统产生死锁,这些条件必然成立,而只要上述条件之一不满足,就不会发生死锁。</p>
<h3 id="处理死锁的方法">处理死锁的方法</h3>
<ol>
<li>
<p><strong>预防死锁</strong></p>
<p>通过设置某些限制条件,去破坏产生死锁的四个必要条件中的一个或几个条件,来防止死锁的产生。</p>
<ul>
<li>
<p>破坏”互斥”条件</p>
<p>就是在系统里取消互斥。若资源不被一个进程独占使用,那么死锁是肯定不会发生的。但一般来说在所列的四个条件中,“互斥”条件是无法破坏的。</p>
</li>
<li>
<p>破坏”占有并等待”条件</p>
<p>破坏”占有并等待”条件,就是在系统中不允许进程在已获得某种资源的情况下,申请其他资源。即要想出一个办法,阻止进程在持有资源的同时申请其他资源:</p>
<ol>
<li>一次申请所需的全部资源,即”一次性分配”。</li>
<li>要求每个进程提出新的资源申请前,释放它所占有的资源,即”先释放后申请”。</li>
</ol>
</li>
<li>
<p>破坏”不可抢占”条件</p>
<p>破坏”不可抢占”条件就是允许对资源实行抢夺:</p>
<ol>
<li>占有某些资源的同时再请求被拒绝,则该进程必须释放已占有的资源,如果有必要,可再次请求这些资源和另外的资源。</li>
<li>设置进程优先级,优先级高的可以抢占资源。</li>
</ol>
</li>
<li>
<p>破坏”循环等待”条件</p>
<p>将系统中的所有资源统一编号,所有进程必须按照资源编号顺序提出申请。</p>
</li>
</ul>
</li>
<li>
<p><strong>避免死锁</strong></p>
<p>在资源的动态分配过程中,用某种方法去防止系统进入不安全状态,从而避免死锁的产生。</p>
<ul>
<li>
<p>加锁顺序: 线程按照一定的顺序加锁。</p>
</li>
<li>
<p>加锁时限: 线程尝试获取锁的时候加上一定的时限,超过时限则放弃对该锁的请求,并释放自己占有的锁。</p>
</li>
<li>
<p>死锁检测: 每当一个线程获得了锁,会在线程和锁相关的数据结构中(map,graph等等)将其记下。除此之外,每当有线程请求锁,也需要记录在这个数据结构中。</p>
</li>
</ul>
</li>
<li>
<p><strong>检测死锁</strong></p>
<p>允许系统在运行过程中产生死锁,但可设置检测机构及时检测死锁的发生,并采取适当措施加以清除。</p>
<p>一般来说,由于操作系统有并发,共享以及随机性等特点,通过预防和避免的手段达到排除死锁的目的是很困难的。这需要较大的系统开销,而且不能充分利用资源。为此,一种简便的方法是系统为进程分配资源时,不采取任何限制性措施,但是提供了检测和解脱死锁的手段: 能发现死锁并从死锁状态中恢复出来。因此,在实际的操作系统中往往采用死锁的检测与恢复方法来排除死锁。</p>
</li>
<li>
<p><strong>解除死锁</strong></p>
<p>当检测出死锁后,便采取适当措施将进程从死锁状态中解脱出来。</p>
<ul>
<li>
<p>资源剥夺法</p>
<p>挂起某些死锁进程,并抢占它的资源,将这些资源分配给其他的死锁进程。但应防止被挂起的进程长时间得不到资源,而处于资源匮乏的状态。</p>
</li>
<li>
<p>撤销进程法</p>
<p>强制撤销部分,甚至全部死锁进程并剥夺这些进程的资源。撤销的原则可以按进程优先级和撤销进程代价的高低进行。</p>
</li>
<li>
<p>进程回退法</p>
<p>让一(多)个进程回退到足以回避死锁的地步,进程回退时自愿释放资源而不是被剥夺。要求系统保持进程的历史信息,设置还原点。</p>
</li>
</ul>
</li>
</ol>
<h2 id="aqs">AQS</h2>
<p>AQS 就是 AbstractQueuedSynchronized 抽象类,AQS 其实就是 JUC 并发包下的一个基类,JUC 下的很多内容都是基于 AQS 实现了部分功能,比如 ReentrantLock,ThreadPoolExecutor,阻塞队列,CountDownLacth,Semaphore,CyclicBarrier等等都是基于 AQS 实现的。</p>
<p>首先 AQS 中提供了一个由 volatile 修饰,并且采用 CAS 方式修改的 int 类型的 state 变量。</p>
<p>其次 AQS 中维护了一个双向链表,有 head,有 tail,并且每个节点都是 Node 对象。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> Node</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  static</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> Node SHARED </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Node</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">  static</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> Node EXCLUSIVE </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8"> CANCELLED </span><span style="color:#F97583">=</span><span style="color:#79B8FF">  1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8"> SIGEL     </span><span style="color:#F97583">=</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8"> CONDITION </span><span style="color:#F97583">=</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8"> PROPAGATE </span><span style="color:#F97583">=</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">  // 上述的状态都存储在 waitStatus</span></span>
<span class="line"><span style="color:#F97583">  volatile</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8"> waitStatus;</span></span>
<span class="line"><span style="color:#F97583">  volatile</span><span style="color:#E1E4E8"> Node prev;</span></span>
<span class="line"><span style="color:#F97583">  volatile</span><span style="color:#E1E4E8"> Node next;</span></span>
<span class="line"><span style="color:#F97583">  volatile</span><span style="color:#E1E4E8"> Thread thread;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h2 id="面试须知">面试须知</h2>
<h3 id="aqs-唤醒节点时为何从后往前找">AQS 唤醒节点时,为何从后往前找</h3>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> unparkSuccessor</span><span style="color:#E1E4E8">(Node node) {</span></span>
<span class="line"><span style="color:#6A737D">    /*</span></span>
<span class="line"><span style="color:#6A737D">     * If status is negative (i.e., possibly needing signal) try</span></span>
<span class="line"><span style="color:#6A737D">     * to clear in anticipation of signalling.  It is OK if this</span></span>
<span class="line"><span style="color:#6A737D">     * fails or if status is changed by waiting thread.</span></span>
<span class="line"><span style="color:#6A737D">     */</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> ws </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> node.waitStatus;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (ws </span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        node.</span><span style="color:#B392F0">compareAndSetWaitStatus</span><span style="color:#E1E4E8">(ws, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    /*</span></span>
<span class="line"><span style="color:#6A737D">     * Thread to unpark is held in successor, which is normally</span></span>
<span class="line"><span style="color:#6A737D">     * just the next node.  But if cancelled or apparently null,</span></span>
<span class="line"><span style="color:#6A737D">     * traverse backwards from tail to find the actual</span></span>
<span class="line"><span style="color:#6A737D">     * non-cancelled successor.</span></span>
<span class="line"><span style="color:#6A737D">     */</span></span>
<span class="line"><span style="color:#E1E4E8">    Node s </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> node.next;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (s </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> s.waitStatus </span><span style="color:#F97583">&gt;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        s </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> (Node p </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tail; p </span><span style="color:#F97583">!=</span><span style="color:#E1E4E8"> node </span><span style="color:#F97583">&amp;&amp;</span><span style="color:#E1E4E8"> p </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">; p </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p.prev)</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (p.waitStatus </span><span style="color:#F97583">&lt;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                s </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (s </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        LockSupport.</span><span style="color:#B392F0">unpark</span><span style="color:#E1E4E8">(s.thread);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>在阅读 AQS 源码的过程中,也许会存在这样的困惑,为什么当next指针对应的节点为null 或者取消时,从tail 向前遍历寻找最近的一个非取消的节点。</p>
<p>当前任释放时,需要获取继任者;AQS的实现方式是从tail 向前遍历,之所以这样是与入队时的逻辑有关。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Inserts node into queue, initializing if necessary. See picture above.</span></span>
<span class="line"><span style="color:#6A737D"> * </span><span style="color:#F97583">@param</span><span style="color:#FFAB70"> node</span><span style="color:#6A737D"> the node to insert</span></span>
<span class="line"><span style="color:#6A737D"> * </span><span style="color:#F97583">@return</span><span style="color:#6A737D"> node&#39;s predecessor</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">private</span><span style="color:#E1E4E8"> Node </span><span style="color:#B392F0">enq</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">final</span><span style="color:#E1E4E8"> Node node) {</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (;;) {</span></span>
<span class="line"><span style="color:#E1E4E8">        Node t </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tail;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (t </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) { </span><span style="color:#6A737D">// Must initialize</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">compareAndSetHead</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> Node</span><span style="color:#E1E4E8">()))</span></span>
<span class="line"><span style="color:#E1E4E8">                tail </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> head;</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            node.prev </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> t;</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">compareAndSetTail</span><span style="color:#E1E4E8">(t, node)) {</span></span>
<span class="line"><span style="color:#6A737D">            // 假设线程1执行到这里被挂起,此时 next 指针还没有关联到,后新来的线程 n 可能已经被排列到后面去了,所以当 t 被需要时,它的 next 指针还没有设置或者重置;故需要从后到前寻找,而如果找寻下一个,而这个可能被遗漏了;</span></span>
<span class="line"><span style="color:#6A737D">            // 故api文档中有这样一说 (Or, said differently, the next-links are an optimization so that we don&#39;t usually need a backward scan.)</span></span>
<span class="line"><span style="color:#E1E4E8">                t.next </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> node;</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#E1E4E8"> t;</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>源码内部类Node上的注释中有对这个场景的完整描述:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583"> final</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> isOnSyncQueue</span><span style="color:#E1E4E8">(Node node) {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (node.waitStatus </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> Node.CONDITION </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> node.prev </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (node.next </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) </span><span style="color:#6A737D">// If has successor, it must be on queue</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">    /*</span></span>
<span class="line"><span style="color:#6A737D">     * node.prev can be non-null, but not yet on queue because</span></span>
<span class="line"><span style="color:#6A737D">     * 节点的前置前置节点可能为非空,但是尚未在同步队列中,</span></span>
<span class="line"><span style="color:#6A737D">     * the CAS to place it on queue can fail. So we have to</span></span>
<span class="line"><span style="color:#6A737D">     * 因为cas 入队时可能失败。</span></span>
<span class="line"><span style="color:#6A737D">     * traverse from tail to make sure it actually made it.  It</span></span>
<span class="line"><span style="color:#6A737D">     * 所以我们不得不后序遍历以确保正确的发现它。</span></span>
<span class="line"><span style="color:#6A737D">     * will always be near the tail in calls to this method, and</span></span>
<span class="line"><span style="color:#6A737D">     * 它总是在靠近尾节点,当执行这个方法时</span></span>
<span class="line"><span style="color:#6A737D">     * unless the CAS failed (which is unlikely), it will be</span></span>
<span class="line"><span style="color:#6A737D">     * 除非cas 失败(这不太可能),所以我们不会遍历太多</span></span>
<span class="line"><span style="color:#6A737D">     * there, so we hardly evertraverse much.</span></span>
<span class="line"><span style="color:#6A737D">     */</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> findNodeFromTail</span><span style="color:#E1E4E8">(node);</span></span>
<span class="line"><span style="color:#E1E4E8"> }</span></span>
<span class="line"></span></code></pre> </div> 
<p>另一方面如果下一个节点时null(已经被GC ),如何找到下一个有效节点,也只能从后往前找了。</p>
<h3 id="concurrenthashmap在18做了什么优化">ConcurrentHashMap在1.8做了什么优化</h3>
<p>JDK1.8 放弃了锁分段的做法,采用CAS和synchronized方式处理并发。以put操作为例,CAS方式确定key的数组下标,synchronized保证链表节点的同步效果。</p>
<p>JDK1.8 ConcurrentHashMap是<strong>数组+链表</strong>,或者<strong>数组+红黑树</strong>结构,并发控制使用<strong>Synchronized关键字和CAS操作</strong>。</p>
<ol>
<li>
<p>存储结构的优化</p>
<p>数组+链表 -&gt; 数组+链表+红黑树</p>
</li>
<li>
<p>写数据加锁的优化</p>
</li>
<li>
<p>扩容的优化</p>
<p>协助扩容</p>
</li>
<li>
<p>计数器的优化</p>
<p>LongAddr -&gt; Cell[] 分段和汇总</p>
</li>
</ol>
<p>线程安全,但是复合操作时,只保证弱一致性/最终一致性。</p>
<h3 id="concurrenthashmap-的散列算法">ConcurrentHashMap 的散列算法</h3>
<p>当需要向 ConcurrentHashMap 中写入数据时,会根据 key 的 hashcode 来确定当前数据要放在数组的哪一个索引位置上。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Maps the specified key to the specified value in this table.</span></span>
<span class="line"><span style="color:#6A737D"> * Neither the key nor the value can be null.</span></span>
<span class="line"><span style="color:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D"> * &lt;p&gt;The value can be retrieved by calling the {@code get} method</span></span>
<span class="line"><span style="color:#6A737D"> * with a key that is equal to the original key.</span></span>
<span class="line"><span style="color:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D"> * </span><span style="color:#F97583">@param</span><span style="color:#FFAB70"> key</span><span style="color:#6A737D"> key with which the specified value is to be associated</span></span>
<span class="line"><span style="color:#6A737D"> * </span><span style="color:#F97583">@param</span><span style="color:#FFAB70"> value</span><span style="color:#6A737D"> value to be associated with the specified key</span></span>
<span class="line"><span style="color:#6A737D"> * </span><span style="color:#F97583">@return</span><span style="color:#6A737D"> the previous value associated with {@code key}, or</span></span>
<span class="line"><span style="color:#6A737D"> *         {@code null} if there was no mapping for {@code key}</span></span>
<span class="line"><span style="color:#6A737D"> * </span><span style="color:#F97583">@throws</span><span style="color:#B392F0"> NullPointerException</span><span style="color:#6A737D"> if the specified key or value is null</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> V </span><span style="color:#B392F0">put</span><span style="color:#E1E4E8">(K key, V value) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> putVal</span><span style="color:#E1E4E8">(key, value, </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/** Implementation for put and putIfAbsent */</span></span>
<span class="line"><span style="color:#F97583">final</span><span style="color:#E1E4E8"> V </span><span style="color:#B392F0">putVal</span><span style="color:#E1E4E8">(K key, V value, </span><span style="color:#F97583">boolean</span><span style="color:#E1E4E8"> onlyIfAbsent) {</span></span>
<span class="line"><span style="color:#6A737D">  // 不允许 key 或者 value 值为 null(HashMap 没有这个限制)</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (key </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> value </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> NullPointerException</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">  // 根据 key 的 hashcode 计算出一个哈希值,后面得出当前 key-value 要存储在那个数组索引位置</span></span>
<span class="line"><span style="color:#F97583">  int</span><span style="color:#E1E4E8"> hash </span><span style="color:#F97583">=</span><span style="color:#B392F0"> spread</span><span style="color:#E1E4E8">(key.</span><span style="color:#B392F0">hashCode</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">  int</span><span style="color:#E1E4E8"> binCount </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  ...</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>当向 map 中放数据时,用的是 put() 方法,这个方法在 ConcurrentHashMap 的源码实际上是调用了 putVal() 方法。</p>
<p>方法中先对 key 和 value 值进行判空,ConcurrentHashMap 是不允许 key 或者 value 值为 null 的,这也是和 HashMap 的一个区别,然后开始计算 key 的 hashcode,以获取后面得出当前 key-value 要存储在哪个数组索引位置,而在计算 key 的 hash 值时,调用了一个名为 spread 的方法。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Spreads (XORs) higher bits of hash to lower and also forces top</span></span>
<span class="line"><span style="color:#6A737D"> * bit to 0. Because the table uses power-of-two masking, sets of</span></span>
<span class="line"><span style="color:#6A737D"> * hashes that vary only in bits above the current mask will</span></span>
<span class="line"><span style="color:#6A737D"> * always collide. (Among known examples are sets of Float keys</span></span>
<span class="line"><span style="color:#6A737D"> * holding consecutive whole numbers in small tables.)  So we</span></span>
<span class="line"><span style="color:#6A737D"> * apply a transform that spreads the impact of higher bits</span></span>
<span class="line"><span style="color:#6A737D"> * downward. There is a tradeoff between speed, utility, and</span></span>
<span class="line"><span style="color:#6A737D"> * quality of bit-spreading. Because many common sets of hashes</span></span>
<span class="line"><span style="color:#6A737D"> * are already reasonably distributed (so don&#39;t benefit from</span></span>
<span class="line"><span style="color:#6A737D"> * spreading), and because we use trees to handle large sets of</span></span>
<span class="line"><span style="color:#6A737D"> * collisions in bins, we just XOR some shifted bits in the</span></span>
<span class="line"><span style="color:#6A737D"> * cheapest possible way to reduce systematic lossage, as well as</span></span>
<span class="line"><span style="color:#6A737D"> * to incorporate impact of the highest bits that would otherwise</span></span>
<span class="line"><span style="color:#6A737D"> * never be used in index calculations because of table bounds.</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#6A737D">// 将哈希值的高位传播(XOR)到低位,并将最高位强制为0。 因为表使用了2次方掩码,仅在当前掩码以上的位数不同的一组哈希值总是会发生碰撞。(已知的例子包括在小表中持有连续整数的Float键的集合)。因此,我们应用一个转换,将高位的影响向下分散。在速度,实用性和位传播的质量之间有一个权衡。因为许多常见的哈希集已经是合理分布的(所以不受益于传播),而且因为我们使用树来处理大集的碰撞,我们只是以最便宜的方式XOR一些移位的比特,以减少系统损失,以及纳入最高比特的影响,否则由于表的界限,永远不会被用于索引计算。</span></span>
<span class="line"><span style="color:#F97583">static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#B392F0"> spread</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> h) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> (h </span><span style="color:#F97583">^</span><span style="color:#E1E4E8"> (h </span><span style="color:#F97583">&gt;&gt;&gt;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">)) </span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8"> HASH_BITS;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>这个方法将 key 的 hashcode 的高低 16 位进行 ”^“(异或)运算,最终又与 HASH_BITS 进行 ”&amp;“(与)运算,此处巧妙的使用了一个转换,通过将 key 的 hashcode 右移 16 位,将其哈希值的高位向下传播到地位,并通过与 HASH_BITS 即0x7fffffff(Integer的最大值,最高位是0,其余都是1)进行的与运算将最高位强制为0。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/*</span></span>
<span class="line"><span style="color:#6A737D"> * Encodings for Node hash fields. See above for explanation.</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8"> MOVED     </span><span style="color:#F97583">=</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// 代表当前 hash 位置的数据正在扩容</span></span>
<span class="line"><span style="color:#F97583">static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8"> TREEBIN   </span><span style="color:#F97583">=</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// 代表当前 hash 位置下挂载的是一个红黑树</span></span>
<span class="line"><span style="color:#F97583">static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8"> RESERVED  </span><span style="color:#F97583">=</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// 预留当前索引位置</span></span>
<span class="line"><span style="color:#F97583">static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8"> HASH_BITS </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0x7fffffff</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// usable bits of normal node hash</span></span>
<span class="line"></span></code></pre> </div> 
<p>简单来讲就是之前用传统的方式计算 hashcode 时,由于数组长度没那么长,就导致只有低位参与计算,产生哈希冲突的概率较高,将高位与低位进行异或运算可以使得高位也参与到运算中,尽可能的减少哈希冲突,此外附属在哈希值中有特殊含义,因此采用了 spread() 方法中的方式避免生成负的哈希值。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/** Implementation for put and putIfAbsent */</span></span>
<span class="line"><span style="color:#F97583">final</span><span style="color:#E1E4E8"> V </span><span style="color:#B392F0">putVal</span><span style="color:#E1E4E8">(K key, V value, </span><span style="color:#F97583">boolean</span><span style="color:#E1E4E8"> onlyIfAbsent) {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (key </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> value </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> NullPointerException</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> hash </span><span style="color:#F97583">=</span><span style="color:#B392F0"> spread</span><span style="color:#E1E4E8">(key.</span><span style="color:#B392F0">hashCode</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> binCount </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;[] tab </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> table;;) {</span></span>
<span class="line"><span style="color:#6A737D">      // n: 数组长度</span></span>
<span class="line"><span style="color:#6A737D">      // i: 当前 Node 要存放的索引位置</span></span>
<span class="line"><span style="color:#6A737D">      // f: 当前数组 i 索引位置上的 Node 对象</span></span>
<span class="line"><span style="color:#6A737D">      // fn: 当前数组 i 索引位置上数据的哈希值</span></span>
<span class="line"><span style="color:#E1E4E8">      Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; f; </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> n, i, fh; K fk; V fv;</span></span>
<span class="line"><span style="color:#6A737D">      // 对是否进行过初始化的处理</span></span>
<span class="line"><span style="color:#6A737D">      // 判断数组是否进行过初始化 如果没有 调用 initTable() 进行初始化</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (tab </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tab.length) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">          tab </span><span style="color:#F97583">=</span><span style="color:#B392F0"> initTable</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">      // 已初始化 基于 i = (n - 1) &amp; hash 计算出当前 Node 需要存储在哪个索引位置</span></span>
<span class="line"><span style="color:#6A737D">      // 通过 tabAt() 方法获取哈希表 i 位置上的数据</span></span>
<span class="line"><span style="color:#6A737D">      // 如果该位置为空 -&gt; 该位置没有数据</span></span>
<span class="line"><span style="color:#6A737D">      // 基于 CAS 方法将数据放在 i 位置上 -&gt; 成功放置后结束循环</span></span>
<span class="line"><span style="color:#F97583">      else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> ((f </span><span style="color:#F97583">=</span><span style="color:#B392F0"> tabAt</span><span style="color:#E1E4E8">(tab, i </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8"> hash)) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">          if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">casTabAt</span><span style="color:#E1E4E8">(tab, i, </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;(hash, key, value)))</span></span>
<span class="line"><span style="color:#F97583">              break</span><span style="color:#E1E4E8">;                   </span><span style="color:#6A737D">// no lock when adding to empty bin</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#6A737D">      // 如果哈希表 i 位置不为空(无法直接放在数组上,产生了哈希冲突)</span></span>
<span class="line"><span style="color:#6A737D">      // 判断当前位置是否在扩容 (fh = f.hash) == MOVED</span></span>
<span class="line"><span style="color:#6A737D">      // 如果等于-1,则说明数组正在进行扩容,会调用 helpTransfer() 方法进行协助扩容</span></span>
<span class="line"><span style="color:#F97583">       else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> ((fh </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> f.hash) </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> MOVED)</span></span>
<span class="line"><span style="color:#E1E4E8">          tab </span><span style="color:#F97583">=</span><span style="color:#B392F0"> helpTransfer</span><span style="color:#E1E4E8">(tab, f);</span></span>
<span class="line"><span style="color:#6A737D">      // 在不获取锁定的情况下检查第一个节点</span></span>
<span class="line"><span style="color:#F97583">      else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (onlyIfAbsent </span><span style="color:#6A737D">// check first node without acquiring lock</span></span>
<span class="line"><span style="color:#F97583">                &amp;&amp;</span><span style="color:#E1E4E8"> fh </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> hash</span></span>
<span class="line"><span style="color:#F97583">                &amp;&amp;</span><span style="color:#E1E4E8"> ((fk </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> f.key) </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> key </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> (fk </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &amp;&amp;</span><span style="color:#E1E4E8"> key.</span><span style="color:#B392F0">equals</span><span style="color:#E1E4E8">(fk)))</span></span>
<span class="line"><span style="color:#F97583">                &amp;&amp;</span><span style="color:#E1E4E8"> (fv </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> f.val) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">          return</span><span style="color:#E1E4E8"> fv;</span></span>
<span class="line"><span style="color:#6A737D">      // 如果不等于-1,则说明未在扩容期间,而且此时此位置下挂的不是一个链表,而是一个红黑树,接下来就是将数据存放到红黑树中的相应位置。</span></span>
<span class="line"><span style="color:#F97583">      else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">          V oldVal </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">          // 针对首个节点进行加锁操作,而不是segment,进一步减少线程冲突</span></span>
<span class="line"><span style="color:#F97583">          synchronized</span><span style="color:#E1E4E8"> (f) {</span></span>
<span class="line"><span style="color:#F97583">              if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">tabAt</span><span style="color:#E1E4E8">(tab, i) </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> f) {</span></span>
<span class="line"><span style="color:#F97583">                  if</span><span style="color:#E1E4E8"> (fh </span><span style="color:#F97583">&gt;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">                      binCount </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">                      for</span><span style="color:#E1E4E8"> (Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; e </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> f;; </span><span style="color:#F97583">++</span><span style="color:#E1E4E8">binCount) {</span></span>
<span class="line"><span style="color:#E1E4E8">                          K ek;</span></span>
<span class="line"><span style="color:#6A737D">                          // 如果在链表中找到值为key的节点e,直接设置e.val =value即可。</span></span>
<span class="line"><span style="color:#F97583">                          if</span><span style="color:#E1E4E8"> (e.hash </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> hash </span><span style="color:#F97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8">                              ((ek </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e.key) </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> key </span><span style="color:#F97583">||</span></span>
<span class="line"><span style="color:#E1E4E8">                                (ek </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &amp;&amp;</span><span style="color:#E1E4E8"> key.</span><span style="color:#B392F0">equals</span><span style="color:#E1E4E8">(ek)))) {</span></span>
<span class="line"><span style="color:#E1E4E8">                              oldVal </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e.val;</span></span>
<span class="line"><span style="color:#F97583">                              if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">onlyIfAbsent)</span></span>
<span class="line"><span style="color:#E1E4E8">                                  e.val </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> value;</span></span>
<span class="line"><span style="color:#F97583">                              break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                          }</span></span>
<span class="line"><span style="color:#6A737D">                          // 如果没有找到值为key的节点,直接新建Node并加入链表即可。</span></span>
<span class="line"><span style="color:#E1E4E8">                          Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; pred </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e;</span></span>
<span class="line"><span style="color:#F97583">                          if</span><span style="color:#E1E4E8"> ((e </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e.next) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">                              pred.next </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;(hash, key, value);</span></span>
<span class="line"><span style="color:#F97583">                              break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                          }</span></span>
<span class="line"><span style="color:#E1E4E8">                      }</span></span>
<span class="line"><span style="color:#E1E4E8">                  }</span></span>
<span class="line"><span style="color:#6A737D">                  // 如果首节点为TreeBin类型,说明为红黑树结构,执行putTreeVal操作。</span></span>
<span class="line"><span style="color:#F97583">                  else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (f </span><span style="color:#F97583">instanceof</span><span style="color:#E1E4E8"> TreeBin) {</span></span>
<span class="line"><span style="color:#E1E4E8">                      Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; p;</span></span>
<span class="line"><span style="color:#E1E4E8">                      binCount </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">                      if</span><span style="color:#E1E4E8"> ((p </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ((TreeBin</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">K,V</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8">)f).</span><span style="color:#B392F0">putTreeVal</span><span style="color:#E1E4E8">(hash, key,</span></span>
<span class="line"><span style="color:#E1E4E8">                                                      value)) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">                          oldVal </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p.val;</span></span>
<span class="line"><span style="color:#F97583">                          if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">onlyIfAbsent)</span></span>
<span class="line"><span style="color:#E1E4E8">                              p.val </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> value;</span></span>
<span class="line"><span style="color:#E1E4E8">                      }</span></span>
<span class="line"><span style="color:#E1E4E8">                  }</span></span>
<span class="line"><span style="color:#F97583">                  else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (f </span><span style="color:#F97583">instanceof</span><span style="color:#E1E4E8"> ReservationNode)</span></span>
<span class="line"><span style="color:#F97583">                      throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> IllegalStateException</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Recursive update&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">              }</span></span>
<span class="line"><span style="color:#E1E4E8">          }</span></span>
<span class="line"><span style="color:#F97583">          if</span><span style="color:#E1E4E8"> (binCount </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">              // 如果节点数&gt;＝8,那么转换链表结构为红黑树结构。</span></span>
<span class="line"><span style="color:#F97583">              if</span><span style="color:#E1E4E8"> (binCount </span><span style="color:#F97583">&gt;=</span><span style="color:#E1E4E8"> TREEIFY_THRESHOLD)</span></span>
<span class="line"><span style="color:#B392F0">                  treeifyBin</span><span style="color:#E1E4E8">(tab, i);</span></span>
<span class="line"><span style="color:#F97583">              if</span><span style="color:#E1E4E8"> (oldVal </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">                  return</span><span style="color:#E1E4E8"> oldVal;</span></span>
<span class="line"><span style="color:#F97583">              break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">          }</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#6A737D">  // 计数增加1,有可能触发transfer操作(扩容)。</span></span>
<span class="line"><span style="color:#B392F0">  addCount</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1L</span><span style="color:#E1E4E8">, binCount);</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h3 id="为什么-concurrenthashmap-的数组长度需要时-2n">为什么 ConcurrentHashMap 的数组长度需要时 2^n</h3>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> ((f </span><span style="color:#F97583">=</span><span style="color:#B392F0"> tabAt</span><span style="color:#E1E4E8">(tab, i </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8"> hash)) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">casTabAt</span><span style="color:#E1E4E8">(tab, i, </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;(hash, key, value)))</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;                   </span><span style="color:#6A737D">// no lock when adding to empty bin</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>可以看到,在计算当前 Node 具体存放的索引位置时,使用了 n-1,n 代表数组长度,即这个索引位置是通过数组长度-1 与通过 spread() 方法返回的哈希值与运算计算出的,当数组长度为 2^n 时,可以最大程度的避免哈希冲突,因此有这个要求,就算给 ConcurrentHashMap 传入的大小不是 2^n,ConcurrentHashMap 也会计算出大于该数的最小 2^n,赋值给 n。</p>
<h3 id="concurrenthashmap-初始化流程">ConcurrentHashMap 初始化流程</h3>
<p>数组是懒加载的,第一次执行put()方法的时候才会进行初始化。</p>
<p>initTable()就是初始化方法,这里面有一个很重要的变量sizeCtl。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Initializes table, using the size recorded in sizeCtl.</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> final</span><span style="color:#E1E4E8"> Node</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">K,V</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8">[] </span><span style="color:#B392F0">initTable</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">  // 声明标识</span></span>
<span class="line"><span style="color:#E1E4E8">  Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;[] tab; </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> sc;</span></span>
<span class="line"><span style="color:#6A737D">  // 判断有没有初始化,并且完成 tab 的赋值</span></span>
<span class="line"><span style="color:#F97583">  while</span><span style="color:#E1E4E8"> ((tab </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> table) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> tab.length </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">    // 将 sizeCtl 赋值给 sc 变量,判断 sizeCtl 是否小于 0,即是否已经有线程在行始化了</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> ((sc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sizeCtl) </span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        Thread.</span><span style="color:#B392F0">yield</span><span style="color:#E1E4E8">(); </span><span style="color:#6A737D">// lost initialization race; just spin</span></span>
<span class="line"><span style="color:#6A737D">    // 可以尝试初始化数组,线程会以 CAS 的方式,将 sizeCtl 改为-1,代表当前线程以始化数组</span></span>
<span class="line"><span style="color:#F97583">    else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (U.</span><span style="color:#B392F0">compareAndSetInt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, SIZECTL, sc, </span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#6A737D">      // U.compareAndSetInt(this, SIZECTL, sc, -1) 以 CAS 的方式sizeCtrl的为-1</span></span>
<span class="line"><span style="color:#6A737D">      // 修改成功则开始初始化</span></span>
<span class="line"><span style="color:#F97583">      try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">        // DCL 再次判断当前数组是否已经初始化完成</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> ((tab </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> table) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> tab.length </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">          // 开始初始化</span></span>
<span class="line"><span style="color:#6A737D">          // sizeCtl &gt; 0 就初始化 sizeCtl 长度的数组</span></span>
<span class="line"><span style="color:#6A737D">          // sizeCtl = 0 就初始化默认长度的数组</span></span>
<span class="line"><span style="color:#F97583">          int</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (sc </span><span style="color:#F97583">&gt;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">?</span><span style="color:#E1E4E8"> sc </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> DEFAULT_CAPACITY;</span></span>
<span class="line"><span style="color:#E1E4E8">          @</span><span style="color:#F97583">SuppressWarnings</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;unchecked&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#6A737D">          // 真正初始化操作</span></span>
<span class="line"><span style="color:#E1E4E8">          Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;[] nt </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Node</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">K,V</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8">[])</span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> Node&lt;</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">&gt;[n];</span></span>
<span class="line"><span style="color:#E1E4E8">          table </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tab </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nt;</span></span>
<span class="line"><span style="color:#6A737D">          // 将 sc 赋值为下一次扩容的阈值</span></span>
<span class="line"><span style="color:#6A737D">          // 如果n=16 n&gt;&gt;&gt;2=4 16-4=12</span></span>
<span class="line"><span style="color:#6A737D">          // 其实就是在当前数组的基础上,增加当前数组长度的 0.75</span></span>
<span class="line"><span style="color:#E1E4E8">          sc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">&gt;&gt;&gt;</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">      } </span><span style="color:#F97583">finally</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">          sizeCtl </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sc;</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#F97583">      break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> tab;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>sizeCtl 是数组在初始化和扩容操作时一个控制变量,它的不同值代表不同含义</p>
<ul>
<li>‘&gt;0’: 代表当前数组已经初始化完成,此时 sizeCtl 的值代表当前数组的扩容阈值,或者数组的初始化大小</li>
<li>0: 代表当前数组还没初始化</li>
<li>-1: 代表当前数组正在初始化</li>
<li>&lt;-1: 低于 16 为代表当前数组正在扩容的线程个数
<ul>
<li>如果是 1 个线程,值就是-2</li>
<li>如果是 2 个线程,值就是-3</li>
</ul>
</li>
</ul>
<p>初始化大致流程:</p>
<p>基于一个while循环,先去判断数组初始化了没有,如果没有,会再次比较sizeCtl的情况,如果正在初始化,则会通过Thread.yield()让出CPU资源,如果没有初始化,则会通过CAS的方式修改sizeCtl的值为-1,修改过后还会再次判断数组是否被初始化了(DCL,以免在当前线程修改sizeCtl的值的时候,已经有别的线程对当前数组完成了初始化),如果当前数组仍然没有被初始化,才会真正开始初始化。</p>
<h3 id="concurrenthashmap-扩容流程">ConcurrentHashMap 扩容流程</h3>
<p>主要有三种方式会触发扩容</p>
<ol>
<li>
<p>执行 treeifyBin() 方法进行链表转红黑树前,会先尝试通过 tryPresize() 方法进行数组扩容。</p>
<p>当链表长度 &gt; 8 时,会尝试将链表转为红黑树。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Replaces all linked nodes in bin at given index unless table is</span></span>
<span class="line"><span style="color:#6A737D"> * too small, in which case resizes instead.</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#6A737D">// 在链表长度大于等于 8 时,尝试将链表转为红黑树</span></span>
<span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> final</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> treeifyBin</span><span style="color:#E1E4E8">(Node</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">K,V</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8">[] tab, </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> index) {</span></span>
<span class="line"><span style="color:#E1E4E8">   Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; b; </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> n;</span></span>
<span class="line"><span style="color:#6A737D">   // 数组不能为空</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (tab </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">     // 在真正进行链表 -&gt; 红黑树前,会先判断数组长度是否小于MIN_TREEIFY_CAPACITY</span></span>
<span class="line"><span style="color:#6A737D">     // MIN_TREEIFY_CAPACITY 即 64</span></span>
<span class="line"><span style="color:#F97583">     if</span><span style="color:#E1E4E8"> ((n </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tab.length) </span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8"> MIN_TREEIFY_CAPACITY)</span></span>
<span class="line"><span style="color:#6A737D">       // 如果数组长度小于 64,不能将链表转为红黑树,先尝试扩容操作</span></span>
<span class="line"><span style="color:#B392F0">       tryPresize</span><span style="color:#E1E4E8">(n </span><span style="color:#F97583">&lt;&lt;</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">     else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> ((b </span><span style="color:#F97583">=</span><span style="color:#B392F0"> tabAt</span><span style="color:#E1E4E8">(tab, index)) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &amp;&amp;</span><span style="color:#E1E4E8"> b.hash </span><span style="color:#F97583">&gt;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">         synchronized</span><span style="color:#E1E4E8"> (b) {</span></span>
<span class="line"><span style="color:#F97583">             if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">tabAt</span><span style="color:#E1E4E8">(tab, index) </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> b) {</span></span>
<span class="line"><span style="color:#E1E4E8">                 TreeNode&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; hd </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">, tl </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">                 for</span><span style="color:#E1E4E8"> (Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; e </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> b; e </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">; e </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e.next) {</span></span>
<span class="line"><span style="color:#E1E4E8">                     TreeNode&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; p </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#F97583">                         new</span><span style="color:#E1E4E8"> TreeNode&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;(e.hash, e.key, e.val,</span></span>
<span class="line"><span style="color:#79B8FF">                                           null</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">                     if</span><span style="color:#E1E4E8"> ((p.prev </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tl) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                         hd </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p;</span></span>
<span class="line"><span style="color:#F97583">                     else</span></span>
<span class="line"><span style="color:#E1E4E8">                         tl.next </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p;</span></span>
<span class="line"><span style="color:#E1E4E8">                     tl </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p;</span></span>
<span class="line"><span style="color:#E1E4E8">                 }</span></span>
<span class="line"><span style="color:#B392F0">                 setTabAt</span><span style="color:#E1E4E8">(tab, index, </span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> TreeBin&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;(hd));</span></span>
<span class="line"><span style="color:#E1E4E8">             }</span></span>
<span class="line"><span style="color:#E1E4E8">         }</span></span>
<span class="line"><span style="color:#E1E4E8">     }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
</li>
<li>
<p>执行 putAll() 方法时,会尝试通过 tryPreSize() 方法对数组进行扩容。</p>
<p>putAll() 方法会传入一个 Map,原先的数组很可能会不够用,因此触发扩容。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Copies all of the mappings from the specified map to this one.</span></span>
<span class="line"><span style="color:#6A737D"> * These mappings replace any mappings that this map had for any of the</span></span>
<span class="line"><span style="color:#6A737D"> * keys currently in the specified map.</span></span>
<span class="line"><span style="color:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D"> * </span><span style="color:#F97583">@param</span><span style="color:#FFAB70"> m</span><span style="color:#6A737D"> mappings to be stored in this map</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> putAll</span><span style="color:#E1E4E8">(Map</span><span style="color:#F97583">&lt;?</span><span style="color:#E1E4E8"> extends K, </span><span style="color:#F97583">?</span><span style="color:#E1E4E8"> extends V</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> m) {</span></span>
<span class="line"><span style="color:#B392F0">    tryPresize</span><span style="color:#E1E4E8">(m.</span><span style="color:#B392F0">size</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (Map.Entry&lt;</span><span style="color:#F97583">?</span><span style="color:#F97583"> extends</span><span style="color:#F97583"> K</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">?</span><span style="color:#F97583"> extends</span><span style="color:#F97583"> V</span><span style="color:#E1E4E8">&gt; e </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> m.</span><span style="color:#B392F0">entrySet</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#B392F0">        putVal</span><span style="color:#E1E4E8">(e.</span><span style="color:#B392F0">getKey</span><span style="color:#E1E4E8">(), e.</span><span style="color:#B392F0">getValue</span><span style="color:#E1E4E8">(), </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>向 tryPresize() 中传入需要添加的 Map 的 size。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Tries to presize table to accommodate the given number of elements.</span></span>
<span class="line"><span style="color:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D"> * </span><span style="color:#F97583">@param</span><span style="color:#FFAB70"> size</span><span style="color:#6A737D"> number of elements (doesn&#39;t need to be perfectly accurate)</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#6A737D">// size 是将之前的数组长度,左移一位得到的结果</span></span>
<span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> final</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> tryPresize</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> size) {</span></span>
<span class="line"><span style="color:#6A737D"> // 如果扩容的长度达到了最大值,就使用最大值</span></span>
<span class="line"><span style="color:#6A737D"> // 否则需要保证数组的长度的为 2 的 n 次幂</span></span>
<span class="line"><span style="color:#6A737D"> // 这块的操作是为了初始化操作准备的,因为调用 putAll 方法时,也会触发 tryPresize 方法</span></span>
<span class="line"><span style="color:#6A737D"> // 如果刚刚 new 的ConcurrentHashMap 直接调用了 putAll 方法的话,会通过 tryPresize方法进行初始化</span></span>
<span class="line"><span style="color:#F97583">   int</span><span style="color:#E1E4E8"> c </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (size </span><span style="color:#F97583">&gt;=</span><span style="color:#E1E4E8"> (MAXIMUM_CAPACITY </span><span style="color:#F97583">&gt;&gt;&gt;</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">)) </span><span style="color:#F97583">?</span><span style="color:#E1E4E8"> MAXIMUM_CAPACITY </span><span style="color:#F97583">:</span></span>
<span class="line"><span style="color:#B392F0">       tableSizeFor</span><span style="color:#E1E4E8">(size </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> (size </span><span style="color:#F97583">&gt;&gt;&gt;</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">   int</span><span style="color:#E1E4E8"> sc;</span></span>
<span class="line"><span style="color:#F97583">   while</span><span style="color:#E1E4E8"> ((sc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sizeCtl) </span><span style="color:#F97583">&gt;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">       Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;[] tab </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> table; </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> n;</span></span>
<span class="line"><span style="color:#6A737D">     // 类似初始化的操作</span></span>
<span class="line"><span style="color:#F97583">       if</span><span style="color:#E1E4E8"> (tab </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tab.length) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">           n </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (sc </span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> c) </span><span style="color:#F97583">?</span><span style="color:#E1E4E8"> sc </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> c;</span></span>
<span class="line"><span style="color:#F97583">           if</span><span style="color:#E1E4E8"> (U.</span><span style="color:#B392F0">compareAndSetInt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, SIZECTL, sc, </span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#F97583">               try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">                   if</span><span style="color:#E1E4E8"> (table </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> tab) {</span></span>
<span class="line"><span style="color:#E1E4E8">                       @</span><span style="color:#F97583">SuppressWarnings</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;unchecked&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                       Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;[] nt </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Node</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">K,V</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8">[])</span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> Node&lt;</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">&gt;[n];</span></span>
<span class="line"><span style="color:#E1E4E8">                       table </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nt;</span></span>
<span class="line"><span style="color:#E1E4E8">                       sc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">&gt;&gt;&gt;</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">                   }</span></span>
<span class="line"><span style="color:#E1E4E8">               } </span><span style="color:#F97583">finally</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                   sizeCtl </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sc;</span></span>
<span class="line"><span style="color:#E1E4E8">               }</span></span>
<span class="line"><span style="color:#E1E4E8">           }</span></span>
<span class="line"><span style="color:#E1E4E8">       }</span></span>
<span class="line"><span style="color:#6A737D">     // 越界处理</span></span>
<span class="line"><span style="color:#F97583">       else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (c </span><span style="color:#F97583">&lt;=</span><span style="color:#E1E4E8"> sc </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">&gt;=</span><span style="color:#E1E4E8"> MAXIMUM_CAPACITY)</span></span>
<span class="line"><span style="color:#F97583">           break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">     // transfer() 实现扩容操作</span></span>
<span class="line"><span style="color:#F97583">       else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (tab </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> table) {</span></span>
<span class="line"><span style="color:#6A737D">         // 计算扩容标识戳(用于协助扩容)</span></span>
<span class="line"><span style="color:#F97583">           int</span><span style="color:#E1E4E8"> rs </span><span style="color:#F97583">=</span><span style="color:#B392F0"> resizeStamp</span><span style="color:#E1E4E8">(n);</span></span>
<span class="line"><span style="color:#6A737D">         // 代表没有线程正在扩容,我是第一个扩容的</span></span>
<span class="line"><span style="color:#F97583">           if</span><span style="color:#E1E4E8"> (U.</span><span style="color:#B392F0">compareAndSetInt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, SIZECTL, sc,</span></span>
<span class="line"><span style="color:#E1E4E8">                                   (rs </span><span style="color:#F97583">&lt;&lt;</span><span style="color:#E1E4E8"> RESIZE_STAMP_SHIFT) </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#B392F0">               transfer</span><span style="color:#E1E4E8">(tab, </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">       }</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> final</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> transfer</span><span style="color:#E1E4E8">(Node</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">K,V</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8">[] tab, Node</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">K,V</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8">[] nextTab) {</span></span>
<span class="line"><span style="color:#6A737D"> // n = 数组长度</span></span>
<span class="line"><span style="color:#6A737D"> // stride = 每次线程一次性迁移多少数据到新数组</span></span>
<span class="line"><span style="color:#F97583">   int</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tab.length, stride;</span></span>
<span class="line"><span style="color:#6A737D"> // 基于 CPU 的内核数量来计算,每个线程一次性迁移多少长度的数据最合理</span></span>
<span class="line"><span style="color:#6A737D"> // NCPU = 4</span></span>
<span class="line"><span style="color:#6A737D"> // 数组长度为(1024-512-256-128)/ 4 = 32</span></span>
<span class="line"><span style="color:#6A737D"> // MIN_TRANSFER_STRIDE = 16,为每个线程迁移数据的最小长度</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> ((stride </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (NCPU </span><span style="color:#F97583">&gt;</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">?</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">&gt;&gt;&gt;</span><span style="color:#79B8FF"> 3</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">/</span><span style="color:#E1E4E8"> NCPU </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> n) </span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8"> MIN_TRANSFER_STRIDE)</span></span>
<span class="line"><span style="color:#E1E4E8">       stride </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> MIN_TRANSFER_STRIDE; </span><span style="color:#6A737D">// subdivide range</span></span>
<span class="line"><span style="color:#6A737D"> // 第一个进来扩容的线程需要把新数组构建出来</span></span>
<span class="line"><span style="color:#F97583">   if</span><span style="color:#E1E4E8"> (nextTab </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {            </span><span style="color:#6A737D">// initiating</span></span>
<span class="line"><span style="color:#F97583">       try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">           @</span><span style="color:#F97583">SuppressWarnings</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;unchecked&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#6A737D">         // 将原数组长度左移一位,构建新数组长度</span></span>
<span class="line"><span style="color:#E1E4E8">           Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;[] nt </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Node</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">K,V</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8">[])</span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> Node&lt;</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">&gt;[n </span><span style="color:#F97583">&lt;&lt;</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#6A737D">         // 赋值操作</span></span>
<span class="line"><span style="color:#E1E4E8">           nextTab </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nt;</span></span>
<span class="line"><span style="color:#E1E4E8">       } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (Throwable </span><span style="color:#FFAB70">ex</span><span style="color:#E1E4E8">) {      </span><span style="color:#6A737D">// try to cope with OOME</span></span>
<span class="line"><span style="color:#6A737D">         // 到这里,说明已经达到了数组长度的最大取值范围</span></span>
<span class="line"><span style="color:#E1E4E8">           sizeCtl </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Integer.MAX_VALUE;</span></span>
<span class="line"><span style="color:#6A737D">         // 设置 sizeCtl 后直接结束</span></span>
<span class="line"><span style="color:#F97583">           return</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">       }</span></span>
<span class="line"><span style="color:#6A737D">     // 将成员变量的新数组赋值</span></span>
<span class="line"><span style="color:#E1E4E8">       nextTable </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nextTab;</span></span>
<span class="line"><span style="color:#6A737D">     // 迁移数据时,用到的标识,默认为老数组长度</span></span>
<span class="line"><span style="color:#E1E4E8">       transferIndex </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> n;</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#6A737D"> // 新数组长度</span></span>
<span class="line"><span style="color:#F97583">   int</span><span style="color:#E1E4E8"> nextn </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nextTab.length;</span></span>
<span class="line"><span style="color:#6A737D"> // 在老数组迁移数据后,做的标识</span></span>
<span class="line"><span style="color:#E1E4E8">   ForwardingNode&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; fwd </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> ForwardingNode&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;(nextTab);</span></span>
<span class="line"><span style="color:#6A737D"> // 迁移数据时,需要用到的标识</span></span>
<span class="line"><span style="color:#6A737D"> // advance: true,代表当前线程需要接收任务,然后再执行迁移,如果为 false,代表已经接收完任务</span></span>
<span class="line"><span style="color:#F97583">   boolean</span><span style="color:#E1E4E8"> advance </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D"> // finishing: false,是否迁移结束</span></span>
<span class="line"><span style="color:#F97583">   boolean</span><span style="color:#E1E4E8"> finishing </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// to ensure sweep before committing nextTab</span></span>
<span class="line"><span style="color:#6A737D"> // 循环 i=15 代表当前线程迁移数据的索引值</span></span>
<span class="line"><span style="color:#6A737D"> // bound=0</span></span>
<span class="line"><span style="color:#F97583">   for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, bound </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;;) {</span></span>
<span class="line"><span style="color:#6A737D">     // f = null</span></span>
<span class="line"><span style="color:#6A737D">     // fh = 0</span></span>
<span class="line"><span style="color:#E1E4E8">       Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; f; </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> fh;</span></span>
<span class="line"><span style="color:#6A737D">     // 当前线程要接收任务</span></span>
<span class="line"><span style="color:#F97583">       while</span><span style="color:#E1E4E8"> (advance) {</span></span>
<span class="line"><span style="color:#6A737D">         // nextIndex = 16</span></span>
<span class="line"><span style="color:#6A737D">         // nextBound = 16</span></span>
<span class="line"><span style="color:#F97583">           int</span><span style="color:#E1E4E8"> nextIndex, nextBound;</span></span>
<span class="line"><span style="color:#6A737D">         // 第一次进来,这两个判断肯定进不去</span></span>
<span class="line"><span style="color:#6A737D">         // 对 i 进行--,并且判断当前任务是否处理完毕</span></span>
<span class="line"><span style="color:#F97583">           if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">--</span><span style="color:#E1E4E8">i </span><span style="color:#F97583">&gt;=</span><span style="color:#E1E4E8"> bound </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> finishing)</span></span>
<span class="line"><span style="color:#E1E4E8">               advance </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">         // 判断 transferIndex 是否小于等于 0,代表没有任务可领取,结束了</span></span>
<span class="line"><span style="color:#6A737D">         // 在线程领取任务后,会对 transferIndex 进行修改,修改为 transferIndex - stride</span></span>
<span class="line"><span style="color:#6A737D">         // 在任务都领取完之后,transferIndex 肯定是小于等于 0 的,代表没有迁移数据的任务可以领取</span></span>
<span class="line"><span style="color:#F97583">           else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> ((nextIndex </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> transferIndex) </span><span style="color:#F97583">&lt;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">               i </span><span style="color:#F97583">=</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">               advance </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">           }</span></span>
<span class="line"><span style="color:#F97583">           else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (U.compareAndSetInt</span></span>
<span class="line"><span style="color:#E1E4E8">                   (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, TRANSFERINDEX, nextIndex,</span></span>
<span class="line"><span style="color:#E1E4E8">                     nextBound </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (nextIndex </span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> stride </span><span style="color:#F97583">?</span></span>
<span class="line"><span style="color:#E1E4E8">                                 nextIndex </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> stride </span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">))) {</span></span>
<span class="line"><span style="color:#6A737D">             // 对 bound 赋值</span></span>
<span class="line"><span style="color:#E1E4E8">               bound </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nextBound;</span></span>
<span class="line"><span style="color:#6A737D">             // 对 i 赋值</span></span>
<span class="line"><span style="color:#E1E4E8">               i </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nextIndex </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">             // 设置 advance 为 false,代表当前线程领取到任务了</span></span>
<span class="line"><span style="color:#E1E4E8">               advance </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">           }</span></span>
<span class="line"><span style="color:#E1E4E8">       }</span></span>
<span class="line"><span style="color:#F97583">       if</span><span style="color:#E1E4E8"> (i </span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">&gt;=</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">&gt;=</span><span style="color:#E1E4E8"> nextn) {</span></span>
<span class="line"><span style="color:#F97583">           int</span><span style="color:#E1E4E8"> sc;</span></span>
<span class="line"><span style="color:#6A737D">         // finishing 为 true 代表扩容结束</span></span>
<span class="line"><span style="color:#F97583">           if</span><span style="color:#E1E4E8"> (finishing) {</span></span>
<span class="line"><span style="color:#6A737D">             // 将 nextTable 新数组设置为 null</span></span>
<span class="line"><span style="color:#E1E4E8">               nextTable </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">             // 将当前数组的引用指向新数组</span></span>
<span class="line"><span style="color:#E1E4E8">               table </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nextTab;</span></span>
<span class="line"><span style="color:#6A737D">             // 重新计算扩容阈值 64-16=48</span></span>
<span class="line"><span style="color:#E1E4E8">               sizeCtl </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">&lt;&lt;</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">&gt;&gt;&gt;</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">               return</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">           }</span></span>
<span class="line"><span style="color:#6A737D">         // 当前线程没有接收到任务,让当前线程结束扩容操作</span></span>
<span class="line"><span style="color:#6A737D">         // 采用 CAS 的方式,将 sizeCtl - 1,代表当前并发扩容的线程数 - 1</span></span>
<span class="line"><span style="color:#F97583">           if</span><span style="color:#E1E4E8"> (U.</span><span style="color:#B392F0">compareAndSetInt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, SIZECTL, sc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sizeCtl, sc </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#6A737D">             // sizeCtl 的高 16 位是基于数组长度计算的扩容戳,低 16 位是当前正在扩容的线程数</span></span>
<span class="line"><span style="color:#F97583">               if</span><span style="color:#E1E4E8"> ((sc </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">!=</span><span style="color:#B392F0"> resizeStamp</span><span style="color:#E1E4E8">(n) </span><span style="color:#F97583">&lt;&lt;</span><span style="color:#E1E4E8"> RESIZE_STAMP_SHIFT)</span></span>
<span class="line"><span style="color:#6A737D">                 // 代表当前线程并不是最后一个退出扩容的线程,直接结束当前线程扩容</span></span>
<span class="line"><span style="color:#F97583">                   return</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">             // 如果是最后一个退出扩容的线程,将 finishing和advance 设置位 true</span></span>
<span class="line"><span style="color:#E1E4E8">               finishing </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> advance </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">             // 将 i 设置为老数组长度,让最后一个线程再从尾到头再检查一下,是否数据全部迁移完毕</span></span>
<span class="line"><span style="color:#E1E4E8">               i </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> n; </span><span style="color:#6A737D">// recheck before commit</span></span>
<span class="line"><span style="color:#E1E4E8">           }</span></span>
<span class="line"><span style="color:#E1E4E8">       }</span></span>
<span class="line"><span style="color:#F97583">       else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> ((f </span><span style="color:#F97583">=</span><span style="color:#B392F0"> tabAt</span><span style="color:#E1E4E8">(tab, i)) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">           advance </span><span style="color:#F97583">=</span><span style="color:#B392F0"> casTabAt</span><span style="color:#E1E4E8">(tab, i, </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">, fwd);</span></span>
<span class="line"><span style="color:#F97583">       else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> ((fh </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> f.hash) </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> MOVED)</span></span>
<span class="line"><span style="color:#E1E4E8">           advance </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// already processed</span></span>
<span class="line"><span style="color:#F97583">       else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">           synchronized</span><span style="color:#E1E4E8"> (f) {</span></span>
<span class="line"><span style="color:#F97583">               if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">tabAt</span><span style="color:#E1E4E8">(tab, i) </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> f) {</span></span>
<span class="line"><span style="color:#E1E4E8">                   Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; ln, hn;</span></span>
<span class="line"><span style="color:#F97583">                   if</span><span style="color:#E1E4E8"> (fh </span><span style="color:#F97583">&gt;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">                       int</span><span style="color:#E1E4E8"> runBit </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> fh </span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8"> n;</span></span>
<span class="line"><span style="color:#E1E4E8">                       Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; lastRun </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> f;</span></span>
<span class="line"><span style="color:#F97583">                       for</span><span style="color:#E1E4E8"> (Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; p </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> f.next; p </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">; p </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p.next) {</span></span>
<span class="line"><span style="color:#F97583">                           int</span><span style="color:#E1E4E8"> b </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p.hash </span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8"> n;</span></span>
<span class="line"><span style="color:#F97583">                           if</span><span style="color:#E1E4E8"> (b </span><span style="color:#F97583">!=</span><span style="color:#E1E4E8"> runBit) {</span></span>
<span class="line"><span style="color:#E1E4E8">                               runBit </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> b;</span></span>
<span class="line"><span style="color:#E1E4E8">                               lastRun </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p;</span></span>
<span class="line"><span style="color:#E1E4E8">                           }</span></span>
<span class="line"><span style="color:#E1E4E8">                       }</span></span>
<span class="line"><span style="color:#F97583">                       if</span><span style="color:#E1E4E8"> (runBit </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">                           ln </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lastRun;</span></span>
<span class="line"><span style="color:#E1E4E8">                           hn </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                       }</span></span>
<span class="line"><span style="color:#F97583">                       else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                           hn </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> lastRun;</span></span>
<span class="line"><span style="color:#E1E4E8">                           ln </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                       }</span></span>
<span class="line"><span style="color:#F97583">                       for</span><span style="color:#E1E4E8"> (Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; p </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> f; p </span><span style="color:#F97583">!=</span><span style="color:#E1E4E8"> lastRun; p </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p.next) {</span></span>
<span class="line"><span style="color:#F97583">                           int</span><span style="color:#E1E4E8"> ph </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p.hash; K pk </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p.key; V pv </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p.val;</span></span>
<span class="line"><span style="color:#F97583">                           if</span><span style="color:#E1E4E8"> ((ph </span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8"> n) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                               ln </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;(ph, pk, pv, ln);</span></span>
<span class="line"><span style="color:#F97583">                           else</span></span>
<span class="line"><span style="color:#E1E4E8">                               hn </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;(ph, pk, pv, hn);</span></span>
<span class="line"><span style="color:#E1E4E8">                       }</span></span>
<span class="line"><span style="color:#B392F0">                       setTabAt</span><span style="color:#E1E4E8">(nextTab, i, ln);</span></span>
<span class="line"><span style="color:#B392F0">                       setTabAt</span><span style="color:#E1E4E8">(nextTab, i </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> n, hn);</span></span>
<span class="line"><span style="color:#B392F0">                       setTabAt</span><span style="color:#E1E4E8">(tab, i, fwd);</span></span>
<span class="line"><span style="color:#E1E4E8">                       advance </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                   }</span></span>
<span class="line"><span style="color:#F97583">                   else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (f </span><span style="color:#F97583">instanceof</span><span style="color:#E1E4E8"> TreeBin) {</span></span>
<span class="line"><span style="color:#E1E4E8">                       TreeBin&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; t </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (TreeBin</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">K,V</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8">)f;</span></span>
<span class="line"><span style="color:#E1E4E8">                       TreeNode&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; lo </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">, loTail </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                       TreeNode&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; hi </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">, hiTail </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">                       int</span><span style="color:#E1E4E8"> lc </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, hc </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">                       for</span><span style="color:#E1E4E8"> (Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; e </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> t.first; e </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">; e </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e.next) {</span></span>
<span class="line"><span style="color:#F97583">                           int</span><span style="color:#E1E4E8"> h </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e.hash;</span></span>
<span class="line"><span style="color:#E1E4E8">                           TreeNode&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; p </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> TreeNode&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">                               (h, e.key, e.val, </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">                           if</span><span style="color:#E1E4E8"> ((h </span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8"> n) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">                               if</span><span style="color:#E1E4E8"> ((p.prev </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> loTail) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                                   lo </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p;</span></span>
<span class="line"><span style="color:#F97583">                               else</span></span>
<span class="line"><span style="color:#E1E4E8">                                   loTail.next </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p;</span></span>
<span class="line"><span style="color:#E1E4E8">                               loTail </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p;</span></span>
<span class="line"><span style="color:#F97583">                               ++</span><span style="color:#E1E4E8">lc;</span></span>
<span class="line"><span style="color:#E1E4E8">                           }</span></span>
<span class="line"><span style="color:#F97583">                           else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">                               if</span><span style="color:#E1E4E8"> ((p.prev </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> hiTail) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                                   hi </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p;</span></span>
<span class="line"><span style="color:#F97583">                               else</span></span>
<span class="line"><span style="color:#E1E4E8">                                   hiTail.next </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p;</span></span>
<span class="line"><span style="color:#E1E4E8">                               hiTail </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> p;</span></span>
<span class="line"><span style="color:#F97583">                               ++</span><span style="color:#E1E4E8">hc;</span></span>
<span class="line"><span style="color:#E1E4E8">                           }</span></span>
<span class="line"><span style="color:#E1E4E8">                       }</span></span>
<span class="line"><span style="color:#E1E4E8">                       ln </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (lc </span><span style="color:#F97583">&lt;=</span><span style="color:#E1E4E8"> UNTREEIFY_THRESHOLD) </span><span style="color:#F97583">?</span><span style="color:#B392F0"> untreeify</span><span style="color:#E1E4E8">(lo) </span><span style="color:#F97583">:</span></span>
<span class="line"><span style="color:#E1E4E8">                           (hc </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">?</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> TreeBin&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;(lo) </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> t;</span></span>
<span class="line"><span style="color:#E1E4E8">                       hn </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (hc </span><span style="color:#F97583">&lt;=</span><span style="color:#E1E4E8"> UNTREEIFY_THRESHOLD) </span><span style="color:#F97583">?</span><span style="color:#B392F0"> untreeify</span><span style="color:#E1E4E8">(hi) </span><span style="color:#F97583">:</span></span>
<span class="line"><span style="color:#E1E4E8">                           (lc </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">?</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> TreeBin&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;(hi) </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> t;</span></span>
<span class="line"><span style="color:#B392F0">                       setTabAt</span><span style="color:#E1E4E8">(nextTab, i, ln);</span></span>
<span class="line"><span style="color:#B392F0">                       setTabAt</span><span style="color:#E1E4E8">(nextTab, i </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> n, hn);</span></span>
<span class="line"><span style="color:#B392F0">                       setTabAt</span><span style="color:#E1E4E8">(tab, i, fwd);</span></span>
<span class="line"><span style="color:#E1E4E8">                       advance </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                   }</span></span>
<span class="line"><span style="color:#E1E4E8">               }</span></span>
<span class="line"><span style="color:#E1E4E8">           }</span></span>
<span class="line"><span style="color:#E1E4E8">       }</span></span>
<span class="line"><span style="color:#E1E4E8">   }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>首先要确定扩容的大小</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * The largest possible table capacity.  This value must be</span></span>
<span class="line"><span style="color:#6A737D"> * exactly 1&lt;&lt;30 to stay within Java array allocation and indexing</span></span>
<span class="line"><span style="color:#6A737D"> * bounds for power of two table sizes, and is further required</span></span>
<span class="line"><span style="color:#6A737D"> * because the top two bits of 32bit hash fields are used for</span></span>
<span class="line"><span style="color:#6A737D"> * control purposes.</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#E1E4E8"> MAXIMUM_CAPACITY </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> &lt;&lt;</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span></code></pre> </div> 
<p>大于最大值就取最大值(MAXIMUM_CAPACITY),不是 2^n 就计算大于它且离他最近的 2^n。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Returns a power of two table size for the given desired capacity.</span></span>
<span class="line"><span style="color:#6A737D"> * See Hackers Delight, sec 3.2</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> static</span><span style="color:#F97583"> final</span><span style="color:#F97583"> int</span><span style="color:#B392F0"> tableSizeFor</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> c) {</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">=</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#F97583"> &gt;&gt;&gt;</span><span style="color:#E1E4E8"> Integer.</span><span style="color:#B392F0">numberOfLeadingZeros</span><span style="color:#E1E4E8">(c </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">?</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> :</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">&gt;=</span><span style="color:#E1E4E8"> MAXIMUM_CAPACITY) </span><span style="color:#F97583">?</span><span style="color:#E1E4E8"> MAXIMUM_CAPACITY </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> static</span><span style="color:#F97583"> int</span><span style="color:#B392F0"> numberOfLeadingZeros</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> i) {</span></span>
<span class="line"><span style="color:#6A737D">    // HD, Count leading 0&#39;s</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (i </span><span style="color:#F97583">&lt;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> ?</span><span style="color:#79B8FF"> 32</span><span style="color:#F97583"> :</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 31</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (i </span><span style="color:#F97583">&gt;=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> &lt;&lt;</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">) { n </span><span style="color:#F97583">-=</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&gt;&gt;&gt;=</span><span style="color:#79B8FF"> 16</span><span style="color:#E1E4E8">; }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (i </span><span style="color:#F97583">&gt;=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> &lt;&lt;</span><span style="color:#79B8FF">  8</span><span style="color:#E1E4E8">) { n </span><span style="color:#F97583">-=</span><span style="color:#79B8FF">  8</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&gt;&gt;&gt;=</span><span style="color:#79B8FF">  8</span><span style="color:#E1E4E8">; }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (i </span><span style="color:#F97583">&gt;=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> &lt;&lt;</span><span style="color:#79B8FF">  4</span><span style="color:#E1E4E8">) { n </span><span style="color:#F97583">-=</span><span style="color:#79B8FF">  4</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&gt;&gt;&gt;=</span><span style="color:#79B8FF">  4</span><span style="color:#E1E4E8">; }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (i </span><span style="color:#F97583">&gt;=</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> &lt;&lt;</span><span style="color:#79B8FF">  2</span><span style="color:#E1E4E8">) { n </span><span style="color:#F97583">-=</span><span style="color:#79B8FF">  2</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&gt;&gt;&gt;=</span><span style="color:#79B8FF">  2</span><span style="color:#E1E4E8">; }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> (i </span><span style="color:#F97583">&gt;&gt;&gt;</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>接着就进入了 while 循环,</p>
</li>
<li>
<p>执行 addCount() 操作时,如果当前元素个数达到了扩容阈值,也会进行扩容。</p>
</li>
</ol>
<h3 id="concurrenthashmap-读取数据流程">ConcurrentHashMap 读取数据流程</h3>
<p>ConcurrentHashMap 的数据查询都是以 get() 方法为入口的。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Returns the value to which the specified key is mapped,</span></span>
<span class="line"><span style="color:#6A737D"> * or {@code null} if this map contains no mapping for the key.</span></span>
<span class="line"><span style="color:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D"> * &lt;p&gt;More formally, if this map contains a mapping from a key</span></span>
<span class="line"><span style="color:#6A737D"> * {@code k} to a value {@code v} such that {@code key.equals(k)},</span></span>
<span class="line"><span style="color:#6A737D"> * then this method returns {@code v}; otherwise it returns</span></span>
<span class="line"><span style="color:#6A737D"> * {@code null}.  (There can be at most one such mapping.)</span></span>
<span class="line"><span style="color:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D"> * </span><span style="color:#F97583">@throws</span><span style="color:#B392F0"> NullPointerException</span><span style="color:#6A737D"> if the specified key is null</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> V </span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(Object key) {</span></span>
<span class="line"><span style="color:#6A737D">  // tab: 数组,e: 查询指定位置的节点 n: 数组长度</span></span>
<span class="line"><span style="color:#E1E4E8">  Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;[] tab; Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt; e, p; </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> n, eh; K ek;</span></span>
<span class="line"><span style="color:#6A737D">  // 基于传入的 key,计算 hash 值</span></span>
<span class="line"><span style="color:#F97583">  int</span><span style="color:#E1E4E8"> h </span><span style="color:#F97583">=</span><span style="color:#B392F0"> spread</span><span style="color:#E1E4E8">(key.</span><span style="color:#B392F0">hashCode</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#6A737D">  // 数组不为 null,数组上得有数据</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> ((tab </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> table) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &amp;&amp;</span><span style="color:#E1E4E8"> (n </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tab.length) </span><span style="color:#F97583">&gt;</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> &amp;&amp;</span></span>
<span class="line"><span style="color:#6A737D">      // 查询对应数组的位置上的数据</span></span>
<span class="line"><span style="color:#E1E4E8">      (e </span><span style="color:#F97583">=</span><span style="color:#B392F0"> tabAt</span><span style="color:#E1E4E8">(tab, (n </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8"> h)) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">      // hash 值一致+key 一致 返回 value</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> ((eh </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e.hash) </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> h) {</span></span>
<span class="line"><span style="color:#6A737D">          // key 的==或者 equals 是否一致,如果一致,数组上就是要查询的数据</span></span>
<span class="line"><span style="color:#F97583">          if</span><span style="color:#E1E4E8"> ((ek </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e.key) </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> key </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> (ek </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &amp;&amp;</span><span style="color:#E1E4E8"> key.</span><span style="color:#B392F0">equals</span><span style="color:#E1E4E8">(ek)))</span></span>
<span class="line"><span style="color:#F97583">              return</span><span style="color:#E1E4E8"> e.val;</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#6A737D">      // hash 值&lt;0 (特殊情况,会通过 find() 方法进行 value 的获取)</span></span>
<span class="line"><span style="color:#F97583">      else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (eh </span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#6A737D">          // 三种情况: 数组迁移走了,节点位置被占,红黑树</span></span>
<span class="line"><span style="color:#6A737D">          // 如果当前数据已经迁移到新数组 ,调用 ForwardingNode 中的 find()</span></span>
<span class="line"><span style="color:#F97583">          return</span><span style="color:#E1E4E8"> (p </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e.</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(h, key)) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ?</span><span style="color:#E1E4E8"> p.val </span><span style="color:#F97583">:</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">      // 走链表操作</span></span>
<span class="line"><span style="color:#F97583">      while</span><span style="color:#E1E4E8"> ((e </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e.next) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">          // 如果 hash 值一致,并且 key 的==或者 equals 一致,返回当前链表位置的数据</span></span>
<span class="line"><span style="color:#F97583">          if</span><span style="color:#E1E4E8"> (e.hash </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> h </span><span style="color:#F97583">&amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8">              ((ek </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> e.key) </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> key </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> (ek </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &amp;&amp;</span><span style="color:#E1E4E8"> key.</span><span style="color:#B392F0">equals</span><span style="color:#E1E4E8">(ek))))</span></span>
<span class="line"><span style="color:#F97583">              return</span><span style="color:#E1E4E8"> e.val;</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#6A737D">  // 如果上述三个流程都没有知道指定 key 对应的 value,那就是 key 不存在,返回 null 即可</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h3 id="concurrenthashmap-计数器的实现">ConcurrentHashMap 计数器的实现</h3>
<p>计数器是用来统计 ConcurrentHashMap 的元素个数的,通过 addCount() 方法是吸纳,可以看到 addCount() 方法中有两个重要的对象: CounterCell[] 数组和 baseCount 变量。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * Adds to count, and if table is too small and not already</span></span>
<span class="line"><span style="color:#6A737D"> * resizing, initiates transfer. If already resizing, helps</span></span>
<span class="line"><span style="color:#6A737D"> * perform transfer if work is available.  Rechecks occupancy</span></span>
<span class="line"><span style="color:#6A737D"> * after a transfer to see if another resize is already needed</span></span>
<span class="line"><span style="color:#6A737D"> * because resizings are lagging additions.</span></span>
<span class="line"><span style="color:#6A737D"> *</span></span>
<span class="line"><span style="color:#6A737D"> * </span><span style="color:#F97583">@param</span><span style="color:#FFAB70"> x</span><span style="color:#6A737D"> the count to add</span></span>
<span class="line"><span style="color:#6A737D"> * </span><span style="color:#F97583">@param</span><span style="color:#FFAB70"> check</span><span style="color:#6A737D"> if &lt;0, don&#39;t check resize, if &lt;= 1 only check if uncontended</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> final</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> addCount</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">long</span><span style="color:#E1E4E8"> x, </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> check) {</span></span>
<span class="line"><span style="color:#6A737D">  // b: 原来的 baseCount</span></span>
<span class="line"><span style="color:#6A737D">  // s: 是自增后的元素个数</span></span>
<span class="line"><span style="color:#F97583">  CounterCell</span><span style="color:#E1E4E8">[] cs; </span><span style="color:#F97583">long</span><span style="color:#E1E4E8"> b, s;</span></span>
<span class="line"><span style="color:#6A737D">  // 判断 CounterCell 不为 null,代表之前有冲突问题,有冲突直接进入 if 中</span></span>
<span class="line"><span style="color:#6A737D">  // 如果 CounterCell[] 为 null,直接执行 || 后面的 CAS 操作,直接修改 baseCount</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> ((cs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> counterCells) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span></span>
<span class="line"><span style="color:#6A737D">      // 如果对 baseCount++ 成功,直接告辞,如果 CAS 失败,直接进入 if 中</span></span>
<span class="line"><span style="color:#F97583">      !</span><span style="color:#E1E4E8">U.</span><span style="color:#B392F0">compareAndSetLong</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, BASECOUNT, b </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> baseCount, s </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> b </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> x)) {</span></span>
<span class="line"><span style="color:#6A737D">      // 进入这里,说明有并发问题</span></span>
<span class="line"><span style="color:#6A737D">      // 进入的方式有两种:</span></span>
<span class="line"><span style="color:#6A737D">      // 1.CounterCell[] 有值</span></span>
<span class="line"><span style="color:#6A737D">      // 2.CounterCell[] 无值,但是 CAS 失败</span></span>
<span class="line"><span style="color:#6A737D">      // m: 数组长度 - 1</span></span>
<span class="line"><span style="color:#6A737D">      // c: 当前线程基于随机数,获得到的数组上的某一个 CounterCell</span></span>
<span class="line"><span style="color:#E1E4E8">      CounterCell c; </span><span style="color:#F97583">long</span><span style="color:#E1E4E8"> v; </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> m;</span></span>
<span class="line"><span style="color:#6A737D">      // 是否有冲突,默认为 true,代表没有冲突</span></span>
<span class="line"><span style="color:#F97583">      boolean</span><span style="color:#E1E4E8"> uncontended </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">      // 判断 CounterCell[] 没有初始化,执行 fullAddCount 方法执行初始化</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (cs </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> (m </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cs.length </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> ||</span></span>
<span class="line"><span style="color:#6A737D">          // CounterCell[] 已经初始化,基于随机数拿到数组上的一个 CounterCell,如果为 null 执行 fullAddCount</span></span>
<span class="line"><span style="color:#E1E4E8">          (c </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cs[ThreadLocalRandom.</span><span style="color:#B392F0">getProbe</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">&amp;</span><span style="color:#E1E4E8"> m]) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span></span>
<span class="line"><span style="color:#6A737D">          // CounterCell[] 已经初始化,并且指定索引位置上有 CounterCell</span></span>
<span class="line"><span style="color:#6A737D">          // 直接 CAS 修改指定的 CounterCell 上的 value 即可</span></span>
<span class="line"><span style="color:#6A737D">          // CAS 成功,直接告辞</span></span>
<span class="line"><span style="color:#6A737D">          // CAS 失败,代表有冲突,uncontended = false,执行 fullAddCount 方法</span></span>
<span class="line"><span style="color:#F97583">          !</span><span style="color:#E1E4E8">(uncontended </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#E1E4E8">            U.</span><span style="color:#B392F0">compareAndSetLong</span><span style="color:#E1E4E8">(c, CELLVALUE, v </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> c.value, v </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> x))) {</span></span>
<span class="line"><span style="color:#B392F0">          fullAddCount</span><span style="color:#E1E4E8">(x, uncontended);</span></span>
<span class="line"><span style="color:#F97583">          return</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#6A737D">      // 如果链表长度小于等于 1,不去判断扩容</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (check </span><span style="color:#F97583">&lt;=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">          return</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">      // 将所有 CounterCell 中记录的数累加,得到最终的元素个数</span></span>
<span class="line"><span style="color:#E1E4E8">      s </span><span style="color:#F97583">=</span><span style="color:#B392F0"> sumCount</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#6A737D">  // 判断 check 大于等于 0,remove 的操作就是小于 0的,因为添加时,才需要判断是否需要扩容</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (check </span><span style="color:#F97583">&gt;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">      Node&lt;</span><span style="color:#F97583">K</span><span style="color:#E1E4E8">,</span><span style="color:#F97583">V</span><span style="color:#E1E4E8">&gt;[] tab, nt; </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> n, sc;</span></span>
<span class="line"><span style="color:#6A737D">      // 当前元素个数是否大于扩容阈值,并且数组不为 null,数组长度没有达到最大值</span></span>
<span class="line"><span style="color:#F97583">      while</span><span style="color:#E1E4E8"> (s </span><span style="color:#F97583">&gt;=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">long</span><span style="color:#E1E4E8">)(sc </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> sizeCtl) </span><span style="color:#F97583">&amp;&amp;</span><span style="color:#E1E4E8"> (tab </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> table) </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &amp;&amp;</span></span>
<span class="line"><span style="color:#E1E4E8">              (n </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> tab.length) </span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8"> MAXIMUM_CAPACITY) {</span></span>
<span class="line"><span style="color:#6A737D">          // 扩容表示戳</span></span>
<span class="line"><span style="color:#F97583">          int</span><span style="color:#E1E4E8"> rs </span><span style="color:#F97583">=</span><span style="color:#B392F0"> resizeStamp</span><span style="color:#E1E4E8">(n) </span><span style="color:#F97583">&lt;&lt;</span><span style="color:#E1E4E8"> RESIZE_STAMP_SHIFT;</span></span>
<span class="line"><span style="color:#F97583">          if</span><span style="color:#E1E4E8"> (sc </span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">              // 判断是否可以协助扩容</span></span>
<span class="line"><span style="color:#F97583">              if</span><span style="color:#E1E4E8"> (sc </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> rs </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> MAX_RESIZERS </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> sc </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> rs </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> ||</span></span>
<span class="line"><span style="color:#E1E4E8">                  (nt </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nextTable) </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> transferIndex </span><span style="color:#F97583">&lt;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">                  break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">              // 协助扩容</span></span>
<span class="line"><span style="color:#F97583">              if</span><span style="color:#E1E4E8"> (U.</span><span style="color:#B392F0">compareAndSetInt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, SIZECTL, sc, sc </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#B392F0">                  transfer</span><span style="color:#E1E4E8">(tab, nt);</span></span>
<span class="line"><span style="color:#E1E4E8">          }</span></span>
<span class="line"><span style="color:#6A737D">          // 没有线程执行扩容,我来执行扩容</span></span>
<span class="line"><span style="color:#F97583">          else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (U.</span><span style="color:#B392F0">compareAndSetInt</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, SIZECTL, sc, rs </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#B392F0">              transfer</span><span style="color:#E1E4E8">(tab, </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">          s </span><span style="color:#F97583">=</span><span style="color:#B392F0"> sumCount</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>他们是记录数据的两个位置:</p>
<ul>
<li>并发量不高时,会通过 baseCount 进行追加</li>
<li>并发量较高时,CAS 试图操作 baseCount 失败后,会切换到 CounterCell[] 数组来计数,有多个 CounterCell 可供不同的线程进行选择。</li>
</ul>
<p>当我们需要获取 ConcurrentHashMap 的元素个数时,会调用 size() 方法。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * {@inheritDoc}</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> int</span><span style="color:#B392F0"> size</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">    long</span><span style="color:#E1E4E8"> n </span><span style="color:#F97583">=</span><span style="color:#B392F0"> sumCount</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> ((n </span><span style="color:#F97583">&lt;</span><span style="color:#79B8FF"> 0L</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">?</span><span style="color:#79B8FF"> 0</span><span style="color:#F97583"> :</span></span>
<span class="line"><span style="color:#E1E4E8">            (n </span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">long</span><span style="color:#E1E4E8">)Integer.MAX_VALUE) </span><span style="color:#F97583">?</span><span style="color:#E1E4E8"> Integer.MAX_VALUE </span><span style="color:#F97583">:</span></span>
<span class="line"><span style="color:#E1E4E8">            (</span><span style="color:#F97583">int</span><span style="color:#E1E4E8">)n);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>而 size() 方法中调用了 sumCount() 方法</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">final</span><span style="color:#F97583"> long</span><span style="color:#B392F0"> sumCount</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">    CounterCell</span><span style="color:#E1E4E8">[] cs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> counterCells;</span></span>
<span class="line"><span style="color:#F97583">    long</span><span style="color:#E1E4E8"> sum </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> baseCount;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (cs </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8"> (CounterCell c </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> cs)</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (c </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">                sum </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> c.value;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> sum;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>在 sumCount() 对 baseCount 还有数组 CounterCell[] 中的每个记录进行累加,返回最终值。</p>
<h3 id="cas-和自旋">CAS 和自旋</h3>
<h4 id="自旋">自旋</h4>
<p>顾名思义,自旋可以理解为”自我旋转”,放到程序中就是”自我循环”,比如 while 循环或者 for 循环。结合着锁来理解的话就是,先获取一次锁,如果获取不到锁,会不停的循环获取,直到获取到。不像普通的锁那样,如果获取不到锁就进入阻塞状态。</p>
<h4 id="cas">CAS</h4>
<p>CAS 是什么,compare-and-swap,比较并交换,它是一种思想,一种算法。
CAS 算法有 3 个基本操作数:</p>
<ul>
<li>内存地址 V</li>
<li>旧的预期值 A</li>
<li>要修改的新值 B</li>
</ul>
<p>在并发场景下,各个代码的执行顺序不能确定,为了保证并发安全,我们可以使用普通的互斥锁,比如 Java 的 synchronized,ReentrantLock 等。而 CAS 的特点是避免使用互斥锁,当多个线程并发使用 CAS 更新同一个变量时,只有一个可以操作成功,其他都会失败。而且用 CAS 更新失败的线程并不会阻塞,会快速失败并返回一个失败的状态,允许你再次尝试。</p>
<p>而 CAS 是一种原子操作,用于实现多线程环境下的同步和并发控制。
基本原理如下:</p>
<ol>
<li>读取内存值: 首先,CAS 会读取内存中的一个变量的当前值。</li>
<li>比较内存值和预期值: 接下来,CAS 会将读取的值与预期值进行比较。如果两者相等,则说明内存中的值没有被其他线程修改。</li>
<li>如果相等,则将新值写入内存: 在比较阶段,如果发现内存值与预期值相等,CAS 会尝试将新值写入内存中。这个写入操作是原子的,即在这个过程中不会被其他线程中断。</li>
<li>如果写入成功,则操作完成,否则重复上述步骤,如果写入操作成功,CAS 完成。如果写入操作失败,说明在比较和写入的过程中,内存值已经被其他线程修改,此时需要重新执行整个 CAS 操作。</li>
</ol>
<p>CAS 的基本原理就是利用比较和写入的原子性操作来实现对共享变量的原子操作,从而避免了传统锁机制中的死锁和线程阻塞问题。</p>
<h4 id="自旋锁和-cas-的关系是什么呢">自旋锁和 CAS 的关系是什么呢?</h4>
<p>其实他们是两个不同的概念,自旋是一种锁优化的机制,在锁优化中<code>自旋锁</code>指线程空转重试获取锁,避免线程上下文切换带来的开销。
CAS 是一种乐观锁机制,CAS 是通过比较并替换,失败的时候可以直接返回 false 不用自旋的获取。只是一般应用场景下,CAS 都会带有重试机制(while 或者 for 实现空转,不断尝试获取)。
如果硬有关系,那么可以这样理解 <strong>自旋锁 = 循环 + CAS</strong>。</p>
<p>CAS 有哪些缺点呢?</p>
<ol>
<li>自旋等待: CAS 在执行时会进行自旋等待,如果失败则需要重试,这会消耗处理器资源。</li>
<li>aba 问题: CAS 只能检测到共享变量的值是否发生了变化,但无法检测到变量的值是否经历了类似 a-&gt;b-&gt;a 的变化,这可能导致一些意外的问题。</li>
<li>无法保证公平性: CAS 操作时非阻塞的,因此无法保证等待线程的公平性,可能导致某些线程长时间无法获得执行机会。</li>
<li>无法解决死锁: CAS 无法解决死锁问题,如果多个线程同时执行 CAS 操作,可能导致死锁的发生。</li>
<li>限制性: CAS 操作通常只能应用于单个变量,对于复杂的数据结构,需要额外的处理来实现原子操作。</li>
</ol>
<p>总的来说,CAS 虽然具有高效的特点,但也存在着一些局限性和缺点。</p>
<h4 id="什么是-aba-问题">什么是 ABA 问题</h4>
<p>ABA 问题是在分布式系统中常见的一种数据一致性问题。它的名称来源于三个操作: A(原始值),B(第一个读取),A(第二个读取)。ABA 问题发生在一个线程 T1 读取了一个共享变量的值 A,然后另一个线程 T2 修改了这个共享变量的值为 B,然后又改回 A,最后线程 T1 再次读取这个共享变量的值,发现仍然是 A。在这种情况下,线程 T1 可能会错误地认为共享变量的值没有改变,从而导致数据不一致。</p>
<p>解决 ABA 问题的常见方案是使用版本号或者标记来跟踪数据的变化。通过在每次数据变化时增加版本号或者标记,可以避免 ABA 问题的发生。另外,使用 CAS 操作也可以解决 ABA 问题,CAS 操作会在更新变量时检查变量的值是否仍然是预期值,从而避免了 ABA 问题的发生。</p>
<p>简单的说就是:</p>
<p>比如线程 1 从内存位置 V 中取出 A,辞职线程 2 也取出 A,且线程 2 做了一次 CAS 将值改为了 B,然后又做了一次 CAS 将值改回了 A。此时线程 1 做 CAS 发现内存中还是 A,则线程 1 操作成功。这个时候实际上 A 值已经被其他线程改变过,这与设计思想是不符合的。</p>
<p>那么这个问题出现在哪里呢?</p>
<ul>
<li>如果只在乎结果,ABA 不介意 B 的存在,没什么问题</li>
<li>如果 B 的存在会造成影响,需要通过 AtomicStampRefrence,加时间戳解决。</li>
</ul> </div> <div class="mb-12 flex flex-wrap gap-2 gap-y-4 md:gap-5"> <a href="/tags/java" aria-label="java"> <!-- <span
		class="w-fit rounded-full bg-indigo-600 px-2 py-1 text-sm font-semibold text-white shadow dark:bg-indigo-900 dark:text-white md:px-5 md:py-2"
	> --> <span class="w-fit rounded-full px-2 py-1 text-sm font-semibold shadow dark:bg-indigo-900 dark:text-white md:px-5 md:py-2">
#java </span> </a><a href="/tags/lock" aria-label="lock"> <!-- <span
		class="w-fit rounded-full bg-indigo-600 px-2 py-1 text-sm font-semibold text-white shadow dark:bg-indigo-900 dark:text-white md:px-5 md:py-2"
	> --> <span class="w-fit rounded-full px-2 py-1 text-sm font-semibold shadow dark:bg-indigo-900 dark:text-white md:px-5 md:py-2">
#lock </span> </a> </div> <!-- related posts --> <footer> <h2 class="mb-6 text-lg font-bold dark:text-white">Related Posts</h2> <section class="flex flex-col md:flex-row sm:justify-between gap-8"> <div class="flex flex-wrap gap-2"> <div class="min-h-full"> <img src="/_astro/cat-26_RMRQG.webp" class="h-16 w-16 rounded-full object-cover" alt="img of Single test coverage statistical principle" width="200" height="200" loading="lazy" decoding="async"> </div> <header class="flex items-center justify-center"> <a class="font-medium hover:underline" href="/post/zh-cn/interview/unittest/single-test-coverage-statistical-principle/"> 单测覆盖率是如何统计的?原理是什么? </a> </header> </div><div class="flex flex-wrap gap-2"> <div class="min-h-full"> <img src="/_astro/pexels-hnoody93-58997_Z1dLmL3.webp" class="h-16 w-16 rounded-full object-cover" alt="img of How to unit test the JDBC layer" width="200" height="200" loading="lazy" decoding="async"> </div> <header class="flex items-center justify-center"> <a class="font-medium hover:underline" href="/post/zh-cn/interview/unittest/how-to-unit-test-the-jdbc-layer/"> 如何对JDBC这一层做单元测试 </a> </header> </div><div class="flex flex-wrap gap-2"> <div class="min-h-full"> <img src="/_astro/cat-29_5zG3l.webp" class="h-16 w-16 rounded-full object-cover" alt="img of How to make a single test Mock" width="200" height="200" loading="lazy" decoding="async"> </div> <header class="flex items-center justify-center"> <a class="font-medium hover:underline" href="/post/zh-cn/interview/unittest/how-to-make-a-single-test-mock/"> 什么是Mock?怎么做单测的Mock? </a> </header> </div> </section> </footer> </article> </div>  </div> </article> <button aria-label="Back to Top" class="z-90 fixed bottom-8 end-4 flex h-10 w-10 translate-y-28 items-center justify-center rounded-full border-2 border-transparent bg-[#f8f9fa99] text-3xl opacity-0 transition-all duration-300 hover:border-zinc-400 data-[show=true]:translate-y-0 data-[show=true]:opacity-100 dark:border-slate-50/[0.06] dark:bg-slate-900/75 sm:end-8 sm:h-12 sm:w-12" data-show="false" id="to-top-btn" style="opacity: 1;--tw-translate-y: -26px;
		transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));"> <svg aria-hidden="true" class="h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M4.5 15.75l7.5-7.5 7.5 7.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button>  <footer class="flex h-28 w-full items-center justify-center border-t-2 px-16">
&copy; 2024 chou403 · Powered by &nbsp;<a href="https://astro.build" style="color:cornflowerblue;">Astro</a>&nbsp;& &nbsp;<a href="https://blog-template-gray.vercel.app" style="color:cornflowerblue;">OpenBlog</a> </footer> </main>    </body> </html>  <div> <div class="fixed inset-0 z-50 hidden" id="headlessui-dialog-:Rlb6:" role="dialog" aria-modal="true" data-headlessui-state="open"> <div class="fixed inset-0 bg-black/20 backdrop-blur-sm dark:bg-slate-900/80" id="" aria-hidden="true" data-headlessui-state="open"></div> <div class="relative w-80 max-w-[calc(100%-3rem)] bg-white p-6 dark:bg-slate-800" id="toc_content"> <button id="close-dialog-page" type="button" class="absolute right-5 top-5 z-10 flex h-8 w-8 items-center justify-center text-slate-500 hover:text-slate-600 dark:text-slate-400 dark:hover:text-slate-300" tabindex="0"><span class="sr-only">Close navigation</span> <svg viewBox="0 0 10 10" class="h-2.5 w-2.5 overflow-visible"> <path d="M0 0L10 10M10 0L0 10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path> </svg> </button> <nav class="h-[59rem] max-w-xs dark:text-black"> <h1 class="mb-3 text-2xl font-bold dark:text-white">On this page</h1> <ul class="sidebar flex flex-col gap-4 [text-wrap:balance]"> <li class="flex flex-col"> <a href="#java-中锁的分类" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Java 中锁的分类 </a>  </li><li class="flex flex-col"> <a href="#reentrantlock" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> ReentrantLock </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#公平锁" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 公平锁 </a>  </li><li class="flex flex-col"> <a href="#非公平锁" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 非公平锁 </a>  </li> </ul> </li><li class="flex flex-col"> <a href="#synchronized-在-jdk16-的优化" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> synchronized 在 JDK1.6 的优化 </a>  </li><li class="flex flex-col"> <a href="#synchronized-的实现原理" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> synchronized 的实现原理 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#对象结构" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 对象结构 </a>  </li><li class="flex flex-col"> <a href="#上锁的原理" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 上锁的原理 </a>  </li> </ul> </li><li class="flex flex-col"> <a href="#reentrantlock和synchronized的区别" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> ReentrantLock和synchronized的区别 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#用法不同" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 用法不同 </a>  </li><li class="flex flex-col"> <a href="#获取锁和释放锁方式不同" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 获取锁和释放锁方式不同 </a>  </li><li class="flex flex-col"> <a href="#锁类型不同" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 锁类型不同 </a>  </li><li class="flex flex-col"> <a href="#响应中断不同" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 响应中断不同 </a>  </li><li class="flex flex-col"> <a href="#底层实现不同" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 底层实现不同 </a>  </li> </ul> </li><li class="flex flex-col"> <a href="#reentrantreadwritelock的实现原理" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> ReentrantReadWriteLock的实现原理 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#提供的方法" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 提供的方法 </a>  </li><li class="flex flex-col"> <a href="#写锁的获取与释放" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 写锁的获取与释放 </a>  </li><li class="flex flex-col"> <a href="#读锁的获取与释放" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 读锁的获取与释放 </a>  </li> </ul> </li><li class="flex flex-col"> <a href="#死锁" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 死锁 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#形成死锁的四个必要条件" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 形成死锁的四个必要条件 </a>  </li><li class="flex flex-col"> <a href="#处理死锁的方法" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 处理死锁的方法 </a>  </li> </ul> </li><li class="flex flex-col"> <a href="#aqs" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> AQS </a>  </li><li class="flex flex-col"> <a href="#面试须知" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 面试须知 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#aqs-唤醒节点时为何从后往前找" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> AQS 唤醒节点时,为何从后往前找 </a>  </li><li class="flex flex-col"> <a href="#concurrenthashmap在18做了什么优化" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> ConcurrentHashMap在1.8做了什么优化 </a>  </li><li class="flex flex-col"> <a href="#concurrenthashmap-的散列算法" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> ConcurrentHashMap 的散列算法 </a>  </li><li class="flex flex-col"> <a href="#为什么-concurrenthashmap-的数组长度需要时-2n" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 为什么 ConcurrentHashMap 的数组长度需要时 2^n </a>  </li><li class="flex flex-col"> <a href="#concurrenthashmap-初始化流程" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> ConcurrentHashMap 初始化流程 </a>  </li><li class="flex flex-col"> <a href="#concurrenthashmap-扩容流程" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> ConcurrentHashMap 扩容流程 </a>  </li><li class="flex flex-col"> <a href="#concurrenthashmap-读取数据流程" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> ConcurrentHashMap 读取数据流程 </a>  </li><li class="flex flex-col"> <a href="#concurrenthashmap-计数器的实现" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> ConcurrentHashMap 计数器的实现 </a>  </li><li class="flex flex-col"> <a href="#cas-和自旋" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> CAS 和自旋 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#自旋" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 自旋 </a>  </li><li class="flex flex-col"> <a href="#cas" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> CAS </a>  </li><li class="flex flex-col"> <a href="#自旋锁和-cas-的关系是什么呢" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 自旋锁和 CAS 的关系是什么呢? </a>  </li><li class="flex flex-col"> <a href="#什么是-aba-问题" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 什么是 ABA 问题 </a>  </li> </ul> </li> </ul> </li> </ul> </nav> </div> </div> </div> 