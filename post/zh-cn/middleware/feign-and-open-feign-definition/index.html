<!DOCTYPE html><html lang="en" class="scroll-smooth" data-astro-cid-37fxchfa> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.ico" type="image/x-icon"><!-- <link rel="icon" type="image/svg+xml" href="/favicon1.svg" /> --><meta name="generator" content="Astro v4.16.2"><!-- Canonical URL --><link rel="canonical" href="https://blog-template-gray.vercel.app/post/zh-cn/middleware/feign-and-open-feign-definition/"><!-- Primary Meta Tags --><title>Feign &amp; openFeign • 知道的越多,才知知道的越少</title><!-- ViewTransitions  --><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><!-- SEO --><meta name="title" content="Feign &#38; openFeign • 知道的越多,才知知道的越少"><meta name="description" content="feign &#38; openFeign 介绍以及使用"><meta name="author" content="chou403"><!-- Open Graph / Facebook --><meta property="og:type" content="article"><meta property="og:url" content="https://blog-template-gray.vercel.app/post/zh-cn/middleware/feign-and-open-feign-definition/"><meta property="og:title" content="Feign &#38; openFeign"><meta property="og:description" content="feign &#38; openFeign 介绍以及使用"><meta property="og:image" content="https://blog-template-gray.vercel.app/_astro/pexels-pixabay-45201.jpg"><meta property="article:author" content="chou403"><meta property="article:published_time" content="2024-08-09T14:46:20.000Z"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog-template-gray.vercel.app/post/zh-cn/middleware/feign-and-open-feign-definition/"><meta property="twitter:title" content="Feign &#38; openFeign"><meta property="twitter:description" content="feign &#38; openFeign 介绍以及使用"><meta property="twitter:image" content="https://blog-template-gray.vercel.app/_astro/pexels-pixabay-45201.jpg"><!-- RSS auto-discovery --><link rel="alternate" type="application/rss+xml" title="知道的越多,才知知道的越少" href="/rss.xml"><link as="font" crossorigin rel="preload" href="/fonts/Manrope-Bold.woff2" type="font/woff2"><style>@font-face {font-weight: 200;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-ExtraLight.woff2)} @font-face {font-weight: 300;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-Light.woff2)} @font-face {font-weight: 400;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-Regular.woff2)} @font-face {font-weight: 500;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-Medium.woff2)} @font-face {font-weight: 600;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-SemiBold.woff2)} @font-face {font-weight: 700;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-Bold.woff2)} @font-face {font-weight: 800;font-style: normal;font-family: Manrope;font-display: swap;src: url(/fonts/Manrope-ExtraBold.woff2)} @font-face { font-family: '_font_fallback_805320212582'; size-adjust: 103.76%; src: local('Arial'); ascent-override: 102.74%; descent-override: 28.91%; line-gap-override: 0.00%; }</style><script>
	function getTheme() {
		const storedTheme = typeof localStorage !== 'undefined' && localStorage.getItem('theme')

		return (
			storedTheme || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark')
		)
	}

	function setTheme(newTheme) {
		const html = document.documentElement
		const isDark = newTheme === 'dark'

		html.classList.toggle('dark', isDark)
		html.classList.toggle('light', !isDark)

		localStorage.setItem('theme', newTheme)
	}

	// set initial theme
	setTheme(getTheme())
	document.addEventListener('astro:after-swap', () => setTheme(getTheme()))

	document.addEventListener('theme-change', (e) => {
		setTheme(e.detail.theme)
	})
</script><script>
	if (!('animations' in localStorage)) {
		localStorage.setItem('animations', 'true')
	} else {
		localStorage.setItem('animations', 'false')
	}
</script><link rel="stylesheet" href="/_astro/_page_.CCiJ3j76.css">
<link rel="stylesheet" href="/_astro/_slug_.Ba2ksmBT.css"><script type="module" src="/_astro/hoisted.D9DAUC0s.js"></script></head> <body class="mx-auto bg-white dark:bg-slate-900 dark:text-slate-400 dark:text-white" data-astro-cid-37fxchfa> <main class="mt-4 grid gap-12 overflow-hidden px-5 antialiased sm:mx-auto sm:max-w-2xl sm:px-8 md:max-w-6xl md:overflow-visible lg:px-0" data-astro-cid-37fxchfa> <header class="fixed left-0 top-0 z-50 flex h-12 w-full items-center bg-[#f8f9fa99] px-5 py-2.5 font-semibold dark:border-slate-50/[0.06] dark:bg-slate-900/60"> <a class="mr-auto text-lg" href="/">Home</a> <div id="astro-header-drawer" class="absolute right-1 top-12 z-50 translate-x-96 rounded-l-lg bg-white p-4 text-slate-500 shadow transition-transform duration-300 ease-in dark:bg-[#0a0910] md:static md:h-auto md:translate-x-0 md:rounded-none md:border-none md:bg-transparent md:p-0 md:shadow-none dark:md:bg-transparent"> <nav class="flex h-full justify-between gap-2 text-left md:w-full md:flex-row md:gap-5"> <div class="flex flex-col gap-4 border-black pr-4 dark:border-white md:flex-row md:border-r-2"> <a href="/tags" class="text-opacity-60 flex items-center gap-1 text-2xl md:text-base" rel="noopener noreferrer ">  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 md:w-6" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path> <path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path> <path d="M6 9h-.01"></path> </svg> Tags
 </a> </div> <div class="flex items-center justify-center gap-3 md:justify-end md:p-0"> <a href="https://github.com/chou403/chou403.github.io" class="text-opacity-60" rel="noopener noreferrer " target="_blank" aria-label="Github">  <span><svg viewBox="0 0 16 16" class="h-5 w-5" fill="currentColor" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg> </span>  </a> </div> <!-- <LanguageSwitcher client:load /> --> </nav> </div> <div class="flex items-center gap-3 text-slate-500 md:pl-3" data-astro-transition-persist="navbar"> <div> <site-search id="search" class="ms-auto"> <button data-open-modal disabled class="flex items-center justify-center rounded-md gap-1"> <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="m19 19-3.5-3.5"></path><circle cx="11" cy="11" r="6"></circle></svg> <!-- <span class='md:hidden text-2xl'> Search</span> --> </button> <dialog aria-label="search" class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-white dark:bg-[#0a0910ec] shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md opacity-0"> <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6"> <button data-close-modal class="ms-auto cursor-pointer rounded-full bg-black text-white px-4 py-2 dark:bg-white dark:text-black">Close</button> <div class="search-container dark:text-white"> <div id="pagefind__search"></div> </div> </div> </dialog> </site-search>   </div>  <theme-toggle class="relative h-6 w-6"> <button id="toggle-theme" class="group" aria-label="Toggle Theme"> <span class="absolute left-0 right-0 top-0 opacity-0 group-aria-pressed:opacity-100"> <svg viewBox="0 0 24 24" fill="none" class="h-6 w-6"><path fill-rule="evenodd" clip-rule="evenodd" d="M17.715 15.15A6.5 6.5 0 0 1 9 6.035C6.106 6.922 4 9.645 4 12.867c0 3.94 3.153 7.136 7.042 7.136 3.101 0 5.734-2.032 6.673-4.853Z" class="fill-sky-400/20"></path><path d="m17.715 15.15.95.316a1 1 0 0 0-1.445-1.185l.495.869ZM9 6.035l.846.534a1 1 0 0 0-1.14-1.49L9 6.035Zm8.221 8.246a5.47 5.47 0 0 1-2.72.718v2a7.47 7.47 0 0 0 3.71-.98l-.99-1.738Zm-2.72.718A5.5 5.5 0 0 1 9 9.5H7a7.5 7.5 0 0 0 7.5 7.5v-2ZM9 9.5c0-1.079.31-2.082.845-2.93L8.153 5.5A7.47 7.47 0 0 0 7 9.5h2Zm-4 3.368C5 10.089 6.815 7.75 9.292 6.99L8.706 5.08C5.397 6.094 3 9.201 3 12.867h2Zm6.042 6.136C7.718 19.003 5 16.268 5 12.867H3c0 4.48 3.588 8.136 8.042 8.136v-2Zm5.725-4.17c-.81 2.433-3.074 4.17-5.725 4.17v2c3.552 0 6.553-2.327 7.622-5.537l-1.897-.632Z" class="fill-sky-500"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M17 3a1 1 0 0 1 1 1 2 2 0 0 0 2 2 1 1 0 1 1 0 2 2 2 0 0 0-2 2 1 1 0 1 1-2 0 2 2 0 0 0-2-2 1 1 0 1 1 0-2 2 2 0 0 0 2-2 1 1 0 0 1 1-1Z" class="fill-sky-500"></path></svg> </span> <span class="absolute left-0 right-0 top-0 opacity-0 group-aria-[pressed=false]:opacity-100"> <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6"><path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" class="fill-sky-400/20 stroke-sky-500"></path><path d="M12 4v1M17.66 6.344l-.828.828M20.005 12.004h-1M17.66 17.664l-.828-.828M12 20.01V19M6.34 17.664l.835-.836M3.995 12.004h1.01M6 6l.835.836" class="stroke-sky-500"></path></svg> </span> </button> </theme-toggle> <script>
	const button = document.getElementById('toggle-theme')

	function setButtonPresssed() {
		const bodyThemeIsDark = document.documentElement.classList.contains('dark')
		button.setAttribute('aria-pressed', String(bodyThemeIsDark))
	}
	setButtonPresssed()
</script> <button id="toggleMenu" class="md:ml-6 md:hidden"> <svg width="24" height="24"><path d="M5 6h14M5 12h14M5 18h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path></svg> </button> <button id="astro-header-drawer-button" type="button" class="md:ml-6 md:hidden"> <svg width="24" height="24" fill="none" aria-hidden="true"><path d="M12 6v.01M12 12v.01M12 18v.01M12 7a1 1 0 1 1 0-2 1 1 0 0 1 0 2Zm0 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Zm0 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg> <span class="sr-only">Show Menu</span> </button> </div> </header>  <div class="pointer-events-none absolute inset-x-0 top-0 z-[60] flex justify-center overflow-hidden"> <div class="flex w-[108rem] flex-none justify-end"> <picture> <source srcset="/_astro/docs.BiePeNN8.avif" type="image/avif"> <img src="/_astro/docs.BeNwu2rW_1CTG48.webp" class="w-[71.75rem] max-w-none flex-none dark:hidden" alt="img of docs" width="200" height="200" loading="lazy" decoding="async"> </picture> <picture> <source srcset="/_astro/docs-dark.C7CksN2y.avif" type="image/avif"> <img src="/_astro/docs-dark.Bsq-hjJH_17S3ea.webp" class="hidden w-[90rem] max-w-none flex-none dark:block" alt="img of docs-dark" width="200" height="200" loading="lazy" decoding="async"> </picture> </div> </div>  <article class="mt-12 min-w-full sm:max-w-none md:max-w-none md:py-4"> <header class="mb-3 flex flex-col gap-6"> <div class="flex flex-wrap gap-2"> <div class="flex items-center justify-center"> <h1 class="text-4xl font-semibold md:pb-2.5 md:text-4xl"> feign &amp; openFeign 介绍以及使用 </h1> </div> </div> <div class="flex gap-x-1"> <p class="text-center text-sm font-bold text-opacity-50"> chou403 </p> <p class="text-center text-sm font-bold text-opacity-50">
/ Middleware </p> <p class="text-center text-sm text-opacity-50">
/ <time class="text-sm font-bold text-opacity-60" datetime="2024-02-22T15:00:03.000Z"> Feb 22, 2024 </time> </p> <p class="text-center text-sm font-bold text-opacity-50">
/ 67 min read </p> <!-- {
					data.updatedDate && (
						<span class="text-quote rounded-lg p-1">
							Last Updated:
							<FormattedDate date={data.updatedDate} />
						</span>
					)
				} --> </div> </header> <!-- annotate blog post image --> <!-- <>
			{
				heroImage && (
					<Image
						src={heroImage}
						width={1000}
						height={500}
						quality={100}
						format="jpg"
						loading="eager"
						class="my-8 max-h-[300px] w-full rounded-md object-cover md:max-h-[500px]"
						alt={`img of ${title}`}
					/>
				)
			}
		</> --> <hr> <div>   <div class="mt-8 grid grid-cols-1 gap-10"> <!-- aside  --> <!-- Left menu bar comments --> <!-- <aside class="hidden flex-col gap-8 md:flex">
			<div class="sticky top-12 z-10 hidden self-start transition-all duration-200 md:block">
				{headings && headings.length > 0 && <TableOfContents {headings} />}
			</div>
		</aside> --> <!-- post --> <article class="grid w-full max-w-full"> <div class="prose prose-lg mb-12 min-w-full dark:prose-invert md:prose-xl"> <h2 id="什么是feign">什么是Feign</h2>
<p>Netflix Feign 是 Netflix 公司发布的一种实现负载均衡和服务调用的开源组件。Spring Cloud 将其与 Netflix 中的其他开源服务组件(例如 Eureka,Ribbon 以及 Hystrix 等)一起整合进 Spring Cloud Netflix 模块中,整合后全称为 Spring Cloud Netflix Feign Feign 对 <a href="http://c.biancheng.net/springcloud/ribbon.html">Ribbon</a>进行了集成,利用 Ribbon 维护了一份可用服务清单,并通过 Ribbon 实现了客户端的负载均衡。Feign 是一种声明式服务调用组件,它在 RestTemplate 的基础上做了进一步的封装。通过 Feign,我们只需要声明一个接口并通过注解进行简单的配置(类似于 Dao 接口上面的 Mapper 注解一样)即可实现对 HTTP 接口的绑定。通过 Feign,我们可以像调用本地方法一样来调用远程服务,而完全感觉不到这是在进行远程调用。Feign 支持多种注解,例如 Feign 自带的注解以及 JAX-RS 注解等,但遗憾的是 Feign 本身并不支持 Spring MVC 注解,这无疑会给广大 Spring 用户带来不便。</p>
<h2 id="什么是openfeign">什么是openFeign</h2>
<p>2019 年 Netflix 公司宣布 Feign 组件正式进入停更维护状态,于是 Spring 官方便推出了一个名为 OpenFeign 的组件作为 Feign 的替代方案。</p>
<p>OpenFeign 全称 Spring Cloud OpenFeign,它是 Spring 官方推出的一种声明式服务调用与负载均衡组件,它的出现就是为了替代进入停更维护状态的 Feign。OpenFeign 是 Spring Cloud 对 Feign 的二次封装,它具有 Feign 的所有功能,并在 Feign 的基础上增加了对 Spring MVC 注解的支持,例如 @RequestMapping,@GetMapping 和 @PostMapping 等。</p>
<p>常用注解</p>





























<table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@FeignClient</td><td>该注解用于通知 OpenFeign 组件对 @RequestMapping 注解下的接口进行解析,并通过动态代理的方式产生实现类,实现负载均衡和服务调用。</td></tr><tr><td>EnableFeignClients</td><td>该注解用于开启 OpenFeign 功能,当 Spring Cloud 应用启动时,OpenFeign 会扫描标有 @FeignClient 注解的接口,生成代理并注册到 Spring 容器中。</td></tr><tr><td>@RequestMapping</td><td>Spring MVC 注解,在 Spring MVC 中使用该注解映射请求,通过它来指定控制器(Controller)可以处理哪些 URL 请求,相当于 Servlet 中 web.xml 的配置。</td></tr><tr><td>@GetMapping</td><td>Spring MVC 注解,用来映射 GET 请求,它是一个组合注解,相当于 @RequestMapping(method = RequestMethod.GET) 。</td></tr><tr><td>@PostMapping</td><td>Spring MVC 注解,用来映射 POST 请求,它是一个组合注解,相当于 @RequestMapping(method = RequestMethod.POST) 。</td></tr></tbody></table>
<h2 id="feign与openfeign的对比">Feign与OpenFeign的对比</h2>
<p>**相同点: **</p>
<ul>
<li>Feign 和 OpenFeign 都是 Spring Cloud 下的远程调用和负载均衡组件。</li>
<li>Feign 和 OpenFeign 作用一样,都可以实现服务的远程调用和负载均衡。</li>
<li>Feign 和 OpenFeign 都对 Ribbon 进行了集成,都利用 Ribbon 维护了可用服务清单,并通过 Ribbon 实现了客户端的负载均衡。</li>
<li>Feign 和 OpenFeign 都是在服务消费者(客户端)定义服务绑定接口并通过注解的方式进行配置,以实现远程服务的调用。</li>
</ul>
<p>**不同点: **</p>
<ul>
<li>Feign 和 OpenFeign 的依赖项不同,Feign 的依赖为 spring-cloud-starter-feign,而 OpenFeign 的依赖为 spring-cloud-starter-openfeign。</li>
<li>Feign 和 OpenFeign 支持的注解不同,Feign 支持 Feign 注解和 JAX-RS 注解,但不支持 Spring MVC 注解;OpenFeign 除了支持 Feign 注解和 JAX-RS 注解外,还支持 Spring MVC 注解。</li>
</ul>
<h2 id="openfeign使用">openFeign使用</h2>
<p>引入依赖</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">&lt;!-- openfeign依赖 --&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">&lt;</span><span style="color:#85E89D">dependency</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">      &lt;</span><span style="color:#85E89D">groupId</span><span style="color:#E1E4E8">&gt;org.springframework.cloud&lt;/</span><span style="color:#85E89D">groupId</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">      &lt;</span><span style="color:#85E89D">artifactId</span><span style="color:#E1E4E8">&gt;spring-cloud-starter-openfeign&lt;/</span><span style="color:#85E89D">artifactId</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">&lt;/</span><span style="color:#85E89D">dependency</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">&lt;!-- openfeign优化请求连接池依赖 --&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">&lt;</span><span style="color:#85E89D">dependency</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">     &lt;</span><span style="color:#85E89D">groupId</span><span style="color:#E1E4E8">&gt;io.github.openfeign&lt;/</span><span style="color:#85E89D">groupId</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">     &lt;</span><span style="color:#85E89D">artifactId</span><span style="color:#E1E4E8">&gt;feign-httpclient&lt;/</span><span style="color:#85E89D">artifactId</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">&lt;/</span><span style="color:#85E89D">dependency</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"></span></code></pre> </div> 
<p>定义远程调用接口</p>
<ul>
<li>在 @FeignClient 注解中,value 属性的取值为: 服务提供者的服务名,即服务提供者配置文件(application.yml)中 spring.application.name 的取值。</li>
<li>接口中定义的每个方法都与服务提供者中 Controller 定义的服务方法对应。</li>
<li>openfeign本身并不具备fallback降级属性,需要搭配降级框架如(hystrix或sentinel)。如果未引入降级框架,即使声明fallback降级服务类,在远程调用发生异常时,也不会触发。</li>
</ul>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Component</span></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">FeignClient</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">value</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> &quot;service5&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> interface</span><span style="color:#B392F0"> FeignService</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">     @</span><span style="color:#F97583">GetMapping</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;/api/v1/service5&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">     List&lt;</span><span style="color:#F97583">Integer</span><span style="color:#E1E4E8">&gt; </span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>启动类添加注解@EnableFeignClients</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">EnableFeignClients</span></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">EnableEurekaClient</span></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">SpringBootApplication</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> Service3Application</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">     public</span><span style="color:#F97583"> static</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">[] </span><span style="color:#FFAB70">args</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        SpringApplication.</span><span style="color:#B392F0">run</span><span style="color:#E1E4E8">(Service3Application.class, args);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h2 id="openfeign超时处理">OpenFeign超时处理</h2>
<p>openFeign 客户端的默认超时时间为 1 秒钟,如果服务端处理请求的时间超过 1 秒就会报错。为了避免这样的情况,我们需要对 OpenFeign 客户端的超时时间进行控制。</p>
<p>yml 添加如下进行配置</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#85E89D">ribbon</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  ReadTimeout</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">6000</span><span style="color:#6A737D"> #建立连接所用的时间,适用于网络状况正常的情况下,两端两端连接所用的时间</span></span>
<span class="line"><span style="color:#85E89D">  ConnectionTimeout</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">6000</span><span style="color:#6A737D"> #建立连接后,服务器读取到可用资源的时间</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D">feign</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  client</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    httpclient</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      enabled</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#6A737D"> # 开启 HttpClient优化连接池</span></span>
<span class="line"><span style="color:#85E89D">  compression</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    request</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      enabled</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#6A737D"> # 开启请求数据的压缩功能</span></span>
<span class="line"><span style="color:#85E89D">      mime-types</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">text/xml,application/xml, application/json</span><span style="color:#6A737D"> # 压缩类型</span></span>
<span class="line"><span style="color:#85E89D">      min-request-size</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">1024</span><span style="color:#6A737D"> # 最小压缩值标准,当数据大于 1024 才会进行压缩</span></span>
<span class="line"><span style="color:#85E89D">    response</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      enabled</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#6A737D"> # 开启响应数据压缩功能</span></span>
<span class="line"></span></code></pre> </div> 
<h2 id="openfeign日志增强">OpenFeign日志增强</h2>
<p>yml 添加日志级别声明</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#85E89D">logging</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  level</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    com.ftc.service3.FeignService</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">debug</span><span style="color:#6A737D"> #feign日志以什么样的级别监控该接口</span></span>
<span class="line"></span></code></pre> </div> 
<p>说明:</p>
<ul>
<li>com.ftc.service3.FeignService 是开启 @FeignClient 注解的接口(即服务绑定接口)的完整类名。也可以只配置部分路径,表示监控该路径下的所有服务绑定接口</li>
<li>debug: 表示监听该接口的日志级别。</li>
</ul>
<p>创建日志配置类</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Configuration</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> ConfigBean</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  /**</span></span>
<span class="line"><span style="color:#6A737D">    * OpenFeign 日志增强</span></span>
<span class="line"><span style="color:#6A737D">    * 配置 OpenFeign 记录哪些内容</span></span>
<span class="line"><span style="color:#6A737D">    */</span></span>
<span class="line"><span style="color:#E1E4E8">  @</span><span style="color:#F97583">Bean</span></span>
<span class="line"><span style="color:#E1E4E8">  Logger.Level </span><span style="color:#B392F0">feginLoggerLevel</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> Logger.Level.FULL;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>该配置的作用是通过配置的 Logger.Level 对象告诉 OpenFeign 记录哪些日志内容。Logger.Level 的具体级别如下:</p>
<ul>
<li>NONE: 不记录任何信息。</li>
<li>BASIC: 仅记录请求方法,URL 以及响应状态码和执行时间。</li>
<li>HEADERS: 除了记录 BASIC 级别的信息外,还会记录请求和响应的头信息。</li>
<li>FULL: 记录所有请求与响应的明细,包括头信息,请求体,元数据等等。</li>
</ul>
<h2 id="openfeign-实现-requestinterceptor">OpenFeign 实现 RequestInterceptor</h2>
<p>在一些业务场景中,微服务间相互调用需要做鉴权,以保证我们服务的安全性。即: 服务 A 调用服务 B 的时候需要将服务 B 的一些鉴权信息传递给服务 B,从而保证服务 B 的调用也可以通过鉴权,进而保证整个服务调用链的安全。</p>
<p>通过 RequestInterceptor 拦截器拦截 openfeign 服务请求,将上游服务的请求头或者请求体中的数据封装到我们的 openfeign 调用的请求模版中,从而实现上游数据的传递。</p>
<h3 id="requestinterceptor-实现类">RequestInterceptor 实现类</h3>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Slf4j</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MyFeignRequestInterceptor</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> RequestInterceptor</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  /**</span></span>
<span class="line"><span style="color:#6A737D">   * 这里可以实现对请求的拦截,对请求添加一些额外信息之类的</span></span>
<span class="line"><span style="color:#6A737D">   *</span></span>
<span class="line"><span style="color:#6A737D">   * </span><span style="color:#F97583">@param</span><span style="color:#FFAB70"> requestTemplate</span></span>
<span class="line"><span style="color:#6A737D">   */</span></span>
<span class="line"><span style="color:#E1E4E8">  @</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">  public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> apply</span><span style="color:#E1E4E8">(RequestTemplate </span><span style="color:#FFAB70">requestTemplate</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">    // 1. obtain request</span></span>
<span class="line"><span style="color:#F97583">    final</span><span style="color:#E1E4E8"> ServletRequestAttributes attributes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (ServletRequestAttributes) RequestContextHolder.</span><span style="color:#B392F0">getRequestAttributes</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 2. 兼容hystrix限流后,获取不到ServletRequestAttributes的问题(使拦截器直接失效)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (Objects.</span><span style="color:#B392F0">isNull</span><span style="color:#E1E4E8">(attributes)) {</span></span>
<span class="line"><span style="color:#E1E4E8">      log.</span><span style="color:#B392F0">error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;MyFeignRequestInterceptor is invalid!&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    HttpServletRequest request </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> attributes.</span><span style="color:#B392F0">getRequest</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 2. obtain request headers,and put it into openFeign RequestTemplate</span></span>
<span class="line"><span style="color:#E1E4E8">    Enumeration&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">&gt; headerNames </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> request.</span><span style="color:#B392F0">getHeaderNames</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (Objects.</span><span style="color:#B392F0">nonNull</span><span style="color:#E1E4E8">(headerNames)) {</span></span>
<span class="line"><span style="color:#F97583">      while</span><span style="color:#E1E4E8"> (headerNames.</span><span style="color:#B392F0">hasMoreElements</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">        String name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> headerNames.</span><span style="color:#B392F0">nextElement</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        String value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> request.</span><span style="color:#B392F0">getHeader</span><span style="color:#E1E4E8">(name);</span></span>
<span class="line"><span style="color:#E1E4E8">        requestTemplate.</span><span style="color:#B392F0">header</span><span style="color:#E1E4E8">(name, value);</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // todo 需要传递请求参数时放开</span></span>
<span class="line"><span style="color:#79B8FF">    3.</span><span style="color:#E1E4E8"> obtain request body, and put it into openFeign RequestTemplate</span></span>
<span class="line"><span style="color:#E1E4E8">    Enumeration&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">&gt; bodyNames </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> request.</span><span style="color:#B392F0">getParameterNames</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    StringBuffer body </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> StringBuffer</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (bodyNames </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      while</span><span style="color:#E1E4E8"> (bodyNames.</span><span style="color:#B392F0">hasMoreElements</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">        String name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> bodyNames.</span><span style="color:#B392F0">nextElement</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        String value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> request.</span><span style="color:#B392F0">getParameter</span><span style="color:#E1E4E8">(name);</span></span>
<span class="line"><span style="color:#E1E4E8">        body.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(name).</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;=&quot;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(value).</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;&amp;&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (body.</span><span style="color:#B392F0">length</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">      body.</span><span style="color:#B392F0">deleteCharAt</span><span style="color:#E1E4E8">(body.</span><span style="color:#B392F0">length</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">      requestTemplate.</span><span style="color:#B392F0">body</span><span style="color:#E1E4E8">(body.</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">      log.</span><span style="color:#B392F0">info</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;openfeign interceptor body:{}&quot;</span><span style="color:#E1E4E8">, body.</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h3 id="使-requestinterceptor-生效">使 RequestInterceptor 生效</h3>
<ol>
<li>
<p>代码方式全局生效</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Configuration</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MyConfiguration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Bean</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> RequestInterceptor </span><span style="color:#B392F0">requestInterceptor</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> MyFeignRequestInterceptor</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
</li>
<li>
<p>配置方式全局生效</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#85E89D">feign</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  client</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    config</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      default</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        connectTimeout</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">5000</span></span>
<span class="line"><span style="color:#85E89D">        readTimeout</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">5000</span></span>
<span class="line"><span style="color:#85E89D">        loggerLevel</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">full</span></span>
<span class="line"><span style="color:#6A737D">        # 拦截器配置(和@Bean的方式二选一)</span></span>
<span class="line"><span style="color:#85E89D">        requestInterceptors</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">          - </span><span style="color:#9ECBFF">com.chou403.feign.config.MyFeignRequestInterceptor</span></span>
<span class="line"></span></code></pre> </div> 
</li>
<li>
<p>代码方式针对某个服务生效</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">FeignClient</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">value</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> &quot;service-a&quot;</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">configuration</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> MyFeignRequestInterceptor.class)</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> interface</span><span style="color:#B392F0"> ServiceClient</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre> </div> 
</li>
<li>
<p>配置方式针对某个服务生效</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#85E89D">feign</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  client</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    config</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      SERVICE-A</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        connectTimeout</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">5000</span></span>
<span class="line"><span style="color:#85E89D">        readTimeout</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">5000</span></span>
<span class="line"><span style="color:#85E89D">        loggerLevel</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">full</span></span>
<span class="line"><span style="color:#6A737D">        # 拦截器配置(和@Bean的方式二选一)</span></span>
<span class="line"><span style="color:#85E89D">        requestInterceptors</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">          - </span><span style="color:#9ECBFF">com.chou403.feign.config.MyFeignRequestInterceptor</span></span>
<span class="line"></span></code></pre> </div> 
</li>
</ol>
<h3 id="服务提供者增加拦截器用于获取请求头中的数据">服务提供者增加拦截器(用于获取请求头中的数据)</h3>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Slf4j</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MvcInterceptor</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> HandlerInterceptor</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> preHandle</span><span style="color:#E1E4E8">(HttpServletRequest </span><span style="color:#FFAB70">request</span><span style="color:#E1E4E8">, HttpServletResponse </span><span style="color:#FFAB70">response</span><span style="color:#E1E4E8">, Object </span><span style="color:#FFAB70">handler</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        String token </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> request.</span><span style="color:#B392F0">getHeader</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;token&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        log.</span><span style="color:#B392F0">info</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;obtain token is : {}&quot;</span><span style="color:#E1E4E8">, token);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Configuration</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MvcInterceptorConfig</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> WebMvcConfigurer</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> addInterceptors</span><span style="color:#E1E4E8">(InterceptorRegistry </span><span style="color:#FFAB70">registry</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        registry.</span><span style="color:#B392F0">addInterceptor</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> MvcInterceptor</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#E1E4E8">                .</span><span style="color:#B392F0">addPathPatterns</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;/**&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h3 id="结合-hystrix-限流使用的坑">结合 Hystrix 限流使用的坑</h3>
<p>application.yaml 配置文件开启限流</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#85E89D">feign</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  hystrix</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    enabled</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span></span>
<span class="line"><span style="color:#85E89D">hystrix</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  command</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    default</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      execution</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        isolation</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">          thread</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">            timeoutInMilliseconds</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">30000</span></span>
<span class="line"></span></code></pre> </div> 
<p>做完上述配置后,<strong>Feign 接口的熔断机制为: 线程模式</strong>。如果我们自定义了一个 <code>RequestInterceptor</code> 实现类,就会导致 hystrix 熔断机制失效,接口调用异常(404,null)。</p>
<h4 id="原因分析">原因分析</h4>
<ul>
<li>在 Feign 调用之前,会先走到 RequestInterceptor 拦截器,拦截器中使用了 <code>ServletRequestAttributes</code> 获取请求数据。</li>
<li>默认 Feign 使用的是线程池模式,当开始熔断的时候,负责熔断的线程和执行 Feign 接口的线程不是同一个线程,ServletRequestAttributes 取到的将会是空值。</li>
</ul>
<h4 id="解决方案">解决方案</h4>
<p>将 hystrix 熔断方式从线程模式改为信号量模式</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#85E89D">feign</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  hystrix</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    enabled</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span></span>
<span class="line"><span style="color:#85E89D">hystrix</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  command</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    default</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      execution</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        isolation</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">          thread</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">            timeoutInMilliseconds</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">30000</span></span>
<span class="line"><span style="color:#85E89D">          strategy</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">SEMAPHORE</span></span>
<span class="line"></span></code></pre> </div> 
<h4 id="hystrix-线程池和信号量隔离区别">hystrix 线程池和信号量隔离区别</h4>








































<table><thead><tr><th></th><th>线程池</th><th>信号量</th></tr></thead><tbody><tr><td>线程</td><td>请求线程和调用 provider 线程不是同一条线程</td><td>请求线程和调用 provider 线程是同一条线程</td></tr><tr><td>开销</td><td>排队,调用,上下文切换等</td><td>无线程切换,开销低</td></tr><tr><td>异步</td><td>支持</td><td>不支持</td></tr><tr><td>并发支持</td><td>支持: 最大线程池大小</td><td>支持: 最大信号量上限</td></tr><tr><td>传递 Header</td><td>不支持</td><td>支持</td></tr><tr><td>支持超时</td><td>支持</td><td>不支持</td></tr></tbody></table>
<h4 id="线程和信号量隔离的使用场景">线程和信号量隔离的使用场景</h4>
<blockquote>
<p><strong>线程池隔离</strong></p>
</blockquote>
<ul>
<li>请求并发量大,并且耗时长(一般是计算量大或者读数据库)</li>
<li>采用线程池隔离,可以保证大量的容器线程可用,不会由于其他服务原因,一直处于阻塞或者等待状态,快速失败返回</li>
</ul>
<blockquote>
<p><strong>信号量隔离</strong></p>
</blockquote>
<ul>
<li>请求并发量大,并且耗时短(一般是计算量小,或读缓存)</li>
<li>采用信号量隔离时的服务返回往往非常快,不会占用容器线程太长时间</li>
<li>其减少了线程切换的一些开销,提高了缓存服务的效率</li>
</ul>
<h2 id="openfeign-核心组件">openfeign 核心组件</h2>
<p>使用 Feign 最核心的是要构造一个 FeignClient,里面包含了一系列的组件:</p>
<ol>
<li>Encoder(SpringEncoder)
Encoder 编码器,当我们调用接口时,如果传递的参数是一个对象,Feign 需要对这个对象进行 encode 编码,做 JSON 序列化,即: encoder 负责将 Java 对象装换成 JSON 字符串。</li>
<li>Decoder(ResponseEntityDecoder)
Decoder 解码器,当接口收到一个 JSON 对象后,Feign 需要对这个对象进行 decode 解码,即: decoder 负责将 JSON 字符串转换成 JavaBean 对象。</li>
<li>Contract(SpringMvcContract)
一般来说 Feign 的@FeignClient 注解需要和 Spring Web MVC 支持的@PathVariable,@RequestMapping,@pRequestParam 等注解结合起来使用,但是 Feign 本身是不支持 Spring Web MVC 注解的,所以需要有一个契约组件(Contract),负责解释 Spring MVC 的注解,让 Feign 可以和 Spring MVC 注解结合起来使用。</li>
<li>Logger(Slf4jLogger)
Logger 为打印 Feign 接口请求调用日志的日志组件,默认为 Slf4jLogger。</li>
</ol>
<h2 id="openfeign-如何扫描所有-feignclient基于低版本-springcloud-20200x版本之前">openfeign 如何扫描所有 FeignClient(基于低版本 SpringCloud 2020.0.x版本之前)</h2>
<p>基于的 SpringCloud 版本</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8"> &lt;</span><span style="color:#85E89D">properties</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#85E89D">spring-boot.version</span><span style="color:#E1E4E8">&gt;2.3.7.RELEASE&lt;/</span><span style="color:#85E89D">spring-boot.version</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#85E89D">spring-cloud.version</span><span style="color:#E1E4E8">&gt;Hoxton.SR9&lt;/</span><span style="color:#85E89D">spring-cloud.version</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#85E89D">spring-cloud-alibaba.version</span><span style="color:#E1E4E8">&gt;2.2.6.RELEASE&lt;/</span><span style="color:#85E89D">spring-cloud-alibaba.version</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">&lt;/</span><span style="color:#85E89D">properties</span><span style="color:#E1E4E8">&gt;</span></span>
<span class="line"></span></code></pre> </div> 
<p>我们知道 openfeign 有两个注解: @EnableFeignClients 和 @FeignClient,其中:</p>
<blockquote>
<p>@EnableFeignClients: 用来开启 openfeign</p>
<p>@FeignClient: 标记要用 openfeign 来拦截的请求接口</p>
</blockquote>
<p>为什么 Service-B 服务中定义了一个 ServiceAClient 接口(继承自 Service-A 的 api 接口),某 Controller 或 Service 中通过 @Autowired 注入一个 ServiceAClient 接口的实例,就可以通过 openfeign 做负载均衡去调用 Service-A服务?</p>
<h3 id="feignclient解析">@FeignClient解析</h3>
<h4 id="feignclient注解解释">@FeignClient注解解释</h4>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> @</span><span style="color:#F97583">interface</span><span style="color:#F97583"> FeignClient</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // 微服务名</span></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">AliasFor</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;name&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    String </span><span style="color:#B392F0">value</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#9ECBFF"> &quot;&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">    // 已经废弃,直接使用 name 即可</span></span>
<span class="line"><span style="color:#6A737D">    /** @deprecated */</span></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Deprecated</span></span>
<span class="line"><span style="color:#E1E4E8">    String </span><span style="color:#B392F0">serviceId</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#9ECBFF"> &quot;&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">    // 存在多个相同 FeignClient 时,可以使用 contextId 做唯一约束</span></span>
<span class="line"><span style="color:#E1E4E8">    String </span><span style="color:#B392F0">contextId</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#9ECBFF"> &quot;&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">AliasFor</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;value&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    String </span><span style="color:#B392F0">name</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#9ECBFF"> &quot;&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">    // 对应 Spring 的 @Qualifier 注解,在定义 @FeignClient 时,指定 qualifier</span></span>
<span class="line"><span style="color:#6A737D">    // 在 @Autowired 注入 FeignClient 时,使用 @Qualifier 注解</span></span>
<span class="line"><span style="color:#6A737D">    /** @deprecated */</span></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Deprecated</span></span>
<span class="line"><span style="color:#E1E4E8">    String </span><span style="color:#B392F0">qualifier</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#9ECBFF"> &quot;&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    String</span><span style="color:#E1E4E8">[] </span><span style="color:#B392F0">qualifiers</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#E1E4E8"> {};</span></span>
<span class="line"><span style="color:#6A737D">    // 用于配置指定服务的地址 / IP,相当于直接请求这个服务,不经过 Ribbon 的负载均衡</span></span>
<span class="line"><span style="color:#E1E4E8">    String </span><span style="color:#B392F0">url</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#9ECBFF"> &quot;&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">    // 当调用请求发生 404 错误时,如果 decode404 的值为 true,会执行 decode 解码用 404 代替抛出 FeignException 异常,否则直接抛出异常</span></span>
<span class="line"><span style="color:#F97583">    boolean</span><span style="color:#B392F0"> decode404</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">    // OpenFeign 的配置类,在配置类中可以自定义 Feign 的 Encoder,Decoder,LogLevel,Contract 等</span></span>
<span class="line"><span style="color:#E1E4E8">    Class</span><span style="color:#F97583">&lt;?&gt;</span><span style="color:#E1E4E8">[] </span><span style="color:#B392F0">configuration</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#E1E4E8"> {};</span></span>
<span class="line"><span style="color:#6A737D">    // 定义容错的处理类(回退逻辑),fallback 类必须实现 FeignClient 的接口</span></span>
<span class="line"><span style="color:#E1E4E8">    Class</span><span style="color:#F97583">&lt;?&gt;</span><span style="color:#B392F0"> fallback</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#E1E4E8"> void.class;</span></span>
<span class="line"><span style="color:#6A737D">    // 也是容错的处理,但是可以知道熔断的异常信息</span></span>
<span class="line"><span style="color:#E1E4E8">    Class</span><span style="color:#F97583">&lt;?&gt;</span><span style="color:#B392F0"> fallbackFactory</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#E1E4E8"> void.class;</span></span>
<span class="line"><span style="color:#6A737D">    // path 定义当前 FeignClient 访问接口时的统一前缀,比如接口地址是 /user/get,如果定义了前缀是 user,那么具体方法上的路径就只需要写 /get 即可</span></span>
<span class="line"><span style="color:#E1E4E8">    String </span><span style="color:#B392F0">path</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#9ECBFF"> &quot;&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    boolean</span><span style="color:#B392F0"> primary</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h4 id="feignclient-注解作用">@FeignClient 注解作用</h4>
<p>用 @FeignClient 注解标注一个接口后,OpenFeign 会对这个接口创建一个对应的动态代理 —&gt; REST Client(发送 RESTful 请求的客户端),然后可以将这个 REST Client 注入其他的组件(比如 SerivceBController),如果弃用了 Ribbon,就会采用负载均衡的方式,来进行 http 请求的发送。</p>
<h5 id="使用-ribbonclient-自定义负载均衡策略">使用 @RibbonClient 自定义负载均衡策略</h5>
<p>可以用 @RibbonClient 标准一个配置类,在 @RibbonClient 注解的 configuration 属性中可以指定配置类,自定义自己的 Ribbon 的 ILoadBalancer,@RibbonClient 的名称要和 @FeignClient 的名称一样</p>
<p>**在 SpringBoot 扫描不到的目录下新建一个配置类: **</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Configuration</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> MyConfiguration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Bean</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> IRule </span><span style="color:#B392F0">getRule</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> MyRule</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Bean</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> IPing </span><span style="color:#B392F0">getPing</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> MyPing</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>**在 SpringBoot 可以扫描到的目录新建一个配置类(被 @RibbonClient 注解标注): **
由于 @FeignClient 中填的name()/value() 是 Service-A,所以 @RibbonClient 的 value() 也必须是 Service-A,表示针对调用服务 Service-A 时做负载均衡。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Cinfiguration</span></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">RibbonClient</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">name</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> &quot;Service-A&quot;</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">configuration</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> MyConfiguration.class)</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> ServiceAConfiguration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h3 id="enablefeignclients-解析">@EnableFeignClients 解析</h3>
<p><code>@EnableFeignClients</code> 注解用于开启 openfeign,可以猜测,@EnableFeignClients 注解会触发 openfeign 的核心机制: 扫描所有包下面的 @FeignClient 注解的接口,生成 @FeignClient 标注接口的动态代理类。</p>
<p>基于这两个猜测解析 @EnableFeignClients。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Retention</span><span style="color:#E1E4E8">(RetentionPolicy.RUNTIME)</span></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Target</span><span style="color:#E1E4E8">({ElementType.TYPE})</span></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Documented</span></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Import</span><span style="color:#E1E4E8">({FeignClientsRegistrar.class})</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> @</span><span style="color:#F97583">interface</span><span style="color:#F97583"> EnableFeignClients</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    String</span><span style="color:#E1E4E8">[] </span><span style="color:#B392F0">value</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#E1E4E8"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    String</span><span style="color:#E1E4E8">[] </span><span style="color:#B392F0">basePackages</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#E1E4E8"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    Class</span><span style="color:#F97583">&lt;?&gt;</span><span style="color:#E1E4E8">[] </span><span style="color:#B392F0">basePackageClasses</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#E1E4E8"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    Class</span><span style="color:#F97583">&lt;?&gt;</span><span style="color:#E1E4E8">[] </span><span style="color:#B392F0">defaultConfiguration</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#E1E4E8"> {};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    Class</span><span style="color:#F97583">&lt;?&gt;</span><span style="color:#E1E4E8">[] </span><span style="color:#B392F0">clients</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">default</span><span style="color:#E1E4E8"> {};</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p><code>@EnableFeignClients</code> 注解中通过 <code>@Import</code> 导入了一个 <code>FeignClientsRegistrar</code> 类,FeignClientsRegistrar 负责 FeignClient 的注册(即: 扫描指定包下的 @FeignClient 注解标注的接口,生成 FeignClient 动态代理类,触发后面的其他流程)。</p>
<h4 id="feignclientsregistrar-类">FeignClientsRegistrar 类</h4>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202402291451526.png" alt="202402291451526"/></p>
<p>由于 <code>FeignClientsRegistrar</code> 实现自 <code>ImportBeanDefinitionRegistrar</code>,结合 <a href="spring-deifinition-integrated-impl.md">SpringBoot 的自动配置</a>,得知,在 SpringBoot 启动过程中会进入到 FeignClientsRegistrar#registerBeanDefinitions(AnnotationMetadata metadata, BeanDefinitionRegistry registry) 方法。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> registerBeanDefinitions</span><span style="color:#E1E4E8">(AnnotationMetadata metadata, BeanDefinitionRegistry registry) {</span></span>
<span class="line"><span style="color:#6A737D">    // 注册默认配置</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">registerDefaultConfiguration</span><span style="color:#E1E4E8">(metadata, registry);</span></span>
<span class="line"><span style="color:#6A737D">    // 注册所有的 FeignClient</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">registerFeignClients</span><span style="color:#E1E4E8">(metadata, registry);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p><code>registerBeanDefinitions()</code> 方法是 Feign 的核心入口方法,其中会做两件事: 注册默认的配置,注册所有的 FeignClient。</p>
<h5 id="注册默认配置">注册默认配置</h5>
<p><code>registerDefaultConfiguration()</code> 方法负责注册 openfeign 的默认配置。具体代码执行流程如下:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> registerDefaultConfiguration</span><span style="color:#E1E4E8">(AnnotationMetadata metadata, BeanDefinitionRegistry registry) {</span></span>
<span class="line"><span style="color:#6A737D">    // 获取 @EnableFeignClients 注解中的全部属性</span></span>
<span class="line"><span style="color:#E1E4E8">    Map&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">Object</span><span style="color:#E1E4E8">&gt; defaultAttrs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> metadata.</span><span style="color:#B392F0">getAnnotationAttributes</span><span style="color:#E1E4E8">(EnableFeignClients.class.</span><span style="color:#B392F0">getName</span><span style="color:#E1E4E8">(), </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (defaultAttrs </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &amp;&amp;</span><span style="color:#E1E4E8"> defaultAttrs.</span><span style="color:#B392F0">containsKey</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;defaultConfiguration&quot;</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#E1E4E8">        String name;</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (metadata.</span><span style="color:#B392F0">hasEnclosingClass</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">            name </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> &quot;default.&quot;</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> metadata.</span><span style="color:#B392F0">getEnclosingClassName</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">            // 默认这里,name 为启动类全路径名</span></span>
<span class="line"><span style="color:#E1E4E8">            name </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> &quot;default.&quot;</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> metadata.</span><span style="color:#B392F0">getClassName</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        // 将以name 作为 beanName 的 BeanDefinition 注册到 BeanDefinitionRegistry 中</span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">registerClientConfiguration</span><span style="color:#E1E4E8">(registry, name, defaultAttrs.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;defaultConfiguration&quot;</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> registerClientConfiguration</span><span style="color:#E1E4E8">(BeanDefinitionRegistry registry, Object name, Object configuration) {</span></span>
<span class="line"><span style="color:#6A737D">    // 构建 BeanDefinition</span></span>
<span class="line"><span style="color:#E1E4E8">    BeanDefinitionBuilder builder </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> BeanDefinitionBuilder.</span><span style="color:#B392F0">genericBeanDefinition</span><span style="color:#E1E4E8">(FeignClientSpecification.class);</span></span>
<span class="line"><span style="color:#E1E4E8">    builder.</span><span style="color:#B392F0">addConstructorArgValue</span><span style="color:#E1E4E8">(name);</span></span>
<span class="line"><span style="color:#E1E4E8">    builder.</span><span style="color:#B392F0">addConstructorArgValue</span><span style="color:#E1E4E8">(configuration);</span></span>
<span class="line"><span style="color:#6A737D">    // 注册 BeanDefinition</span></span>
<span class="line"><span style="color:#E1E4E8">    registry.</span><span style="color:#B392F0">registerBeanDefinition</span><span style="color:#E1E4E8">(name </span><span style="color:#F97583">+</span><span style="color:#9ECBFF"> &quot;.&quot;</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> FeignClientSpecification.class.</span><span style="color:#B392F0">getSimpleName</span><span style="color:#E1E4E8">(), builder.</span><span style="color:#B392F0">getBeanDefinition</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>方法流程解析:</p>
<blockquote>
<p>1.首先获取 @EnableFeignClients 注解的全部属性</p>
<p>2.如果属性不为空,并且属性中包含 defaultConfiguration,则默认字符串 <code>default.</code> 和启动类全路径名拼接到一起</p>
<p>3.然后再拼接上 <code>.FeignClientSpecification</code>,作为 beanName,构建出一个 BeanDefinition,将其注册到 BeanDefinitionRegistry 中。</p>
</blockquote>
<h5 id="注册所有的-feignclient">注册所有的 FeignClient</h5>
<p>registerFeignClients()方法负责注册所有的FeignClient</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> registerFeignClients</span><span style="color:#E1E4E8">(AnnotationMetadata metadata, BeanDefinitionRegistry registry) {</span></span>
<span class="line"><span style="color:#6A737D">    // 获取类扫描器</span></span>
<span class="line"><span style="color:#E1E4E8">    ClassPathScanningCandidateComponentProvider scanner </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getScanner</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    scanner.</span><span style="color:#B392F0">setResourceLoader</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.resourceLoader);</span></span>
<span class="line"><span style="color:#6A737D">    // 获取 @EnableFeignClients 注解中的全部属性</span></span>
<span class="line"><span style="color:#E1E4E8">    Map&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">Object</span><span style="color:#E1E4E8">&gt; attrs </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> metadata.</span><span style="color:#B392F0">getAnnotationAttributes</span><span style="color:#E1E4E8">(EnableFeignClients.class.</span><span style="color:#B392F0">getName</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#6A737D">    // 给类扫描器添加 Filter,只扫描 @FeignClient 注解</span></span>
<span class="line"><span style="color:#E1E4E8">    AnnotationTypeFilter annotationTypeFilter </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> AnnotationTypeFilter</span><span style="color:#E1E4E8">(FeignClient.class);</span></span>
<span class="line"><span style="color:#6A737D">    // 获取 @EnableFeignClients 注解中的 clients 属性值,默认为空</span></span>
<span class="line"><span style="color:#E1E4E8">    Class&lt;</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">&gt;[] clients </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> attrs </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> ?</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> :</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">Class</span><span style="color:#E1E4E8">[])((</span><span style="color:#F97583">Class</span><span style="color:#E1E4E8">[])attrs.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;clients&quot;</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">    Object basePackages;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (clients </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &amp;&amp;</span><span style="color:#E1E4E8"> clients.length </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        final</span><span style="color:#E1E4E8"> Set&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">&gt; clientClasses </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> HashSet</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        basePackages </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> HashSet</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        Class</span><span style="color:#E1E4E8">[] var9 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> clients;</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> var10 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> clients.length;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> var11 </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; var11 </span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8"> var10; </span><span style="color:#F97583">++</span><span style="color:#E1E4E8">var11) {</span></span>
<span class="line"><span style="color:#E1E4E8">            Class&lt;</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">&gt; clazz </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> var9[var11];</span></span>
<span class="line"><span style="color:#E1E4E8">            ((Set)basePackages).</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(ClassUtils.</span><span style="color:#B392F0">getPackageName</span><span style="color:#E1E4E8">(clazz));</span></span>
<span class="line"><span style="color:#E1E4E8">            clientClasses.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(clazz.</span><span style="color:#B392F0">getCanonicalName</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        AbstractClassTestingTypeFilter filter </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> AbstractClassTestingTypeFilter</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">            protected</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> match</span><span style="color:#E1E4E8">(ClassMetadata </span><span style="color:#FFAB70">metadata</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">                String cleaned </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> metadata.</span><span style="color:#B392F0">getClassName</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">replaceAll</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;</span><span style="color:#79B8FF">\\</span><span style="color:#9ECBFF">$&quot;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&quot;.&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">                return</span><span style="color:#E1E4E8"> clientClasses.</span><span style="color:#B392F0">contains</span><span style="color:#E1E4E8">(cleaned);</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        };</span></span>
<span class="line"><span style="color:#E1E4E8">        scanner.</span><span style="color:#B392F0">addIncludeFilter</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> AllTypeFilter</span><span style="color:#E1E4E8">(Arrays.</span><span style="color:#B392F0">asList</span><span style="color:#E1E4E8">(filter, annotationTypeFilter)));</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        scanner.</span><span style="color:#B392F0">addIncludeFilter</span><span style="color:#E1E4E8">(annotationTypeFilter);</span></span>
<span class="line"><span style="color:#E1E4E8">        basePackages </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getBasePackages</span><span style="color:#E1E4E8">(metadata);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    Iterator var17 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ((Set)basePackages).</span><span style="color:#B392F0">iterator</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    while</span><span style="color:#E1E4E8">(var17.</span><span style="color:#B392F0">hasNext</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">        String basePackage </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (String)var17.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">        // 遍历扫描到的所有包含 @FeignClient 注解的接口(BeanDefinition)</span></span>
<span class="line"><span style="color:#E1E4E8">        Set&lt;</span><span style="color:#F97583">BeanDefinition</span><span style="color:#E1E4E8">&gt; candidateComponents </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> scanner.</span><span style="color:#B392F0">findCandidateComponents</span><span style="color:#E1E4E8">(basePackage);</span></span>
<span class="line"><span style="color:#E1E4E8">        Iterator var21 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> candidateComponents.</span><span style="color:#B392F0">iterator</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        while</span><span style="color:#E1E4E8">(var21.</span><span style="color:#B392F0">hasNext</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">            BeanDefinition candidateComponent </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (BeanDefinition)var21.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (candidateComponent </span><span style="color:#F97583">instanceof</span><span style="color:#E1E4E8"> AnnotatedBeanDefinition) {</span></span>
<span class="line"><span style="color:#E1E4E8">                AnnotatedBeanDefinition beanDefinition </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (AnnotatedBeanDefinition)candidateComponent;</span></span>
<span class="line"><span style="color:#E1E4E8">                AnnotationMetadata annotationMetadata </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> beanDefinition.</span><span style="color:#B392F0">getMetadata</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">                // 如果标注了 @FeignClient 注解的 Class 不是接口类型,则触发断言</span></span>
<span class="line"><span style="color:#E1E4E8">                Assert.</span><span style="color:#B392F0">isTrue</span><span style="color:#E1E4E8">(annotationMetadata.</span><span style="color:#B392F0">isInterface</span><span style="color:#E1E4E8">(), </span><span style="color:#9ECBFF">&quot;@FeignClient can only be specified on an interface&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">                // 获取 @FeignClient 注解的全部属性</span></span>
<span class="line"><span style="color:#E1E4E8">                Map&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">Object</span><span style="color:#E1E4E8">&gt; attributes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> annotationMetadata.</span><span style="color:#B392F0">getAnnotationAttributes</span><span style="color:#E1E4E8">(FeignClient.class.</span><span style="color:#B392F0">getCanonicalName</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#6A737D">                // 从 @FeignClient 注解中获取要调用的服务名</span></span>
<span class="line"><span style="color:#E1E4E8">                String name </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getClientName</span><span style="color:#E1E4E8">(attributes);</span></span>
<span class="line"><span style="color:#6A737D">                // 将要调用的服务名称 + @FeignClient 的配置属性,在 BeanDefinitionRegistry 中注册一下</span></span>
<span class="line"><span style="color:#79B8FF">                this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">registerClientConfiguration</span><span style="color:#E1E4E8">(registry, name, attributes.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;configuration&quot;</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#6A737D">                // 注册 FeignClient</span></span>
<span class="line"><span style="color:#79B8FF">                this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">registerFeignClient</span><span style="color:#E1E4E8">(registry, annotationMetadata, attributes);</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>**方法逻辑解析: **</p>
<blockquote>
<p>1.首先获取@EnableFeignClients注解的所有属性,主要为了拿到扫描包路径(basePackages);</p>
<p>2.因为一般不会在@EnableFeignClients注解中配置clients属性,所以会进入到clients属性为空时的逻辑;</p>
<p>3.然后通过getScanner()方法获取扫描器: ClassPathScanningCandidateComponentProvider,并将上下文AnnotationConfigServletWebServerApplicationContext作为扫描器的ResourceLoader;</p>
<p>4.接着给扫描器ClassPathScanningCandidateComponentProvider添加一个注解过滤器(AnnotationTypeFilter),只过滤出包含@FeignClient注解的BeanDefinition;</p>
<p>5.再通过getBasePackages(metadata)方法获取@EnableFeingClients注解中的指定的包扫描路径 或 扫描类;如果没有获取到,则默认扫描启动类所在的包路径;</p>
<p>6.然后进入到核心逻辑: 通过scanner.findCandidateComponents(basePackage)方法从包路径下扫描出所有标注了@FeignClient注解并符合条件装配的接口;</p>
<p>7.最后将FeignClientConfiguration 在BeanDefinitionRegistry中注册一下,再对FeignClient做真正的注册操作。</p>
</blockquote>
<h5 id="获取包扫描路径">获取包扫描路径</h5>
<p>FeignClientsRegistrar#getBasePackages(metadata)方法负责获取包路径:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#E1E4E8"> Set</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">String</span><span style="color:#F97583">&gt;</span><span style="color:#B392F0"> getBasePackages</span><span style="color:#E1E4E8">(AnnotationMetadata importingClassMetadata) {</span></span>
<span class="line"><span style="color:#6A737D">    // 获取 @EnableFeignClients 注解的全部属性</span></span>
<span class="line"><span style="color:#E1E4E8">    Map&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">Object</span><span style="color:#E1E4E8">&gt; attributes </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> importingClassMetadata.</span><span style="color:#B392F0">getAnnotationAttributes</span><span style="color:#E1E4E8">(EnableFeignClients.class.</span><span style="color:#B392F0">getCanonicalName</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    Set&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">&gt; basePackages </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> HashSet</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    String</span><span style="color:#E1E4E8">[] var4 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">[])((</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">[])attributes.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;value&quot;</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> var5 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> var4.length;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> var6;</span></span>
<span class="line"><span style="color:#E1E4E8">    String pkg;</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8">(var6 </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; var6 </span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8"> var5; </span><span style="color:#F97583">++</span><span style="color:#E1E4E8">var6) {</span></span>
<span class="line"><span style="color:#E1E4E8">        pkg </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> var4[var6];</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (StringUtils.</span><span style="color:#B392F0">hasText</span><span style="color:#E1E4E8">(pkg)) {</span></span>
<span class="line"><span style="color:#E1E4E8">            basePackages.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(pkg);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 指定包路径</span></span>
<span class="line"><span style="color:#E1E4E8">    var4 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">[])((</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">[])attributes.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;basePackages&quot;</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">    var5 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> var4.length;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8">(var6 </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; var6 </span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8"> var5; </span><span style="color:#F97583">++</span><span style="color:#E1E4E8">var6) {</span></span>
<span class="line"><span style="color:#E1E4E8">        pkg </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> var4[var6];</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (StringUtils.</span><span style="color:#B392F0">hasText</span><span style="color:#E1E4E8">(pkg)) {</span></span>
<span class="line"><span style="color:#E1E4E8">            basePackages.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(pkg);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 指定类名场景下,获取指定类所在的包</span></span>
<span class="line"><span style="color:#F97583">    Class</span><span style="color:#E1E4E8">[] var8 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">Class</span><span style="color:#E1E4E8">[])((</span><span style="color:#F97583">Class</span><span style="color:#E1E4E8">[])attributes.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;basePackageClasses&quot;</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">    var5 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> var8.length;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8">(var6 </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; var6 </span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8"> var5; </span><span style="color:#F97583">++</span><span style="color:#E1E4E8">var6) {</span></span>
<span class="line"><span style="color:#E1E4E8">        Class&lt;</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">&gt; clazz </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> var8[var6];</span></span>
<span class="line"><span style="color:#E1E4E8">        basePackages.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(ClassUtils.</span><span style="color:#B392F0">getPackageName</span><span style="color:#E1E4E8">(clazz));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (basePackages.</span><span style="color:#B392F0">isEmpty</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#6A737D">        // 如果没有 @EnableFeignClient 注解没有指定扫描的包路径或类,则返回启动类所在的包</span></span>
<span class="line"><span style="color:#E1E4E8">        basePackages.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(ClassUtils.</span><span style="color:#B392F0">getPackageName</span><span style="color:#E1E4E8">(importingClassMetadata.</span><span style="color:#B392F0">getClassName</span><span style="color:#E1E4E8">()));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> basePackages;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>**方法执行逻辑解析: **</p>
<blockquote>
<p>1.首先获取@EnableFeignClients注解中的全部属性;</p>
<p>2.如果指定了basePackages,则采用basePackages指定的目录作为包扫描路径;</p>
<p>3.如果指定了一些basePackageClasses,则采用basePackageClasses指定的类们所在的目录 作为包扫描路径;</p>
<p>4.如果既没有指定basePackages,也没有指定basePackageClasses,则采用启动类所在的目录作为包扫描路径。默认是这种情况。</p>
</blockquote>
<h5 id="扫描所有的-feignclient">扫描所有的 FeignClient</h5>
<p>ClassPathScanningCandidateComponentProvider#findCandidateComponents(String basePackage)方法负责扫描出指定目录下的所有标注了@FeignClient注解的Class类(包括interface,正常的Class)。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> Set</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">BeanDefinition</span><span style="color:#F97583">&gt;</span><span style="color:#B392F0"> findCandidateComponents</span><span style="color:#E1E4E8">(String basePackage) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.componentsIndex </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &amp;&amp;</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">indexSupportsIncludeFilters</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">?</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">addCandidateComponentsFromIndex</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.componentsIndex, basePackage) </span><span style="color:#F97583">:</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">scanCandidateComponents</span><span style="color:#E1E4E8">(basePackage);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">// basePackage: 启动类所在的目录</span></span>
<span class="line"><span style="color:#F97583">private</span><span style="color:#E1E4E8"> Set</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">BeanDefinition</span><span style="color:#F97583">&gt;</span><span style="color:#B392F0"> scanCandidateComponents</span><span style="color:#E1E4E8">(String basePackage) {</span></span>
<span class="line"><span style="color:#E1E4E8">    Set&lt;</span><span style="color:#F97583">BeanDefinition</span><span style="color:#E1E4E8">&gt; candidates </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> LinkedHashSet</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        String packageSearchPath </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> &quot;classpath*:&quot;</span><span style="color:#F97583"> +</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">resolveBasePackage</span><span style="color:#E1E4E8">(basePackage) </span><span style="color:#F97583">+</span><span style="color:#9ECBFF"> &#39;/&#39;</span><span style="color:#F97583"> +</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.resourcePattern;</span></span>
<span class="line"><span style="color:#6A737D">        // 扫描出指定路径下的所有 Class 文件</span></span>
<span class="line"><span style="color:#F97583">        Resource</span><span style="color:#E1E4E8">[] resources </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getResourcePatternResolver</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">getResources</span><span style="color:#E1E4E8">(packageSearchPath);</span></span>
<span class="line"><span style="color:#F97583">        boolean</span><span style="color:#E1E4E8"> traceEnabled </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.logger.</span><span style="color:#B392F0">isTraceEnabled</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        boolean</span><span style="color:#E1E4E8"> debugEnabled </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.logger.</span><span style="color:#B392F0">isDebugEnabled</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        Resource</span><span style="color:#E1E4E8">[] var7 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> resources;</span></span>
<span class="line"><span style="color:#F97583">        int</span><span style="color:#E1E4E8"> var8 </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> resources.length;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        // 遍历每个 Class 文件</span></span>
<span class="line"><span style="color:#F97583">        for</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> var9 </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; var9 </span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8"> var8; </span><span style="color:#F97583">++</span><span style="color:#E1E4E8">var9) {</span></span>
<span class="line"><span style="color:#E1E4E8">            Resource resource </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> var7[var9];</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (traceEnabled) {</span></span>
<span class="line"><span style="color:#79B8FF">                this</span><span style="color:#E1E4E8">.logger.</span><span style="color:#B392F0">trace</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Scanning &quot;</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> resource);</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (resource.</span><span style="color:#B392F0">isReadable</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">                try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">                    MetadataReader metadataReader </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getMetadataReaderFactory</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">getMetadataReader</span><span style="color:#E1E4E8">(resource);</span></span>
<span class="line"><span style="color:#6A737D">                    // 根据 Scanner 中的 @FeignClient 过滤器,过滤出所有被 @FeignClient 注解标注的 Class</span></span>
<span class="line"><span style="color:#F97583">                    if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">isCandidateComponent</span><span style="color:#E1E4E8">(metadataReader)) {</span></span>
<span class="line"><span style="color:#E1E4E8">                        ScannedGenericBeanDefinition sbd </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> ScannedGenericBeanDefinition</span><span style="color:#E1E4E8">(metadataReader);</span></span>
<span class="line"><span style="color:#E1E4E8">                        sbd.</span><span style="color:#B392F0">setSource</span><span style="color:#E1E4E8">(resource);</span></span>
<span class="line"><span style="color:#6A737D">                        // 这里默认都返回 true,获取 Scanner 时重写了这个方法</span></span>
<span class="line"><span style="color:#F97583">                        if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">isCandidateComponent</span><span style="color:#E1E4E8">((AnnotatedBeanDefinition)sbd)) {</span></span>
<span class="line"><span style="color:#F97583">                            if</span><span style="color:#E1E4E8"> (debugEnabled) {</span></span>
<span class="line"><span style="color:#79B8FF">                                this</span><span style="color:#E1E4E8">.logger.</span><span style="color:#B392F0">debug</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Identified candidate component class: &quot;</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> resource);</span></span>
<span class="line"><span style="color:#E1E4E8">                            }</span></span>
<span class="line"><span style="color:#6A737D">                            // 最终标注了 @FeignClient 注解的 Class 都会放到这里,并返回</span></span>
<span class="line"><span style="color:#E1E4E8">                            candidates.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(sbd);</span></span>
<span class="line"><span style="color:#E1E4E8">                        } </span><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (debugEnabled) {</span></span>
<span class="line"><span style="color:#79B8FF">                            this</span><span style="color:#E1E4E8">.logger.</span><span style="color:#B392F0">debug</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Ignored because not a concrete top-level class: &quot;</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> resource);</span></span>
<span class="line"><span style="color:#E1E4E8">                        }</span></span>
<span class="line"><span style="color:#E1E4E8">                    } </span><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (traceEnabled) {</span></span>
<span class="line"><span style="color:#79B8FF">                        this</span><span style="color:#E1E4E8">.logger.</span><span style="color:#B392F0">trace</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Ignored because not matching any filter: &quot;</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> resource);</span></span>
<span class="line"><span style="color:#E1E4E8">                    }</span></span>
<span class="line"><span style="color:#E1E4E8">                } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (Throwable </span><span style="color:#FFAB70">var13</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">                    throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> BeanDefinitionStoreException</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Failed to read candidate component class: &quot;</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> resource, var13);</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"><span style="color:#E1E4E8">            } </span><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (traceEnabled) {</span></span>
<span class="line"><span style="color:#79B8FF">                this</span><span style="color:#E1E4E8">.logger.</span><span style="color:#B392F0">trace</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;Ignored because not readable: &quot;</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> resource);</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> candidates;</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (IOException </span><span style="color:#FFAB70">var14</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> BeanDefinitionStoreException</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;I/O failure during classpath scanning&quot;</span><span style="color:#E1E4E8">, var14);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>**方法逻辑解析: **</p>
<blockquote>
<p>1.首先扫描出指定路径下的所有Class文件;</p>
<p>2.接着遍历每个Class文件,使用Scanner中的@FeignClient过滤器过滤出所有被@FeignClient注解标注的Class;</p>
<p>3.最后将过滤出的所有Class返回。</p>
</blockquote>
<p>细看一下 <code>isCandidateComponent(MetadataReader metadataReader)</code> 方法:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> isCandidateComponent</span><span style="color:#E1E4E8">(MetadataReader metadataReader) throws IOException {</span></span>
<span class="line"><span style="color:#E1E4E8">    Iterator var2 </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.excludeFilters.</span><span style="color:#B392F0">iterator</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    TypeFilter tf;</span></span>
<span class="line"><span style="color:#F97583">    do</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">var2.</span><span style="color:#B392F0">hasNext</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#6A737D">            // includeFilters 是在获取到 Scanner 之后添加的</span></span>
<span class="line"><span style="color:#E1E4E8">            var2 </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.includeFilters.</span><span style="color:#B392F0">iterator</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">            do</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">                if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">var2.</span><span style="color:#B392F0">hasNext</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">                    return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">                tf </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (TypeFilter)var2.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">            // 判断 Class 是否被 @FeignClient 注解标注</span></span>
<span class="line"><span style="color:#E1E4E8">            } </span><span style="color:#F97583">while</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">tf.</span><span style="color:#B392F0">match</span><span style="color:#E1E4E8">(metadataReader, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getMetadataReaderFactory</span><span style="color:#E1E4E8">()));</span></span>
<span class="line"><span style="color:#6A737D">            //条件装配</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">isConditionMatch</span><span style="color:#E1E4E8">(metadataReader);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        tf </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (TypeFilter)var2.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">while</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">tf.</span><span style="color:#B392F0">match</span><span style="color:#E1E4E8">(metadataReader, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getMetadataReaderFactory</span><span style="color:#E1E4E8">()));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>AbstractTypeHierarchyTraversingFilter#match(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory)</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> match</span><span style="color:#E1E4E8">(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory) throws IOException {</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">matchSelf</span><span style="color:#E1E4E8">(metadataReader)) {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">  ...</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">AnnotationTypeFilter#</span><span style="color:#B392F0">matchSelf</span><span style="color:#E1E4E8">(MetadataReader metadataReader)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">```java</span></span>
<span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> boolean</span><span style="color:#B392F0"> matchSelf</span><span style="color:#E1E4E8">(MetadataReader metadataReader) {</span></span>
<span class="line"><span style="color:#E1E4E8">    AnnotationMetadata metadata </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> metadataReader.</span><span style="color:#B392F0">getAnnotationMetadata</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> metadata.</span><span style="color:#B392F0">hasAnnotation</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.annotationType.</span><span style="color:#B392F0">getName</span><span style="color:#E1E4E8">()) </span><span style="color:#F97583">||</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.considerMetaAnnotations </span><span style="color:#F97583">&amp;&amp;</span><span style="color:#E1E4E8"> metadata.</span><span style="color:#B392F0">hasMetaAnnotation</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.annotationType.</span><span style="color:#B392F0">getName</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h5 id="注册feignclient">注册FeignClient</h5>
<p>扫描到所有的FeignClient之后,需要将其注入到Spring中,<code>FeignClientsRegistrar#registerFeignClient()</code> 方法负责这个操作;</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">private</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> registerFeignClient</span><span style="color:#E1E4E8">(BeanDefinitionRegistry registry, AnnotationMetadata annotationMetadata, Map</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">String, Object</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> attributes) {</span></span>
<span class="line"><span style="color:#E1E4E8">    String className </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> annotationMetadata.</span><span style="color:#B392F0">getClassName</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 构建 FeignClient 对应的 BeanDefinition</span></span>
<span class="line"><span style="color:#E1E4E8">    BeanDefinitionBuilder definition </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> BeanDefinitionBuilder.</span><span style="color:#B392F0">genericBeanDefinition</span><span style="color:#E1E4E8">(FeignClientFactoryBean.class);</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">validate</span><span style="color:#E1E4E8">(attributes);</span></span>
<span class="line"><span style="color:#E1E4E8">    definition.</span><span style="color:#B392F0">addPropertyValue</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;url&quot;</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getUrl</span><span style="color:#E1E4E8">(attributes));</span></span>
<span class="line"><span style="color:#E1E4E8">    definition.</span><span style="color:#B392F0">addPropertyValue</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;path&quot;</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getPath</span><span style="color:#E1E4E8">(attributes));</span></span>
<span class="line"><span style="color:#E1E4E8">    String name </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getName</span><span style="color:#E1E4E8">(attributes);</span></span>
<span class="line"><span style="color:#E1E4E8">    definition.</span><span style="color:#B392F0">addPropertyValue</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;name&quot;</span><span style="color:#E1E4E8">, name);</span></span>
<span class="line"><span style="color:#E1E4E8">    String contextId </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getContextId</span><span style="color:#E1E4E8">(attributes);</span></span>
<span class="line"><span style="color:#E1E4E8">    definition.</span><span style="color:#B392F0">addPropertyValue</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;contextId&quot;</span><span style="color:#E1E4E8">, contextId);</span></span>
<span class="line"><span style="color:#E1E4E8">    definition.</span><span style="color:#B392F0">addPropertyValue</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;type&quot;</span><span style="color:#E1E4E8">, className);</span></span>
<span class="line"><span style="color:#E1E4E8">    definition.</span><span style="color:#B392F0">addPropertyValue</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;decode404&quot;</span><span style="color:#E1E4E8">, attributes.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;decode404&quot;</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">    definition.</span><span style="color:#B392F0">addPropertyValue</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;fallback&quot;</span><span style="color:#E1E4E8">, attributes.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;fallback&quot;</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">    definition.</span><span style="color:#B392F0">addPropertyValue</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;fallbackFactory&quot;</span><span style="color:#E1E4E8">, attributes.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;fallbackFactory&quot;</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">    definition.</span><span style="color:#B392F0">setAutowireMode</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    String alias </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> contextId </span><span style="color:#F97583">+</span><span style="color:#9ECBFF"> &quot;FeignClient&quot;</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    AbstractBeanDefinition beanDefinition </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> definition.</span><span style="color:#B392F0">getBeanDefinition</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    beanDefinition.</span><span style="color:#B392F0">setAttribute</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;factoryBeanObjectType&quot;</span><span style="color:#E1E4E8">, className);</span></span>
<span class="line"><span style="color:#F97583">    boolean</span><span style="color:#E1E4E8"> primary </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Boolean)attributes.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;primary&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    beanDefinition.</span><span style="color:#B392F0">setPrimary</span><span style="color:#E1E4E8">(primary);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 如果 FeignClient 配置了别名,则采用别名作为 beanName</span></span>
<span class="line"><span style="color:#E1E4E8">    String qualifier </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getQualifier</span><span style="color:#E1E4E8">(attributes);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (StringUtils.</span><span style="color:#B392F0">hasText</span><span style="color:#E1E4E8">(qualifier)) {</span></span>
<span class="line"><span style="color:#E1E4E8">        alias </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> qualifier;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    BeanDefinitionHolder holder </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> BeanDefinitionHolder</span><span style="color:#E1E4E8">(beanDefinition, className, </span><span style="color:#F97583">new</span><span style="color:#F97583"> String</span><span style="color:#E1E4E8">[]{alias});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 将 FeignClient 注册到 Spring 的临时容器</span></span>
<span class="line"><span style="color:#E1E4E8">    BeanDefinitionReaderUtils.</span><span style="color:#B392F0">registerBeanDefinition</span><span style="color:#E1E4E8">(holder, registry);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>注册FeignClient实际就是构建一个FeignClient对应的BeanDefinition,然后将FeignClient的一些属性配置设置为BeanDefinition的property,最后将BeanDefinition注册到Spring的临时容器。在处理FeignClient的属性配置时,如果@FeignClient中配置了qualifier,则使用qualifier作为beanName。</p>
<p>到这里已经完成了包的扫描,FeignClient的解析,FeignClient数据以BeanDefinition的形式存储到spring框架中的BeanDefinitionRegistry中。</p>
<h3 id="feignclient-的动态代理类">FeignClient 的动态代理类</h3>
<p>在<code>AbstractApplicationContext#refresh()</code>方法中最后调用的<code>finishBeanFactoryInitialization(beanFactory)</code>方法中会将所有类全部注入到Spring容器中;在将ServiceBController注入到Spring容器过程中,会将其成员ServiceAClient也注入到Spring容器中,<code>AbstractAutowireCapableBeanFactory#populateBean()</code>方法会处理ServiceAClient,进而调用到<code>AutowiredAnnotationBeanPostProcessor#postProcessProperties()</code>方法对ServiceAClient做一个注入操作。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011534065.png" alt="202403011534065"/></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011541600.png" alt="202403011541600"/></p>
<p>走到<code>AbstractBeanFactory#getBean(String)</code>方法获取ServiceBController依赖的成员类型ServiceAClient。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011542177.png" alt="202403011542177"/></p>
<p>由于我们在注册FeignClient到Spring容器时,构建的BeanDefinition的beanClas是FeignClientFactoryBean。</p>
<p>FeignClientFactoryBean是一个工厂,保存了@FeignClient注解的所有属性值,在Spring容器初始化的过程中,其会根据之前扫描出的FeignClient信息构建FeignClient的动态代理类。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011547458.png" alt="202403011547458"/></p>
<p>从debug的堆栈信息我们可以看到是FeignClientFactoryBean#getObject()方法负责获取/创建动态代理类。</p>
<h4 id="feignclientfactorybean-创建动态代理类的入口">FeignClientFactoryBean 创建动态代理类的入口</h4>
<p>我们都知道要通过注册到 Spring 容器中的 FeignClient 的 BeanDefinition 的 beanClass 属性是 FeignClientFactoryBean,所以大概率和 FeignClientFactoryBean 是相关的,怎么找呐?连蒙带猜~</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#E1E4E8"> Feign.Builder </span><span style="color:#B392F0">feign</span><span style="color:#E1E4E8">(FeignContext context) {</span></span>
<span class="line"><span style="color:#E1E4E8">    FeignLoggerFactory loggerFactory </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (FeignLoggerFactory)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(context, FeignLoggerFactory.class);</span></span>
<span class="line"><span style="color:#E1E4E8">    Logger logger </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> loggerFactory.</span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.type);</span></span>
<span class="line"><span style="color:#E1E4E8">    Feign.Builder builder </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ((Feign.Builder)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(context, Feign.Builder.class)).</span><span style="color:#B392F0">logger</span><span style="color:#E1E4E8">(logger).</span><span style="color:#B392F0">encoder</span><span style="color:#E1E4E8">((Encoder)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(context, Encoder.class)).</span><span style="color:#B392F0">decoder</span><span style="color:#E1E4E8">((Decoder)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(context, Decoder.class)).</span><span style="color:#B392F0">contract</span><span style="color:#E1E4E8">((Contract)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(context, Contract.class));</span></span>
<span class="line"><span style="color:#6A737D">    // 处理 Feign.Builder 的配置信息</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">configureFeign</span><span style="color:#E1E4E8">(context, builder);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> builder;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>注意到 FeignClientFactoryBean 的 feign(FeignContext context) 方法,方法会构造一个 Feign.Builder,Builder,这不就是构造器模式嘛,基于 Feign.Builder 可以构造对应的 FeignClient。</p>
<p>再看哪里调用了 feign() 方法,找到 getTarget() 方法。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">T</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> T </span><span style="color:#B392F0">getTarget</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    FeignContext context </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (FeignContext)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.applicationContext.</span><span style="color:#B392F0">getBean</span><span style="color:#E1E4E8">(FeignContext.class);</span></span>
<span class="line"><span style="color:#E1E4E8">    Feign.Builder builder </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">feign</span><span style="color:#E1E4E8">(context);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">StringUtils.</span><span style="color:#B392F0">hasText</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.url)) {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.name.</span><span style="color:#B392F0">startsWith</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;http&quot;</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#79B8FF">            this</span><span style="color:#E1E4E8">.url </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> &quot;http://&quot;</span><span style="color:#F97583"> +</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.name;</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">            this</span><span style="color:#E1E4E8">.url </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.name;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.url </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.url </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">cleanPath</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">loadBalance</span><span style="color:#E1E4E8">(builder, context, </span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> Target.</span><span style="color:#B392F0">HardCodedTarget</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.type, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.name, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.url));</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (StringUtils.</span><span style="color:#B392F0">hasText</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.url) </span><span style="color:#F97583">&amp;&amp;</span><span style="color:#F97583"> !</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.url.</span><span style="color:#B392F0">startsWith</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;http&quot;</span><span style="color:#E1E4E8">)) {</span></span>
<span class="line"><span style="color:#79B8FF">            this</span><span style="color:#E1E4E8">.url </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> &quot;http://&quot;</span><span style="color:#F97583"> +</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.url;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        String url </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.url </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">cleanPath</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        Client client </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Client)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getOptional</span><span style="color:#E1E4E8">(context, Client.class);</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (client </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (client </span><span style="color:#F97583">instanceof</span><span style="color:#E1E4E8"> LoadBalancerFeignClient) {</span></span>
<span class="line"><span style="color:#E1E4E8">                client </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ((LoadBalancerFeignClient)client).</span><span style="color:#B392F0">getDelegate</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (client </span><span style="color:#F97583">instanceof</span><span style="color:#E1E4E8"> FeignBlockingLoadBalancerClient) {</span></span>
<span class="line"><span style="color:#E1E4E8">                client </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> ((FeignBlockingLoadBalancerClient)client).</span><span style="color:#B392F0">getDelegate</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">            builder.</span><span style="color:#B392F0">client</span><span style="color:#E1E4E8">(client);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">        Targeter targeter </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Targeter)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(context, Targeter.class);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> targeter.</span><span style="color:#B392F0">target</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, builder, context, </span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> Target.</span><span style="color:#B392F0">HardCodedTarget</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.type, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.name, url));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>对于有一定开发的经验而言,见到 Target 这一类东西,基本可以确定就是动态代理。</p>
<p>再往上追,看哪里调用了 getTarget() 方法?进入到 getObject() 方法。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> Object </span><span style="color:#B392F0">getObject</span><span style="color:#E1E4E8">() throws Exception {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getTarget</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>而getObject()方法是FactoryBean接口中定义的方法。</p>
<p>到这里可以确定 FeignClientFactoryBean#getObject() 方法,在 Spring 容器初始化时,会被作为入口来调用,进而创建一个 ServiceAClient 的动态代理,返回给 Spring 容器并注册到 Spring 容器里去。</p>
<h4 id="feignbuilder的构建过程">Feign.Builder的构建过程</h4>
<p>上面我们得出结论: FeignClient 是通过 Feign.Builder 来构建的,生成 FeignClient 动态代理的入口是 FeignClientFactoryBean#getObject(),这里我们看一下 Feign.Builder 是如何构建的?</p>
<h5 id="feigncontext-上下文的获取">FeignContext 上下文的获取</h5>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011636380.png" alt="202403011636380"/></p>
<p>调用FeignClientFactoryBean#getObject()创建/获取FeignClient动态代理类时,首先要通过</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">FeignContext context </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> applicationContext.</span><span style="color:#B392F0">getBean</span><span style="color:#E1E4E8">(FeignContext.class);</span></span>
<span class="line"></span></code></pre> </div> 
<p>获取 feign 的上下文 FeignClient。
这里的 applicationContext 是 AnnotationConfigServletWebApplicationContext。</p>
<blockquote>
<p>ribbon里有一个SpringClientFactory,就是对每个服务的调用,都会有一个独立的ILoadBalancer,IoadBalancer里面的IRule,IPing都是独立的组件,也就是说ribbon要调用的每个服务都对应一个独立的spring容器;从那个独立的spring容器中,可以取出某个服务关联的属于自己的LoadBalancer,IRule,IPing等。</p>
</blockquote>
<p>FeignClient 也是类似的上下文:</p>
<blockquote>
<p>我们如果要调用一个服务的话,ServiceA,那么那个服务(ServiceA)就会关联一个独立的spring容器;关联着自己独立的一些组件,比如说独立的Logger组件,独立的Decoder组件,独立的Encoder组件;FeignContext则代表了一个独立的容器工厂,里面记录了每个服务对应的容器AnnotationConfigApplicationContext。</p>
<ul>
<li>因此,可以对不同的@FeignClient自定义不同的Configuration。</li>
</ul>
</blockquote>
<p><strong>FeignContext在哪里注入到Spring容器的?</strong>
FeignClient 位于 spring-cloud-openfeign-core 项目,我们在这个项目下结合 SpringBoot 自动装配的特性找 XxxAutoConfiguration 和 XxxConfiguration,最终找到 FeignAutoConfiguration。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011646192.png" alt="202403011646192"/></p>
<p>FeignAutoConfiguration中使用@Bean方法将FeignContext注入到Spring容器。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011649023.png" alt="202403011649023"/></p>
<p>FeignContext 继承自 NamedContextFactory,内部负责对每个服务都维护一个对应的spring容器(以map存储,一个服务对应一个spring容器),此处和 Ribbon 一样。</p>
<p>进入到 feign() 方法中,以获取 FeignLoggerFactory 为例:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011654599.png" alt="202403011654599"/></p>
<p>get(FeignContext context, Class type)方法要做的事情如下:</p>
<blockquote>
<ul>
<li>根据服务名称(ServiceA)去FeignContext里面去获取对应的FeignLoggerFactory;</li>
<li>其实就是根据ServiceA服务名称,先获取对应的spring容器,然后从那个spring容器中,获取自己独立的一个FeignLoggerFactory;</li>
</ul>
</blockquote>
<p>默认使用的 FeignLoggerFactory 是在 spring-cloud-openfeign-core 项目的 FeignClientsConfiguration 类中加载的 DefaultFeignLoggerFactory,而 DefaultFeignLoggerFactory 中默认创建的是Slf4jLogger。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011704244.png" alt="202403011704244"/></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011705898.png" alt="202403011705898"/></p>
<h5 id="从-feignclient-中获取-feignbuilder">从 FeignClient 中获取 Feign.Builder</h5>
<p>这里和上面获取 FeignLoggerFactory 一样,在 spring-cloud-openfeign-core 项目的 FeignClientsConfiguration 类中会找到两个 Feign.Builder(一个和 Hystrix 相关,另外一个 Retryer 相关的(请求超时,失败重试))的注册逻辑:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011729059.png" alt="202403011729059"/></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011731270.png" alt="202403011731270"/></p>
<p>由于默认 feign.hystrix.enabled 属性为 false,所以默认注入的 Feign.Builder 是 Feign.builder().retryer(retryer)。</p>
<h5 id="处理配置信息">处理配置信息</h5>
<p>回到 feign() 方法,其中调用的 <code>configureFeign(context, builder)</code> 方法负责处理 Feign 的相关配置(即: 使用 application.yml 中配置的参数,来设置 Feign.Builder)。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403011745579.png" alt="202403011745579"/></p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> void</span><span style="color:#B392F0"> configureFeign</span><span style="color:#E1E4E8">(FeignContext context, Feign.Builder builder) {</span></span>
<span class="line"><span style="color:#E1E4E8">    FeignClientProperties properties </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (FeignClientProperties)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.applicationContext.</span><span style="color:#B392F0">getBean</span><span style="color:#E1E4E8">(FeignClientProperties.class);</span></span>
<span class="line"><span style="color:#E1E4E8">    FeignClientConfigurer feignClientConfigurer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (FeignClientConfigurer)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getOptional</span><span style="color:#E1E4E8">(context, FeignClientConfigurer.class);</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">setInheritParentContext</span><span style="color:#E1E4E8">(feignClientConfigurer.</span><span style="color:#B392F0">inheritParentConfiguration</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (properties </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#F97583"> &amp;&amp;</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.inheritParentContext) {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (properties.</span><span style="color:#B392F0">isDefaultToProperties</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#79B8FF">            this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">configureUsingConfiguration</span><span style="color:#E1E4E8">(context, builder);</span></span>
<span class="line"><span style="color:#6A737D">            // 读取 application.yml 文件中针对所有服务 default 的配置</span></span>
<span class="line"><span style="color:#79B8FF">            this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">configureUsingProperties</span><span style="color:#E1E4E8">((FeignClientProperties.FeignClientConfiguration)properties.</span><span style="color:#B392F0">getConfig</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(properties.</span><span style="color:#B392F0">getDefaultConfig</span><span style="color:#E1E4E8">()), builder);</span></span>
<span class="line"><span style="color:#6A737D">            // 读取 application.yml 文件中针对当前服务的配置</span></span>
<span class="line"><span style="color:#79B8FF">            this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">configureUsingProperties</span><span style="color:#E1E4E8">((FeignClientProperties.FeignClientConfiguration)properties.</span><span style="color:#B392F0">getConfig</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.contextId), builder);</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">            this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">configureUsingProperties</span><span style="color:#E1E4E8">((FeignClientProperties.FeignClientConfiguration)properties.</span><span style="color:#B392F0">getConfig</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(properties.</span><span style="color:#B392F0">getDefaultConfig</span><span style="color:#E1E4E8">()), builder);</span></span>
<span class="line"><span style="color:#79B8FF">            this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">configureUsingProperties</span><span style="color:#E1E4E8">((FeignClientProperties.FeignClientConfiguration)properties.</span><span style="color:#B392F0">getConfig</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.contextId), builder);</span></span>
<span class="line"><span style="color:#79B8FF">            this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">configureUsingConfiguration</span><span style="color:#E1E4E8">(context, builder);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">configureUsingConfiguration</span><span style="color:#E1E4E8">(context, builder);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>**逻辑解析: **</p>
<blockquote>
<ol>
<li>FeignClientProperties是针对FeignClient的配置;</li>
<li>先读取application.yml中的feign.client打头的一些参数,包括了connectionTimeout,readTimeout之类的参数;如果application.yml中没有配置feign.client相关参数,则使用默认配置(Retryer retryer,ErrorDecoder,Request.Options等);</li>
<li>然后读取application.yml中针对当前要调用服务的配置。</li>
</ol>
<p>所以如果在 application.yml 文件中同时配置了针对全部服务和单个服务的配置,则针对单个服务的配置优先级更高,因为在代码解析中它是放在后面解析的,会覆盖前面解析的内容。</p>
</blockquote>
<h5 id="使用-feignbuilder-构建出一个-feignclient">使用 Feign.Builder 构建出一个 FeignClient</h5>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403041111641.png" alt="202403041111641"/></p>
<p>如果在 @FeignClient 上,没有配置 url 属性,也就是没有指定服务的 url 地址,那么 Feign 就会自动跟 Ribbon 关联起来,采用 Ribbon 来进行负载均衡,直接拿出 @FeignClient 中配置的 name() 为 Ribbon 准备对应的 url 地址: <code>http://ServiceA</code>。</p>
<p>此外如果在 @FeignClient 注解中配置了 <code>path 属性</code>,就表示要访问的是这个 ServiceA 服务的莫一类接口,比如: @FeignClient(value=“ServiceA”, path=“/user”),在拼接请求 URL 地址的时候,就会拼接成: <code>http://ServiceA/user</code>。</p>
<p><code>FeignClientFactoryBean#loadBalance()</code> 方法是一个基于 Ribbon 进行负载均衡的 FeignClient 动态代理生成方法:</p>
<blockquote>
<p>入参:</p>
<ol>
<li>Feign.Builder builder —&gt; FeignClient构造器</li>
<li>FeignContext context —&gt; Feign上下文</li>
<li>HardCodedTarget&lt;T&gt; target,target是一个HardCodedTarget,硬编码的Target,里面包含了接口类型(com.zhss.service.ServiceAClient),服务名称(ServiceA),url地址(<a href="http://ServiceA">http://ServiceA</a>)</li>
</ol>
</blockquote>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> &lt;</span><span style="color:#E1E4E8">T</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> T </span><span style="color:#B392F0">loadBalance</span><span style="color:#E1E4E8">(Feign.Builder builder, FeignContext context, Target.HardCodedTarget</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">T</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> target) {</span></span>
<span class="line"><span style="color:#E1E4E8">    Client client </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Client)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getOptional</span><span style="color:#E1E4E8">(context, Client.class);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (client </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        builder.</span><span style="color:#B392F0">client</span><span style="color:#E1E4E8">(client);</span></span>
<span class="line"><span style="color:#E1E4E8">        Targeter targeter </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Targeter)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(context, Targeter.class);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> targeter.</span><span style="color:#B392F0">target</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, builder, context, target);</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> IllegalStateException</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-netflix-ribbon?&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p><code>loadBalance()</code> 方法中首先会获取 Client 和 Targeter:</p>
<ul>
<li>通过 <code>Client client = getOptional(context, Client.class)</code> 方法获取 Client,返回的是 <code>LoadBalancerFeignClient</code>,(高版本是 FeignBlockingLoadBalancerClient)</li>
<li>通过 <code>Targeter targeter = get(context, Targeter.class)</code> 方法获取 Targeter: ,返回的是 <code>HystrixTargeter</code></li>
</ul>
<h6 id="loadbalancerfeignclient-在哪里注入到-spring-容器">LoadBalancerFeignClient 在哪里注入到 Spring 容器</h6>
<p>进入到 LoadBalancerFeignClient 类中看哪里调用了它唯一一个构造函数</p>
<p>找到 LoadBalancerFeignClient 有三个地方调用了它的构造函数,new 了一个实例:</p>
<ul>
<li>DefaultFeignLoadBalancedConfiguration</li>
<li>HttpClientFeignLoadBalancedConfiguration</li>
<li>OkHttpFeignLoadBalancedConfiguration</li>
</ul>
<p>再结合默认的配置,只有 DefaultFeignLoadBalancedConfiguration 中的 Client 符合条件装配</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Configuration</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#79B8FF">    proxyBeanMethods</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> false</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> DefaultFeignLoadBalancedConfiguration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    DefaultFeignLoadBalancedConfiguration</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Bean</span></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">ConditionalOnMissingBean</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> Client </span><span style="color:#B392F0">feignClient</span><span style="color:#E1E4E8">(CachingSpringLoadBalancerFactory </span><span style="color:#FFAB70">cachingFactory</span><span style="color:#E1E4E8">, SpringClientFactory </span><span style="color:#FFAB70">clientFactory</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> LoadBalancerFeignClient</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#E1E4E8"> Client.</span><span style="color:#B392F0">Default</span><span style="color:#E1E4E8">((SSLSocketFactory)</span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">, (HostnameVerifier)</span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">), cachingFactory, clientFactory);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>可以通过引入 Apache HttpClient 的 Maven 依赖使用 HttpClientFeignLoadBalancedConfiguration,或引入 OkHttpClient 的 Maven 依赖并在 application.yml 文件中指定 feign.okhttp.enabled 属性为 true 使用 OkHttpFeignLoadBalancedConfiguration。</p>
<h6 id="hystrixtargeter-在哪里注入到-spring-容器">HystrixTargeter 在哪里注入到 Spring 容器</h6>
<p>在 <code>FeignAutoConfiguration</code> 类中可以找到 Targeter 注入到 Spring 容器的逻辑</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Configuration</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#79B8FF">    proxyBeanMethods</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> false</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">ConditionalOnMissingClass</span><span style="color:#E1E4E8">({</span><span style="color:#9ECBFF">&quot;feign.hystrix.HystrixFeign&quot;</span><span style="color:#E1E4E8">})</span></span>
<span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> static</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> DefaultFeignTargeterConfiguration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    protected</span><span style="color:#B392F0"> DefaultFeignTargeterConfiguration</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Bean</span></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">ConditionalOnMissingBean</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> Targeter </span><span style="color:#B392F0">feignTargeter</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> DefaultTargeter</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Configuration</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#79B8FF">    proxyBeanMethods</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> false</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">ConditionalOnClass</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#79B8FF">    name</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">&quot;feign.hystrix.HystrixFeign&quot;</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">protected</span><span style="color:#F97583"> static</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> HystrixFeignTargeterConfiguration</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    protected</span><span style="color:#B392F0"> HystrixFeignTargeterConfiguration</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Bean</span></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">ConditionalOnMissingBean</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> Targeter </span><span style="color:#B392F0">feignTargeter</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> HystrixTargeter</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<blockquote>
<p>默认是创建 HystrixTargeter:</p>
<ol>
<li>如果有 feign.hystrix.HystrixFeign 这个类的话,那么就会构造一个 HystrixTargeter 出来</li>
<li>如果没有 feign.hystrix.HystrixFeign 这个类的话,那么就会构造一个 DefaultTargeter 出来</li>
</ol>
</blockquote>
<p>HystrixTargeter 是用来让 Feign 和 Hystrix 整合使用的,在发送请求的时候可以基于 Hystrix 实现熔断,限流,降级。</p>
<ul>
<li>生产环境如果启用 <code>feign.hystrix.HystrixFeign</code>,则 Feign.Builder 也会变成 HystrixFeign.Builder,默认还是 Feign 自己的 Feign.Builder。</li>
</ul>
<h6 id="hystrixtargetertarget方法">HystrixTargeter#target()方法</h6>
<p>继续往下走,进入到 <code>HystrixTargeter#target()</code> 方法,具体代码执行流程如下:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403041658903.png" alt="202403041658903"/></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403041659749.png" alt="202403041659749"/></p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> Feign </span><span style="color:#B392F0">build</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    Client client </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Client)Capability.</span><span style="color:#B392F0">enrich</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.client, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.capabilities);</span></span>
<span class="line"><span style="color:#E1E4E8">    Retryer retryer </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Retryer)Capability.</span><span style="color:#B392F0">enrich</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.retryer, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.capabilities);</span></span>
<span class="line"><span style="color:#6A737D">    // 获取所有的 RequestInterceptor</span></span>
<span class="line"><span style="color:#E1E4E8">    List&lt;</span><span style="color:#F97583">RequestInterceptor</span><span style="color:#E1E4E8">&gt; requestInterceptors </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (List)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.requestInterceptors.</span><span style="color:#B392F0">stream</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">((ri) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> (RequestInterceptor)Capability.</span><span style="color:#B392F0">enrich</span><span style="color:#E1E4E8">(ri, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.capabilities);</span></span>
<span class="line"><span style="color:#E1E4E8">    }).</span><span style="color:#B392F0">collect</span><span style="color:#E1E4E8">(Collectors.</span><span style="color:#B392F0">toList</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    Logger logger </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Logger)Capability.</span><span style="color:#B392F0">enrich</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.logger, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.capabilities);</span></span>
<span class="line"><span style="color:#E1E4E8">    Contract contract </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Contract)Capability.</span><span style="color:#B392F0">enrich</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.contract, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.capabilities);</span></span>
<span class="line"><span style="color:#E1E4E8">    Request.Options options </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Request.Options)Capability.</span><span style="color:#B392F0">enrich</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.options, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.capabilities);</span></span>
<span class="line"><span style="color:#E1E4E8">    Encoder encoder </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Encoder)Capability.</span><span style="color:#B392F0">enrich</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.encoder, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.capabilities);</span></span>
<span class="line"><span style="color:#E1E4E8">    Decoder decoder </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (Decoder)Capability.</span><span style="color:#B392F0">enrich</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.decoder, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.capabilities);</span></span>
<span class="line"><span style="color:#E1E4E8">    InvocationHandlerFactory invocationHandlerFactory </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (InvocationHandlerFactory)Capability.</span><span style="color:#B392F0">enrich</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.invocationHandlerFactory, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.capabilities);</span></span>
<span class="line"><span style="color:#E1E4E8">    QueryMapEncoder queryMapEncoder </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (QueryMapEncoder)Capability.</span><span style="color:#B392F0">enrich</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.queryMapEncoder, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.capabilities);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 将 FeignClient 的一些信息放到 Handler 中</span></span>
<span class="line"><span style="color:#E1E4E8">    SynchronousMethodHandler.Factory synchronousMethodHandlerFactory </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> SynchronousMethodHandler.</span><span style="color:#B392F0">Factory</span><span style="color:#E1E4E8">(client, retryer, requestInterceptors, logger, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.logLevel, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.decode404, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.closeAfterDecode, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.propagationPolicy, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.forceDecoding);</span></span>
<span class="line"><span style="color:#E1E4E8">    ReflectiveFeign.ParseHandlersByName handlersByName </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> ReflectiveFeign.</span><span style="color:#B392F0">ParseHandlersByName</span><span style="color:#E1E4E8">(contract, options, encoder, decoder, queryMapEncoder, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.errorDecoder, synchronousMethodHandlerFactory);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // ReflectiveFeign 负责生成动态代理类</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> ReflectiveFeign</span><span style="color:#E1E4E8">(handlersByName, invocationHandlerFactory, queryMapEncoder);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p><code>Feign#target()</code> 方法中主要做两件事:</p>
<ol>
<li>build() 方法将Feign.Builder 中所有东西集成在一起,构建成一个 ReflectiveFeign</li>
<li>ReflectiveFeign#newInstance() 方法负责生成动态代理</li>
</ol>
<h6 id="reflectivefeignnewinstance生成动态代理类">ReflectiveFeign#newInstance()生成动态代理类</h6>
<p>ReflectiveFeign#newInstance() 源码如下</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> &lt;</span><span style="color:#E1E4E8">T</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> T </span><span style="color:#B392F0">newInstance</span><span style="color:#E1E4E8">(Target</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">T</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> target) {</span></span>
<span class="line"><span style="color:#6A737D">    // 基于我们配置的Contract,Encoder等一堆组件,加上Target对象(知道是ServiceAClient接口),去进行接口的所有spring mvc注解的解析,以及接口中各个方法的一些解析,获取了这个接口中有哪些方法</span></span>
<span class="line"><span style="color:#E1E4E8">    Map&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">MethodHandler</span><span style="color:#E1E4E8">&gt; nameToHandler </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> targetToHandlersByName.</span><span style="color:#B392F0">apply</span><span style="color:#E1E4E8">(target);</span></span>
<span class="line"><span style="color:#E1E4E8">    Map&lt;</span><span style="color:#F97583">Method</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">MethodHandler</span><span style="color:#E1E4E8">&gt; methodToHandler </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> LinkedHashMap&lt;</span><span style="color:#F97583">Method</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">MethodHandler</span><span style="color:#E1E4E8">&gt;();</span></span>
<span class="line"><span style="color:#E1E4E8">    List&lt;</span><span style="color:#F97583">DefaultMethodHandler</span><span style="color:#E1E4E8">&gt; defaultMethodHandlers </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> LinkedList&lt;</span><span style="color:#F97583">DefaultMethodHandler</span><span style="color:#E1E4E8">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 遍历ServiceAClient接口中的每个方法</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (Method method </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> target.</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">getMethods</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (method.</span><span style="color:#B392F0">getDeclaringClass</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> Object.class) {</span></span>
<span class="line"><span style="color:#F97583">            continue</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (Util.</span><span style="color:#B392F0">isDefault</span><span style="color:#E1E4E8">(method)) {</span></span>
<span class="line"><span style="color:#E1E4E8">            DefaultMethodHandler handler </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> DefaultMethodHandler</span><span style="color:#E1E4E8">(method);</span></span>
<span class="line"><span style="color:#E1E4E8">            defaultMethodHandlers.</span><span style="color:#B392F0">add</span><span style="color:#E1E4E8">(handler);</span></span>
<span class="line"><span style="color:#E1E4E8">            methodToHandler.</span><span style="color:#B392F0">put</span><span style="color:#E1E4E8">(method, handler);</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">            // 将ServiceAClient接口中的每个方法,加上对应的nameToHandler中存放的对应的SynchronousMethodHandler(异步化的方法代理处理组件),放到一个map中去</span></span>
<span class="line"><span style="color:#E1E4E8">            methodToHandler.</span><span style="color:#B392F0">put</span><span style="color:#E1E4E8">(method, nameToHandler.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(Feign.</span><span style="color:#B392F0">configKey</span><span style="color:#E1E4E8">(target.</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">(), method)));</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // JDK动态代理)基于一个factory工厂,创建了一个InvocationHandler</span></span>
<span class="line"><span style="color:#E1E4E8">    InvocationHandler handler </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> factory.</span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">(target, methodToHandler);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 基于JDK的动态代理,创建出来了一个动态代理类: Proxy,其实现ServiceAClient接口</span></span>
<span class="line"><span style="color:#6A737D">    // new Class&lt;?&gt;[]{target.type()},这个就是ServiceAClient接口</span></span>
<span class="line"><span style="color:#6A737D">    // InvocationHandler: 对上面proxy动态代理类所有方法的调用,都会走这个InvocationHandler的拦截方法,由这个InvocationHandler中的一个方法来提供所有方法的一个实现的逻辑</span></span>
<span class="line"><span style="color:#E1E4E8">    T proxy </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (T) Proxy.</span><span style="color:#B392F0">newProxyInstance</span><span style="color:#E1E4E8">(target.</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">getClassLoader</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#F97583">        new</span><span style="color:#E1E4E8"> Class&lt;</span><span style="color:#F97583">?</span><span style="color:#E1E4E8">&gt;[] {target.</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">()}, handler);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // 上述代码段中,就是 JDK 动态代理的体现,动态生成一个没有名字的匿名类,这个类实现了 ServiceAClient(FeignClient)接口,基于这个匿名类创建一个对象(T proxy),这就是所谓的动态代理,后续所有对这个 T proxy 对象所有接口方法的调用,都会交给 InvocationHandler 处理,此处的 InvocationHandler 是 ReflectiveFeign 的内部类 FeignInvocationHandler</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (DefaultMethodHandler defaultMethodHandler </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> defaultMethodHandlers) {</span></span>
<span class="line"><span style="color:#E1E4E8">        defaultMethodHandler.</span><span style="color:#B392F0">bindTo</span><span style="color:#E1E4E8">(proxy);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> proxy;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>方法中有两个Map类型的局部变量: nameToHandler,methodToHandler:</p>
<blockquote>
<ol>
<li>nameToHandler 释义: 接口中的每个方法的名称,对应一个处理这个方法的SynchronousMethodHandler;由ReflectiveFeign的内部类ParseHandlersByName的apply(target)方法获取。</li>
<li>methodToHandler 释义: 接口中的每个方法(Method对象),对应一个处理这个方法的SynchronousMethodHandler;</li>
</ol>
</blockquote>
<h6 id="parsehandlersbynameapply解析feignclient中的方法">ParseHandlersByName#apply()解析FeignClient中的方法</h6>
<p><code>ParseHandlersByName#apply()</code> 方法会对我们定义的 ServiceAClient 接口进行解析,解析里面有哪些方法,然后为每个方法创建一个 SynchronousMethodHandler 出来,也就是说某个 SynchronousMethodHandler 专门用来处理那个方法的请求调用。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> Map</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">String, MethodHandler</span><span style="color:#F97583">&gt;</span><span style="color:#B392F0"> apply</span><span style="color:#E1E4E8">(Target target) {</span></span>
<span class="line"><span style="color:#E1E4E8">    List&lt;</span><span style="color:#F97583">MethodMetadata</span><span style="color:#E1E4E8">&gt; metadata </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> contract.</span><span style="color:#B392F0">parseAndValidateMetadata</span><span style="color:#E1E4E8">(target.</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    Map&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">MethodHandler</span><span style="color:#E1E4E8">&gt; result </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> LinkedHashMap&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">MethodHandler</span><span style="color:#E1E4E8">&gt;();</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (MethodMetadata md </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> metadata) {</span></span>
<span class="line"><span style="color:#E1E4E8">    BuildTemplateByResolvingArgs buildTemplate;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">md.</span><span style="color:#B392F0">formParams</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">isEmpty</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">&amp;&amp;</span><span style="color:#E1E4E8"> md.</span><span style="color:#B392F0">template</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">bodyTemplate</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        buildTemplate </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#F97583">            new</span><span style="color:#B392F0"> BuildFormEncodedTemplateFromArgs</span><span style="color:#E1E4E8">(md, encoder, queryMapEncoder, target);</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (md.</span><span style="color:#B392F0">bodyIndex</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        buildTemplate </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> BuildEncodedTemplateFromArgs</span><span style="color:#E1E4E8">(md, encoder, queryMapEncoder, target);</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        buildTemplate </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> BuildTemplateByResolvingArgs</span><span style="color:#E1E4E8">(md, queryMapEncoder, target);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (md.</span><span style="color:#B392F0">isIgnored</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">        result.</span><span style="color:#B392F0">put</span><span style="color:#E1E4E8">(md.</span><span style="color:#B392F0">configKey</span><span style="color:#E1E4E8">(), args </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> IllegalStateException</span><span style="color:#E1E4E8">(md.</span><span style="color:#B392F0">configKey</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">+</span><span style="color:#9ECBFF"> &quot; is not a method handled by feign&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        });</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        result.</span><span style="color:#B392F0">put</span><span style="color:#E1E4E8">(md.</span><span style="color:#B392F0">configKey</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#6A737D">            // 为每个方法创建对应的 MethodHandler</span></span>
<span class="line"><span style="color:#E1E4E8">            factory.</span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">(target, md, buildTemplate, options, decoder, errorDecoder));</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> result;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>其中 <code>factory.create</code> 会为所有标注了 SpringMvc 注解的方法都生成一个对应的 SynchronousMethodHandler。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> MethodHandler </span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">(Target</span><span style="color:#F97583">&lt;?&gt;</span><span style="color:#E1E4E8"> target,</span></span>
<span class="line"><span style="color:#6A737D">                            // 解析这个方法,针对这个方法生成一个 SynchronousMethodHandler</span></span>
<span class="line"><span style="color:#E1E4E8">                            MethodMetadata md,</span></span>
<span class="line"><span style="color:#E1E4E8">                            RequestTemplate.Factory buildTemplateFromArgs,</span></span>
<span class="line"><span style="color:#E1E4E8">                            Options options,</span></span>
<span class="line"><span style="color:#E1E4E8">                            Decoder decoder,</span></span>
<span class="line"><span style="color:#E1E4E8">                            ErrorDecoder errorDecoder) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> SynchronousMethodHandler</span><span style="color:#E1E4E8">(target, client, retryer, requestInterceptors, logger,</span></span>
<span class="line"><span style="color:#E1E4E8">        logLevel, md, buildTemplateFromArgs, options, decoder,</span></span>
<span class="line"><span style="color:#E1E4E8">        errorDecoder, decode404, closeAfterDecode, propagationPolicy, forceDecoding);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p><code>SpringMvcContract.parseAndValidateMetadata()</code> 方法负责解析 FeignClient 接口中每个标注了 SpringMvc 注解的方法,即: Feign 依靠 Contract 组件(SpringMvcContract)来解析接口上的 SpringMvc 注解。</p>
<blockquote>
<p>针对 FeignClient 接口中的每个标注了 springMVC 注解的方法都会被 springMvcContract 组件解析,针对每个方法最后都生成一个 MethodMetadata,代表方法的一些元数据,包括:</p>
<ol>
<li>方法的定义: 比如: <code>ServiceAClient#deleteUser(Long)</code></li>
<li>方法的返回类型: 比如: <code>class java.lang.String</code></li>
<li>发送 HTTP 请求的模版: 比如: <code>DELETE /user/{id} HTTP/1.1</code></li>
</ol>
</blockquote>
<h6 id="springmvccontract组件的工作原理">SpringMvcContract组件的工作原理</h6>
<p>看一下 <code>SpringMvcContract.parseAndValidateMetadata()</code> 如何解析 FeignClient 中的每个方法</p>
<p>以如下方法为例:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403041746106.png" alt="202403041746106"/></p>
<p>解析逻辑如下:</p>
<blockquote>
<ol>
<li>解析@RequestMapping注解,看看里面的method属性是什么?是GET/UPDATE/DELETE,然后在HTTP template里就加上GET/UPDATE/DELETE;(示例为DELETE)</li>
<li>找到接口上定义的@RequestMapping注解,解析里面的value值,拿到请求路径(/user),此时HTTP template变成: DELETE /user</li>
<li>再次解析deleteUser()方法上的@RequestMapping注解,找到里面的value,获取到 <code>/{id}</code>,拼接到HTTP template里去: <code>DELETE /user/{id}</code></li>
<li>接着硬编码拼死一个HTTP协议,http 1.1,HTTP template: <code>DELETE /user/{id} HTTP/1.1</code></li>
<li>indexToName: 解析@PathVariable注解,第一个占位符(index是0)要替换成方法入参里的id这个参数的值</li>
<li>假如后面来调用这个deleteUser()方法,传递进来的id = 1.那么此时就会拿出之前解析好的HTTP template: <code>DELETE /user/{id} HTTP/1.1</code>。然后用传递进来的id = 1替换掉第一个占位符的值,DELETE /user/1 HTTP/1.1</li>
</ol>
</blockquote>
<h3 id="openfeign处理http请求">OpenFeign处理HTTP请求</h3>
<h4 id="动态代理处理请求的入口">动态代理处理请求的入口</h4>
<p>我们知道所有对动态代理对象(T Proxy)的所有接口方法的调用,都会交给 <code>InvocationHandler</code> 来处理,此处的 <code>InvocationHandler</code> 是 <code>ReflectiveFeign</code> 的内部类 <code>FeignInvocationHandler</code>。针对 FeignClient 的每个方法都会对应一个 <code>SynchronousMethodHandler</code>。</p>
<p>以 <code>http://localhost:9090/ServiceB/user/sayHello/1?name=zhangsan&amp;age=18</code> 请求调用为例:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403051440325.png" alt="202403051440325"/></p>
<p>请求调用 ServiceBController 的 greeting() 方法后,要调用 ServiceAClient#sayHello() 方法时,请求会进到 ServiceAClient 的动态代理类,进而请求交给 ReflectiveFeign 的内部类 FeignInvocationHandler 来处理,在结合 JDK 动态代理的特性,方法会交给 invoke() 方法执行,所以动态代理处理请求的入口为: <code>ReflectiveFeign</code> 的内部类 <code>FeignInvocationHandler</code> 的 invoke() 方法:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403051446826.png" alt="202403051446826"/></p>
<p>方法逻辑:</p>
<blockquote>
<ol>
<li>针对父类 Object 的 equals,hashCode,toString 方法直接处理</li>
<li>其他方法则从 dispatch 中获取 Method 对应的 MethodHandler,然后将方法的执行交给 MethodHandler 来处理</li>
<li>dispatch 是一个以 Method 为 key,MethodHandler 为 value 的 Map 类型(Map&lt;Method, MethodHandler&gt;),其是在构建 FeignInvocationHandler 时,记录了每个 FeignClient 对应的所有方法 MethodHandler 的映射</li>
</ol>
</blockquote>
<p>invoke() 方法中通过方法名找到 Method 对应的 MethodHandler,这里的 MethodHandler 为 SynchronousMethodHandler,然后将 args 参数交给它来处理请求</p>
<h4 id="synchronousmethodhandler-处理请求机制">SynchronousMethodHandler 处理请求机制</h4>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">  public</span><span style="color:#E1E4E8"> Object </span><span style="color:#B392F0">invoke</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">Object</span><span style="color:#E1E4E8">[] argv) throws Throwable {</span></span>
<span class="line"><span style="color:#6A737D">    // 创建一个请求模版</span></span>
<span class="line"><span style="color:#E1E4E8">    RequestTemplate template </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> buildTemplateFromArgs.</span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">(argv);</span></span>
<span class="line"><span style="color:#E1E4E8">    Options options </span><span style="color:#F97583">=</span><span style="color:#B392F0"> findOptions</span><span style="color:#E1E4E8">(argv);</span></span>
<span class="line"><span style="color:#E1E4E8">    Retryer retryer </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.retryer.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    while</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">        // 执行请求并返回 decode 后的结果</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#B392F0"> executeAndDecode</span><span style="color:#E1E4E8">(template, options);</span></span>
<span class="line"><span style="color:#E1E4E8">      } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (RetryableException </span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">          retryer.</span><span style="color:#B392F0">continueOrPropagate</span><span style="color:#E1E4E8">(e);</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (RetryableException </span><span style="color:#FFAB70">th</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">          Throwable cause </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> th.</span><span style="color:#B392F0">getCause</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">          if</span><span style="color:#E1E4E8"> (propagationPolicy </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> UNWRAP </span><span style="color:#F97583">&amp;&amp;</span><span style="color:#E1E4E8"> cause </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#E1E4E8"> cause;</span></span>
<span class="line"><span style="color:#E1E4E8">          } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#E1E4E8"> th;</span></span>
<span class="line"><span style="color:#E1E4E8">          }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (logLevel </span><span style="color:#F97583">!=</span><span style="color:#E1E4E8"> Logger.Level.NONE) {</span></span>
<span class="line"><span style="color:#E1E4E8">          logger.</span><span style="color:#B392F0">logRetry</span><span style="color:#E1E4E8">(metadata.</span><span style="color:#B392F0">configKey</span><span style="color:#E1E4E8">(), logLevel);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        continue</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span></code></pre> </div> 
<p><code>SynchronousMethodHandler#invoke()</code> 方法中主要包括两大块: 创建请求模版,执行请求并返回 decode 后的结果。</p>
<p>这里的重试机制,其实就是依靠 Retryer#continueOrPropagate() 方法中对重试次数的判断,超过最大重试次数抛异常结束流程。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403051634061.png" alt="202403051634061"/></p>
<h5 id="创建请求模版springmvccontract-解析方法参数">创建请求模版(SpringMvcContract 解析方法参数)</h5>
<p>在上文中我们聊到会用 SpringMvcContract 解析Spring mvc 的注解,最终拿到方法的对应的请求(RequestTemplate)是 <code>GET /user/sayHello/{id} HTTP/1.1</code>,但是要生成一个可以访问的请求地址,需要再基于 SpringMvcContract 去解析 @RequestParam 注解,将方法的入参,绑定到 HTTP 请求参数里去,最终将请求处理为 <code>GET /user/sayHello/1?name=zhangsan&amp;age=18 HTTP/1.1</code></p>
<p>而 <code>RequestTemplate template = buildTemplateFromArgs.create(argv)</code> 负责做这个操作,ReflectiveFeign#create(Object[] argv):</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> RequestTemplate </span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">Object</span><span style="color:#E1E4E8">[] argv) {</span></span>
<span class="line"><span style="color:#6A737D">  // 获取 REST 请求模版</span></span>
<span class="line"><span style="color:#E1E4E8">  RequestTemplate mutable </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> RequestTemplate.</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(metadata.</span><span style="color:#B392F0">template</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">  mutable.</span><span style="color:#B392F0">feignTarget</span><span style="color:#E1E4E8">(target);</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (metadata.</span><span style="color:#B392F0">urlIndex</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> urlIndex </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> metadata.</span><span style="color:#B392F0">urlIndex</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#B392F0">    checkArgument</span><span style="color:#E1E4E8">(argv[urlIndex] </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&quot;URI parameter %s was null&quot;</span><span style="color:#E1E4E8">, urlIndex);</span></span>
<span class="line"><span style="color:#E1E4E8">    mutable.</span><span style="color:#B392F0">target</span><span style="color:#E1E4E8">(String.</span><span style="color:#B392F0">valueOf</span><span style="color:#E1E4E8">(argv[urlIndex]));</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">  Map&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">Object</span><span style="color:#E1E4E8">&gt; varBuilder </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> LinkedHashMap&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">Object</span><span style="color:#E1E4E8">&gt;();</span></span>
<span class="line"><span style="color:#6A737D">  // 遍历 REST 请求要调用方法标记了 springmvc 注解的参数</span></span>
<span class="line"><span style="color:#F97583">  for</span><span style="color:#E1E4E8"> (Entry&lt;</span><span style="color:#F97583">Integer</span><span style="color:#E1E4E8">, Collection&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">&gt;&gt; entry </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> metadata.</span><span style="color:#B392F0">indexToName</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">entrySet</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> entry.</span><span style="color:#B392F0">getKey</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    Object value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> argv[entry.</span><span style="color:#B392F0">getKey</span><span style="color:#E1E4E8">()];</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (value </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) { </span><span style="color:#6A737D">// Null values are skipped.</span></span>
<span class="line"><span style="color:#6A737D">      // 使用 SpringMvcContract 解析出方法参数对应的 value 值</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (indexToExpander.</span><span style="color:#B392F0">containsKey</span><span style="color:#E1E4E8">(i)) {</span></span>
<span class="line"><span style="color:#E1E4E8">        value </span><span style="color:#F97583">=</span><span style="color:#B392F0"> expandElements</span><span style="color:#E1E4E8">(indexToExpander.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(i), value);</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#F97583">      for</span><span style="color:#E1E4E8"> (String name </span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> entry.</span><span style="color:#B392F0">getValue</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">        varBuilder.</span><span style="color:#B392F0">put</span><span style="color:#E1E4E8">(name, value);</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // 构建出完整的 REST 请求</span></span>
<span class="line"><span style="color:#E1E4E8">  RequestTemplate template </span><span style="color:#F97583">=</span><span style="color:#B392F0"> resolve</span><span style="color:#E1E4E8">(argv, mutable, varBuilder);</span></span>
<span class="line"><span style="color:#6A737D">  // 处理表单内容</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (metadata.</span><span style="color:#B392F0">queryMapIndex</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">    // add query map parameters after initial resolve so that they take</span></span>
<span class="line"><span style="color:#6A737D">    // precedence over any predefined values</span></span>
<span class="line"><span style="color:#E1E4E8">    Object value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> argv[metadata.</span><span style="color:#B392F0">queryMapIndex</span><span style="color:#E1E4E8">()];</span></span>
<span class="line"><span style="color:#E1E4E8">    Map&lt;</span><span style="color:#F97583">String</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">Object</span><span style="color:#E1E4E8">&gt; queryMap </span><span style="color:#F97583">=</span><span style="color:#B392F0"> toQueryMap</span><span style="color:#E1E4E8">(value);</span></span>
<span class="line"><span style="color:#E1E4E8">    template </span><span style="color:#F97583">=</span><span style="color:#B392F0"> addQueryMapQueryParameters</span><span style="color:#E1E4E8">(queryMap, template);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // 处理请求头内容</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (metadata.</span><span style="color:#B392F0">headerMapIndex</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    template </span><span style="color:#F97583">=</span></span>
<span class="line"><span style="color:#B392F0">        addHeaderMapHeaders</span><span style="color:#E1E4E8">((Map</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">String, Object</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8">) argv[metadata.</span><span style="color:#B392F0">headerMapIndex</span><span style="color:#E1E4E8">()], template);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> template;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>以解析 <code>@PathVariable(&quot;id&quot;) Long id</code> 为例,SpringMvcContract 解析逻辑如下:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403051717607.png" alt="202403051717607"/></p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">private</span><span style="color:#E1E4E8"> Object </span><span style="color:#B392F0">expandElements</span><span style="color:#E1E4E8">(Expander expander, Object value) {</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (value </span><span style="color:#F97583">instanceof</span><span style="color:#E1E4E8"> Iterable) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> expandIterable</span><span style="color:#E1E4E8">(expander, (Iterable) value);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> expander.</span><span style="color:#B392F0">expand</span><span style="color:#E1E4E8">(value);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403051723717.png" alt="202403051723717"/></p>
<p>最后解析出 <code>@PathVariable(&quot;id&quot;) Long id</code> 对应的值为 1,然后将所有的标注了 SpringMVC 注解的参数都解析完之后,将参数名和对应的 value 值放到一个命名为 <code>varBuilder</code> 的 Map 中:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403051728793.png" alt="202403051728793"/></p>
<p>接着需要根据 varBuilder 的内容构建出一个完整的 REST 请求(即: 将 SpringMVC 注解标注的参数全部用 value 值替换,添加到请求中)</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403051736823.png" alt="202403051736823"/></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403051744919.png" alt="202403051744919"/></p>
<p><code>RequestTemplate resolve(Map&lt;String, ?&gt; variables)</code> 中负责解析并构建完整的 RequestTemplate,进到方法中的 urlTemplate 为 <code>/user/sayHello/{id}</code>,variables 为上面的 varBuilder: <code>{&quot;id&quot;:1,&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:18}</code>。</p>
<p>方法中首先将 <code>&quot;id&quot;:1</code> 替换 <code>urlTemplate(/user/sayHello/{id})</code> 中的 <code>{id}</code>,得出 expanded 为 <code>/user/sayHello/1</code>,然后再将查询参数 <code>&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:18</code> 拼接到请求中,得到最终的 URL 为: <code>/user/sayHello/1?name=zhangsan&amp;age=18</code>,返回的 RequestTemplate 内容为:</p>
<p><code>buildTemplateFromArgs.create(argv)</code> 方法执行完成之后,得到一个完整的 RequestTemplate,下面需要基于这个 RequestTemplate 来执行请求。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403051758648.png" alt="202403051758648"/></p>
<h5 id="执行请求并解码返回值">执行请求并解码返回值</h5>
<p><code>SynchronousMethodHandler#executeAndDecode(RequestTemplate, Options)</code> 方法负责执行请求并解码返回值,具体执行逻辑如下:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403051804120.png" alt="202403051804120"/></p>
<p>方法中主要做三件事: 应用所有的 RequestInterceptor(即执行 RequestInterceptor#apply()方法),通过 LoadBalancerFeignClient 做负载均衡执行请求,使用 Decoder 对请求返回结果解码或处理返回结果。</p>
<p>下面分开来看</p>
<h6 id="应用所有的-requestinterceptor">应用所有的 RequestInterceptor</h6>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403051813337.png" alt="202403051813337"/></p>
<p>遍历所有的请求拦截器 <code>RequestInterceptor</code>,将每个请求拦截器都应用到 RequestTemplate 请求模版上面去,也就是让每个请求拦截器都对请求进行处理(调用拦截器的 apply(RequestTemplate)方法)。</p>
<blockquote>
<ul>
<li>其实这里本质上就是基于 RequestTemplate,创建一个Request</li>
<li>Request 是基于之前的 HardCodedTarget(包含了目标请求服务信息的一个 Target,服务名也在其中),处理 RequestTemplate,生成一个 Request</li>
</ul>
</blockquote>
<p>应用完所有的 RequestInterceptor 之后,如果 Feign 日志的隔离级别不等于 <code>Logger.Level.NONE</code>,则打印即将要发送的 Request 请求日志;
打印完请求日志之后,会通过 <code>SynchronousMethodHandler</code> 中的成员 Client 来执行请求,对于 OpenFeign 旧版而言,Client 是 <code>LoadBalancerFeignClient</code>。</p>
<h6 id="loadbalancerfeignclient-负载均衡执行请求详述">LoadBalancerFeignClient 负载均衡执行请求详述</h6>
<p>基于 LoadBalancerFeignClient 完成了请求的处理和发送,这里肯定是将 HTTP 请求发送到对应 server 的某个实例上去,同时获取到 Response 响应。</p>
<p><code>LoadBalancerFeignClient#execute()</code> 方法处理逻辑:</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> Response </span><span style="color:#B392F0">execute</span><span style="color:#E1E4E8">(Request request, Request.Options options) throws IOException {</span></span>
<span class="line"><span style="color:#F97583">  try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // 将请求的 url 封装成 URI</span></span>
<span class="line"><span style="color:#E1E4E8">    URI asUri </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> URI.</span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">(request.</span><span style="color:#B392F0">url</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#6A737D">    // 获取要请求的服务名</span></span>
<span class="line"><span style="color:#E1E4E8">    String clientName </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> asUri.</span><span style="color:#B392F0">getHost</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // 从 URI 中剔除服务名</span></span>
<span class="line"><span style="color:#E1E4E8">    URI uriWithoutHost </span><span style="color:#F97583">=</span><span style="color:#B392F0"> cleanUrl</span><span style="color:#E1E4E8">(request.</span><span style="color:#B392F0">url</span><span style="color:#E1E4E8">(), clientName);</span></span>
<span class="line"><span style="color:#6A737D">    // 将请求封装为 RibbonRequest</span></span>
<span class="line"><span style="color:#E1E4E8">    FeignLoadBalancer.RibbonRequest ribbonRequest </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> FeignLoadBalancer.</span><span style="color:#B392F0">RibbonRequest</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.delegate, request, uriWithoutHost);</span></span>
<span class="line"><span style="color:#6A737D">    // 将 options 封装为请求配置传给 Ribbon</span></span>
<span class="line"><span style="color:#E1E4E8">    IClientConfig requestConfig </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getClientConfig</span><span style="color:#E1E4E8">(options, clientName);</span></span>
<span class="line"><span style="color:#6A737D">    // 通过集成的 Ribbon 执行请求</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> ((FeignLoadBalancer.RibbonResponse)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">lbClient</span><span style="color:#E1E4E8">(clientName).</span><span style="color:#B392F0">executeWithLoadBalancer</span><span style="color:#E1E4E8">(ribbonRequest, requestConfig)).</span><span style="color:#B392F0">toResponse</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (ClientException </span><span style="color:#FFAB70">var8</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    IOException io </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">findIOException</span><span style="color:#E1E4E8">(var8);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (io </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      throw</span><span style="color:#E1E4E8"> io;</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> RuntimeException</span><span style="color:#E1E4E8">(var8);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>方法逻辑解析:</p>
<blockquote>
<ol>
<li>首先将请求的url封装成一个URI,然后从请求URL地址中,获取到要访问的服务名称clientName(示例为ServiceA)</li>
<li>然后将请求URI中的服务名称剔除,比如这里的 &lt;<a href="http://Service-A/user/sayHello/">http://Service-A/user/sayHello/</a>&gt; 变为 http:///user/sayHello/</li>
<li>接着基于去除了服务名称的uri地址,创建了一个适用于Ribbon的请求(FeignLoadBalancer.RibbonRequest)</li>
<li>根据服务名从SpringClientFactory(Feign上下文)中获取Ribbon相关的配置IClientConfig,比如(连接超时时间,读取数据超时时间),如果获取不到,则创建一个FeignOptionsClientConfig</li>
<li>最后根据服务名从CachingSpringLoadBalancerFactory获取对应的FeignLoadBalancer;在FeignLoadBalancer里封装了ribbon的ILoadBalancer</li>
</ol>
</blockquote>
<p>既然Feign中集成了Ribbon,那它们是怎么整合到一起的?FeignLoadBalancer中用了Ribbon的那个ILoadBalancer?Feign如何使用Ribbon进行负载均衡?最终发送出去的请求URI是什么样的?</p>
<p><strong>1&gt; Feign 是如何和 Ribbon,eureka 整合在一起的?FeignLoadBalancer 中用了 Ribbon 的那个 ILoadBalancer?</strong></p>
<ol>
<li>
<p>FeignLoadBalancer中用了Ribbon的那个ILoadBalancer?</p>
<p>FeignLoadBalancer的类继承结构如下:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403061818220.png" alt="202403061818220"/></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403061819814.png" alt="202403061819814"/></p>
<p>FeignLoadBalancer间接继承自LoadBalancerContext,LoadBalancerContext中有一个ILoadBalancer类型的成员,其就是FeignLoadBalancer中集成的Ribbon的ILoadBalancer。从代码执行流程来看,集成的ILoadBalancer为Ribbon默认的ZoneAwareLoadBalancer:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403061830279.png" alt="202403061830279"/></p>
<p>到这里,可以看到根据服务名获取到的FeignLoadBalancer中组合了Ribbon的ZoneAwareLoadBalancer负载均衡器。</p>
</li>
<li>
<p>Ribbon和Eureka的集成?
RibbonClientConfiguration#ribbonLoadBalancer</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">Bean</span></span>
<span class="line"><span style="color:#E1E4E8">@</span><span style="color:#F97583">ConditionalOnMissingBean</span></span>
<span class="line"><span style="color:#6A737D">// serverList: 服务实例列表信息</span></span>
<span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> ILoadBalancer </span><span style="color:#B392F0">ribbonLoadBalancer</span><span style="color:#E1E4E8">(IClientConfig config, ServerList</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">Server</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> serverList, ServerListFilter</span><span style="color:#F97583">&lt;</span><span style="color:#E1E4E8">Server</span><span style="color:#F97583">&gt;</span><span style="color:#E1E4E8"> serverListFilter, IRule rule, IPing ping, ServerListUpdater serverListUpdater) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> (ILoadBalancer)(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.propertiesFactory.</span><span style="color:#B392F0">isSet</span><span style="color:#E1E4E8">(ILoadBalancer.class, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.name)</span></span>
<span class="line"><span style="color:#F97583">    ?</span><span style="color:#E1E4E8"> (ILoadBalancer)</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.propertiesFactory.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(ILoadBalancer.class, config, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.name)</span></span>
<span class="line"><span style="color:#F97583">    :</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> ZoneAwareLoadBalancer</span><span style="color:#E1E4E8">(config, rule, ping, serverList, serverListFilter, serverListUpdater));</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>Ribbon自己和Eureka集成的流程: Ribbon的配置类RibbonClientConfiguration,会初始化ZoneAwareLoadBalancer并将其注入到Spring容器;ZoneAwareLoadBalancer内部持有跟eureka进行整合的DomainExtractingServerList(Eureka和Ribbon集成的配置类EurekaRibbonClientConfiguration(spring-cloud-netflix-eureka-client项目下)中负责将其注入到Spring容器),nacos 和 ribbon 集成的配置类 NacosRibbonClientConfiguration。</p>
<p>小结:
在spring boot启动,要去获取一个ribbon的ILoadBalancer的时候,会去从那个服务对应的一个独立的spring容器(Ribbon子上下文)中获取;获取到一个服务对应的ZoneAwareLoadBalancer,其中组合了DomainExtractingServerList,DomainExtractingServerList自己会去eureka的注册表里去拉取服务对应的注册表(即: 服务的实例列表)。</p>
</li>
</ol>
<p><strong>2&gt; Feign如何使用Ribbon进行负载均衡?</strong>
feign是基于ribbon的ZoneAwareLoadBalancer来进行负载均衡的,从一个server list中选择出来一个server。</p>
<p>接着上面的内容,进入到FeignLoadBalancer的executeWithLoadBalancer()方法;</p>
<p>由于AbstractLoadBalancerAwareClient是FeignLoadBalancer的父类,FeignLoadBalancer类中没有重写executeWithLoadBalancer()方法,进入到AbstractLoadBalancerAwareClient#executeWithLoadBalancer()方法:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403071635683.png" alt="202403071635683"/></p>
<p>方法逻辑解析:</p>
<blockquote>
<ol>
<li>
<p>首先构建一个LoadBalancerCommand,LoadBalancerCommand刚创建的时候里面的server是null,也就是还没确定要对哪个server发起请求;</p>
</li>
<li>
<p>command.submit()方法的代码块,本质上是重写了LoadBalancerCommand#submit(ServerOperation&lt;T&gt;)方法入参ServerOperation的call()方法。</p>
<ul>
<li>call()方法内部根据选择出的Server构造出具体的http请求地址,然后基于底层的http通信组件,发送出去这个请求。</li>
<li>call()方法是被内嵌到LoadBalancerCommand#submit()方法中的,也就是在执行LoadBalancerCommand的时候会调用call()方法;</li>
</ul>
</li>
<li>
<p>最后通过command.toBlocking().single()方法,进行阻塞式的同步执行,获取到响应结果。</p>
</li>
</ol>
</blockquote>
<p>从整体来看,ServerOperation中封装了负载均衡选择出来的server,然后直接基于这个server替换掉请求URL中的服务名,拼接出最终的请求URL地址,然后基于底层的http组件发送请求。</p>
<p>LoadBalancerCommand肯定是在某个地方使用Ribbon的ZoneAwareLoadBalancer负载均衡选择出来了一个server,然后将这个server,交给ServerOpretion中的call()方法去处理。</p>
<p>结合方法的命名找到LoadBalancerCommand#selectServer():</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403071639910.png" alt="202403071639910"/></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403071640043.png" alt="202403071640043"/></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403071642161.png" alt="202403071642161"/></p>
<p>selectServer()方法逻辑解析:</p>
<blockquote>
<p>在这个方法中,就是直接基于Feign集成的Ribbon的<code>ZoneAwareLoadBalancer</code>的 chooseServer() 方法,通过负载均衡机制选择了一个server出来。</p>
<ul>
<li>先通过LoadBalancerContext#getServerFromLoadBalancer()方法获取到ILoadBalancer;</li>
<li>在利用ILoadBalancer#chooseServer()方法选择出一个Server。</li>
</ul>
</blockquote>
<p>选择出一个Server之后,再去调用ServerOperation.call()方法,由call()方法拼接出最终的请求URI,发送http请求;</p>
<p><strong>3&gt; 最终发送出去的请求URI是什么样的?</strong>
ServerOperation#call()方法里负责发送请求,在executeWithLoadBalancer()方法中重写了LoadBalancerCommand#command()方法中入参ServerOperation的call()方法;</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403071648955.png" alt="202403071648955"/></p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> URI </span><span style="color:#B392F0">reconstructURIWithServer</span><span style="color:#E1E4E8">(Server server, URI original) {</span></span>
<span class="line"><span style="color:#6A737D">  // 获取服务 ip</span></span>
<span class="line"><span style="color:#E1E4E8">  String host </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> server.</span><span style="color:#B392F0">getHost</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">  // 获取服务的 port</span></span>
<span class="line"><span style="color:#F97583">  int</span><span style="color:#E1E4E8"> port </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> server.</span><span style="color:#B392F0">getPort</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">  // 获取请求协议,这里为 http</span></span>
<span class="line"><span style="color:#E1E4E8">  String scheme </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> server.</span><span style="color:#B392F0">getScheme</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (host.</span><span style="color:#B392F0">equals</span><span style="color:#E1E4E8">(original.</span><span style="color:#B392F0">getHost</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#F97583">        &amp;&amp;</span><span style="color:#E1E4E8"> port </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> original.</span><span style="color:#B392F0">getPort</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">        &amp;&amp;</span><span style="color:#E1E4E8"> scheme </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> original.</span><span style="color:#B392F0">getScheme</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> original;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (scheme </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    scheme </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> original.</span><span style="color:#B392F0">getScheme</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (scheme </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    scheme </span><span style="color:#F97583">=</span><span style="color:#B392F0"> deriveSchemeAndPortFromPartialUri</span><span style="color:#E1E4E8">(original).</span><span style="color:#B392F0">first</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    StringBuilder sb </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> StringBuilder</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">    // 拼接请求协议,此时请求为 http://</span></span>
<span class="line"><span style="color:#E1E4E8">    sb.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(scheme).</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;://&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">Strings.</span><span style="color:#B392F0">isNullOrEmpty</span><span style="color:#E1E4E8">(original.</span><span style="color:#B392F0">getRawUserInfo</span><span style="color:#E1E4E8">())) {</span></span>
<span class="line"><span style="color:#E1E4E8">      sb.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(original.</span><span style="color:#B392F0">getRawUserInfo</span><span style="color:#E1E4E8">()).</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;@&quot;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // 拼接请求 ip,此时请求为 http://192.168.1.3</span></span>
<span class="line"><span style="color:#E1E4E8">    sb.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(host);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (port </span><span style="color:#F97583">&gt;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">      // 拼接请求 post,此时请求为 http://192.168.1.3:8082</span></span>
<span class="line"><span style="color:#E1E4E8">      sb.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;:&quot;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(port);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // 拼接请求路径,此时请求为 http://192.168.1.3:8082/user/sayHello/1</span></span>
<span class="line"><span style="color:#E1E4E8">    sb.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(original.</span><span style="color:#B392F0">getRawPath</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#6A737D">    // 拼接请求查询参数,此时请求为 http:///user/sayHello/1?name=zhangsan&amp;age=18</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">Strings.</span><span style="color:#B392F0">isNullOrEmpty</span><span style="color:#E1E4E8">(original.</span><span style="color:#B392F0">getRawQuery</span><span style="color:#E1E4E8">())) {</span></span>
<span class="line"><span style="color:#E1E4E8">      sb.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;?&quot;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(original.</span><span style="color:#B392F0">getRawQuery</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">Strings.</span><span style="color:#B392F0">isNullOrEmpty</span><span style="color:#E1E4E8">(original.</span><span style="color:#B392F0">getRawFragment</span><span style="color:#E1E4E8">())) {</span></span>
<span class="line"><span style="color:#E1E4E8">      sb.</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&quot;#&quot;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">append</span><span style="color:#E1E4E8">(original.</span><span style="color:#B392F0">getRawFragment</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    URI newURI </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> URI</span><span style="color:#E1E4E8">(sb.</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> newURI;</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (URISyntaxException </span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> RuntimeException</span><span style="color:#E1E4E8">(e);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>方法逻辑解析:</p>
<blockquote>
<p>根据之前处理好的请求URI和Server的地址拼接出真实的地址; 依次拼接http://,服务的IP,服务的Port,请求路径,查询参数,最终体现为:</p>
<ul>
<li>原request的uri: GET http:///user/sayHello/1?name=saint&amp;age=18 HTTP/1.1</li>
<li>server地址: 192.168.1.3:8082</li>
<li>拼接后的地址: &lt;<a href="http://192.168.1.3:8082/user/sayHello/1?name=saint&age=18">http://192.168.1.3:8082/user/sayHello/1?name=saint&amp;age=18</a>&gt;</li>
</ul>
</blockquote>
<p>接着使用拼接后的地址替换掉request.uri,再调用FeignLoadBalacner#execute()方法发送一个http请求;其中发送请求的超时时间默认为1000ms,即1s;最后返回结果封装到FeignLoadBalancer.RibbonResponse。</p>
<h6 id="指定decoder时对请求返回结果解码">指定Decoder时对请求返回结果解码</h6>
<p>如果配置了decoder,则使用Decoder#decode()方法对结果进行解码;</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#F97583"> interface</span><span style="color:#B392F0"> Decoder</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  /**</span></span>
<span class="line"><span style="color:#6A737D">   * Decodes an http response into an object corresponding to its</span></span>
<span class="line"><span style="color:#6A737D">   * {</span><span style="color:#F97583">@link</span><span style="color:#B392F0"> java.lang.reflect.Method</span><span style="color:#6A737D">#</span><span style="color:#FFAB70">getGenericReturnType()</span><span style="color:#6A737D"> generic return type}. If you need to</span></span>
<span class="line"><span style="color:#6A737D">   * wrap exceptions, please do so via {@link DecodeException}.</span></span>
<span class="line"><span style="color:#6A737D">   *</span></span>
<span class="line"><span style="color:#6A737D">   * </span><span style="color:#F97583">@param</span><span style="color:#FFAB70"> response</span><span style="color:#6A737D"> the response to decode</span></span>
<span class="line"><span style="color:#6A737D">   * </span><span style="color:#F97583">@param</span><span style="color:#FFAB70"> type</span><span style="color:#6A737D"> {</span><span style="color:#F97583">@link</span><span style="color:#B392F0"> java.lang.reflect.Method</span><span style="color:#6A737D">#</span><span style="color:#FFAB70">getGenericReturnType()</span><span style="color:#6A737D"> generic return type} of the</span></span>
<span class="line"><span style="color:#6A737D">   *        method corresponding to this {@code response}.</span></span>
<span class="line"><span style="color:#6A737D">   * </span><span style="color:#F97583">@return</span><span style="color:#6A737D"> instance of {@code type}</span></span>
<span class="line"><span style="color:#6A737D">   * </span><span style="color:#F97583">@throws</span><span style="color:#B392F0"> IOException</span><span style="color:#6A737D"> will be propagated safely to the caller.</span></span>
<span class="line"><span style="color:#6A737D">   * </span><span style="color:#F97583">@throws</span><span style="color:#B392F0"> DecodeException</span><span style="color:#6A737D"> when decoding failed due to a checked exception besides IOException.</span></span>
<span class="line"><span style="color:#6A737D">   * </span><span style="color:#F97583">@throws</span><span style="color:#B392F0"> FeignException</span><span style="color:#6A737D"> when decoding succeeds, but conveys the operation failed.</span></span>
<span class="line"><span style="color:#6A737D">   */</span></span>
<span class="line"><span style="color:#E1E4E8">  Object </span><span style="color:#B392F0">decode</span><span style="color:#E1E4E8">(Response </span><span style="color:#FFAB70">response</span><span style="color:#E1E4E8">, Type </span><span style="color:#FFAB70">type</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throws</span><span style="color:#E1E4E8"> IOException, DecodeException, FeignException;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  /** Default implementation of {@code Decoder}. */</span></span>
<span class="line"><span style="color:#F97583">  public</span><span style="color:#F97583"> class</span><span style="color:#B392F0"> Default</span><span style="color:#F97583"> extends</span><span style="color:#B392F0"> StringDecoder</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    @</span><span style="color:#F97583">Override</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#E1E4E8"> Object </span><span style="color:#B392F0">decode</span><span style="color:#E1E4E8">(Response </span><span style="color:#FFAB70">response</span><span style="color:#E1E4E8">, Type </span><span style="color:#FFAB70">type</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throws</span><span style="color:#E1E4E8"> IOException {</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (response.</span><span style="color:#B392F0">status</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 404</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> response.</span><span style="color:#B392F0">status</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 204</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> Util.</span><span style="color:#B392F0">emptyValueOf</span><span style="color:#E1E4E8">(type);</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (response.</span><span style="color:#B392F0">body</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">byte</span><span style="color:#E1E4E8">[].class.</span><span style="color:#B392F0">equals</span><span style="color:#E1E4E8">(type)) {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> Util.</span><span style="color:#B392F0">toByteArray</span><span style="color:#E1E4E8">(response.</span><span style="color:#B392F0">body</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">asInputStream</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#79B8FF"> super</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">decode</span><span style="color:#E1E4E8">(response, type);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<h6 id="默认情况下feign接收到服务返回的结果后如何处理">默认情况下,Feign接收到服务返回的结果后,如何处理?</h6>
<p>即: 未指定decoder时,会直接使用AsyncResponseHandler#handleResponse()方法处理接收到的服务返回结果:</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403071718925.png" alt="202403071718925"/></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou403/pic-md@main//img/202403071723997.png" alt="202403071723997"/></p>
<p>如果响应结果的returnType为Response时,则将return信息的body()解析成byte数组,放到resultFuture的RESULT中;然后SynchronousMethodHandler#executeAndDecode()方法中通过resultFuture.join()方法拿到RESULT(即: 请求的真正的响应结果)。</p>
<p>一般而言,会走到如下else if 分支</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#6A737D">// 请求成功后,返回结果类型为 void,则处理的返回结果赋值 null</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">isVoidType</span><span style="color:#E1E4E8">(returnType)) {</span></span>
<span class="line"><span style="color:#E1E4E8">  resultFuture.</span><span style="color:#B392F0">complete</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">} </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  // 解析请求的返回结果</span></span>
<span class="line"><span style="color:#F97583">  final</span><span style="color:#E1E4E8"> Object result </span><span style="color:#F97583">=</span><span style="color:#B392F0"> decode</span><span style="color:#E1E4E8">(response, returnType);</span></span>
<span class="line"><span style="color:#E1E4E8">  shouldClose </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> closeAfterDecode;</span></span>
<span class="line"><span style="color:#E1E4E8">  resultFuture.</span><span style="color:#B392F0">complete</span><span style="color:#E1E4E8">(result);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>decode()方法中将response处理为我们要的returnType,比如调用的服务方返回给我们一个JSON字符串,decode()方法中会将其转换为我们需要的JavaBean(即: returnType,当前方法的返回值)。</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#E1E4E8">Object </span><span style="color:#B392F0">decode</span><span style="color:#E1E4E8">(Response response, Type type) throws IOException {</span></span>
<span class="line"><span style="color:#F97583">  try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> decoder.</span><span style="color:#B392F0">decode</span><span style="color:#E1E4E8">(response, type);</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">final</span><span style="color:#E1E4E8"> FeignException </span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    throw</span><span style="color:#E1E4E8"> e;</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">final</span><span style="color:#E1E4E8"> RuntimeException </span><span style="color:#FFAB70">e</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> DecodeException</span><span style="color:#E1E4E8">(response.</span><span style="color:#B392F0">status</span><span style="color:#E1E4E8">(), e.</span><span style="color:#B392F0">getMessage</span><span style="color:#E1E4E8">(), response.</span><span style="color:#B392F0">request</span><span style="color:#E1E4E8">(), e);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div> 
<p>deocode()方法中会用到一个Decoder,decoder默认是OptionalDecoder,针对JavaBean返回类型,OptionalDecoder将decode委托给ResponseEntityDecoder处理。</p>
<h4 id="总结">总结</h4>
<blockquote>
<ol>
<li>请求达到FeignClient时,会进入到JDK动态代理类,由ReflectiveFeign#FeignInvocationHandler分发处理请求;找到接口方法对应的SynchronousMethodHandler;</li>
<li>SynchronousMethodHandler中首先使用SpringMvcContract解析标注了SpringMvc注解的参数;然后使用encoder对请求进行编码;</li>
<li>RequestInterceptor对Request进行拦截处理;</li>
<li>LoadBalancerFeignClient通过集成的Ribbon的负载均衡器(<code>ZoneAwareLoadBalancer</code>)实现负载均衡找到一个可用的Server,交给RibbonRequest组合的Client去做HTTP请求,这里的Client可以是HttpUrlConnection,HttpClient,OKHttp。</li>
<li>最后Decoder对Response响应进行解码。</li>
</ol>
</blockquote>
<h2 id="openfeign新版本和旧版本之间的差异高版本openfeign底层不使用ribbon做负载均衡">OpenFeign新版本和旧版本之间的差异(高版本OpenFeign底层不使用Ribbon做负载均衡)</h2>
<h3 id="feignclientsregistrar开启对feignclient的扫描">@FeignClientsRegistrar开启对FeignClient的扫描</h3>
<p><strong>此处主流程上无区别:</strong>
在SpringBoot启动流程中 @FeignClientsRegistrar 注解开启OpenFeign的入口,OpenFeign扫描所有的FeignClient的流程,高版本和低版本基本一样。</p>
<p>主要流程如下:</p>
<blockquote>
<p>1&gt; 开启扫描FeignClient的入口:</p>
<ol>
<li>启动类上添加的@EnableFeignClients注解会通过@Import注解在SpringBoot启动流程中将ImportBeanDefinitionRegistrar接口的实现类FeignClientsRegistrar注入到启动类的ConfigurationClass的属性中,在注册启动类的BeanDefinition时,会遍历调用其@Import的所有ImportBeanDefinitionRegistrar接口的 registerBeanDefinitions()方法。</li>
</ol>
<p>2&gt; 扫描FeignClient:</p>
<ol>
<li>拿到@EnableFeignClients注解中配置的扫描包路径相关的属性,得到要扫描的包路径;</li>
<li>获取到扫描器ClassPathScanningCandidateComponentProvider,然后给其添加一个注解过滤器(AnnotationTypeFilter),只过滤出包含@FeignClient注解的BeanDefinition;</li>
<li>扫描器的findCandidateComponents(basePackage)方法从包路径下扫描出所有标注了@FeignClient注解并符合条件装配的接口;然后将其在BeanDefinitionRegistry中注册一下;</li>
</ol>
</blockquote>
<h3 id="为feignclient生成动态代理类">为FeignClient生成动态代理类</h3>
<p><strong>区别主要体现在这里:</strong>
在注册FeignClient到Spring容器时,构建的BeanDefinition的beanClas是FeignClientFactoryBean;FeignClientFactoryBean是一个工厂,保存了@FeignClient注解的所有属性值,在Spring容器初始化的过程中,其会根据之前扫描出的FeignClient信息构建FeignClient的动态代理类。</p>
<p><strong>底层通信Client的区别?</strong>
在使用Feign.Builder构建FeignClient的时候,获取到的Client是FeignBlockingLoadBalancerClient(这其中的逻辑后面聊,在OpenFeign低版本是LoadBalancerFeignClient);用于生成FeignClient的Targeter是DefaultTargeter(在OpenFeign低版本是HystrixTargeter,高版本移除了Hystrix,采用Spring Cloud Circuit Breaker 做限流熔断);</p>
<p>具体体现在FeignClientFactoryBean#loadBalance()方法,其是一个进行负载均衡的FeignClient动态代理生成方法;</p>
<p><strong>1&gt; FeignBlockingLoadBalancerClient何时注入到Spring容器?</strong></p>
<p>FeignBlockingLoadBalancerClient注入到Spring容器的方式和OpenFeign低版本的LoadBalancerFeignClient是一样的;</p>
<p>进入到FeignBlockingLoadBalancerClient类中,看哪里调用了它唯一一个构造函数;</p>
<p>找到FeignBlockingLoadBalancerClient发现有三个地方调用了它的构造函数,new了一个实例;</p>
<ul>
<li>DefaultFeignLoadBalancedConfiguration</li>
<li>HttpClientFeignLoadBalancedConfiguration</li>
<li>OkHttpFeignLoadBalancedConfiguration</li>
</ul>
<p>再结合默认的配置,只有DefaultFeignLoadBalancedConfiguration中的Client符合条件装配;</p>
<p>可以通过引入Apache HttpClient的maven依赖使用HttpClientFeignLoadBalancedConfiguration,或引入OkHttpClient的maven依赖并在application.yml文件中指定feign.okhttp.enabled属性为true使用OkHttpFeignLoadBalancedConfiguration。</p>
<p><strong>2&gt; DefaultTargeter在哪里注入到Spring容器?</strong></p>
<p>DefaultTargeter注入到Spring容器的方式和OpenFeign低版本的HystrixTargeter是一样的;</p>
<p>在FeignAutoConfiguration类中可以找到Targeter注入到Spring容器的逻辑;</p>
<p><strong>3&gt; 后续生成动态代理类的逻辑和旧版本一样</strong>
都体现在ReflectiveFeign#newInstance()方法中:</p>
<h3 id="client处理负载均衡核心区别">Client处理负载均衡(核心区别)</h3>
<p>上面提到OpenFeign高版本获取到的Client是<code>FeignBlockingLoadBalancerClient</code>,而低版本的是<code>LoadBalancerFeignClient</code>,LoadBalancerFeignClient基于Ribbon实现负载均衡,FeignBlockingLoadBalancerClient就靠OpenFeign(通过loadBalancerClient)实现负载均衡;</p>
<p><strong>FeignBlockingLoadBalancerClient是如何做负载均衡的:</strong>
1&gt; FeignBlockingLoadBalancerClient选择一个服务实例</p>
<!-- remove bg-neutral-200/30 --><div class="code-container"> <pre class="shiki shiki-themes code dark:shadow-2xl"><button aria-label="copy-button" class="copy-button rounded-md transition-all ease-in dark:text-gray-600 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 z-[2]"><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M8 8m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v8a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z"></path> <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path> </svg></button><span class="check-span rounded-md transition-all ease-in opacity-0 text-green-600 dark:text-green-400"><svg class="icon icon-tabler icon-tabler-check" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M5 12l5 5l10 -10"></path> </svg></span><code><span class="line"><span style="color:#F97583">public</span><span style="color:#E1E4E8"> Response </span><span style="color:#B392F0">execute</span><span style="color:#E1E4E8">(Request request, Request.Options options) throws IOException {</span></span>
<span class="line"><span style="color:#6A737D">  // 将请求的 url 封装成 uri</span></span>
<span class="line"><span style="color:#E1E4E8">  URI originalUri </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> URI.</span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">(request.</span><span style="color:#B392F0">url</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#6A737D">  // 获取要请求的服务名</span></span>
<span class="line"><span style="color:#E1E4E8">  String serviceId </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> originalUri.</span><span style="color:#B392F0">getHost</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  Assert.</span><span style="color:#B392F0">state</span><span style="color:#E1E4E8">(serviceId </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&quot;Request URI does not contain a valid hostname: &quot;</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> originalUri);</span></span>
<span class="line"><span style="color:#E1E4E8">  String hint </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getHint</span><span style="color:#E1E4E8">(serviceId);</span></span>
<span class="line"><span style="color:#E1E4E8">  DefaultRequest&lt;</span><span style="color:#F97583">RequestDataContext</span><span style="color:#E1E4E8">&gt; lbRequest </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> DefaultRequest</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> RequestDataContext</span><span style="color:#E1E4E8">(LoadBalancerUtils.</span><span style="color:#B392F0">buildRequestData</span><span style="color:#E1E4E8">(request), hint));</span></span>
<span class="line"><span style="color:#E1E4E8">  Set&lt;</span><span style="color:#F97583">LoadBalancerLifecycle</span><span style="color:#E1E4E8">&gt; supportedLifecycleProcessors </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> LoadBalancerLifecycleValidator.</span><span style="color:#B392F0">getSupportedLifecycleProcessors</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.loadBalancerClientFactory.</span><span style="color:#B392F0">getInstances</span><span style="color:#E1E4E8">(serviceId, LoadBalancerLifecycle.class), RequestDataContext.class, ResponseData.class, ServiceInstance.class);</span></span>
<span class="line"><span style="color:#E1E4E8">  supportedLifecycleProcessors.</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">((lifecycle) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    lifecycle.</span><span style="color:#B392F0">onStart</span><span style="color:#E1E4E8">(lbRequest);</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#6A737D">  // 选择一个服务实例</span></span>
<span class="line"><span style="color:#E1E4E8">  ServiceInstance instance </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.loadBalancerClient.</span><span style="color:#B392F0">choose</span><span style="color:#E1E4E8">(serviceId, lbRequest);</span></span>
<span class="line"><span style="color:#E1E4E8">  org.springframework.cloud.client.loadbalancer.Response&lt;</span><span style="color:#F97583">ServiceInstance</span><span style="color:#E1E4E8">&gt; lbResponse </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> DefaultResponse</span><span style="color:#E1E4E8">(instance);</span></span>
<span class="line"><span style="color:#E1E4E8">  String message;</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (instance </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    message </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> &quot;Load balancer does not contain an instance for the service &quot;</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> serviceId;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (LOG.</span><span style="color:#B392F0">isWarnEnabled</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#E1E4E8">      LOG.</span><span style="color:#B392F0">warn</span><span style="color:#E1E4E8">(message);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    supportedLifecycleProcessors.</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">((lifecycle) </span><span style="color:#F97583">-&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      lifecycle.</span><span style="color:#B392F0">onComplete</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">new</span><span style="color:#B392F0"> CompletionContext</span><span style="color:#E1E4E8">(Status.DISCARD, lbRequest, lbResponse));</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> Response.</span><span style="color:#B392F0">builder</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">request</span><span style="color:#E1E4E8">(request).</span><span style="color:#B392F0">status</span><span style="color:#E1E4E8">(HttpStatus.SERVICE_UNAVAILABLE.</span><span style="color:#B392F0">value</span><span style="color:#E1E4E8">()).</span><span style="color:#B392F0">body</span><span style="color:#E1E4E8">(message, StandardCharsets.UTF_8).</span><span style="color:#B392F0">build</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // 构建完整的请求 url</span></span>
<span class="line"><span style="color:#E1E4E8">    message </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.loadBalancerClient.</span><span style="color:#B392F0">reconstructURI</span><span style="color:#E1E4E8">(instance, originalUri).</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    Request newRequest </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">buildRequest</span><span style="color:#E1E4E8">(request, message, instance);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> LoadBalancerUtils.</span><span style="color:#B392F0">executeWithLoadBalancerLifecycleProcessing</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.delegate, options, newRequest, lbRequest, lbResponse, supportedLifecycleProcessors);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre> </div>  </div> <div class="mb-12 flex flex-wrap gap-2 gap-y-4 md:gap-5"> <a href="/tags/java" aria-label="java"> <!-- <span
		class="w-fit rounded-full bg-indigo-600 px-2 py-1 text-sm font-semibold text-white shadow dark:bg-indigo-900 dark:text-white md:px-5 md:py-2"
	> --> <span class="w-fit rounded-full px-2 py-1 text-sm font-semibold shadow dark:bg-indigo-900 dark:text-white md:px-5 md:py-2">
#java </span> </a><a href="/tags/feign" aria-label="feign"> <!-- <span
		class="w-fit rounded-full bg-indigo-600 px-2 py-1 text-sm font-semibold text-white shadow dark:bg-indigo-900 dark:text-white md:px-5 md:py-2"
	> --> <span class="w-fit rounded-full px-2 py-1 text-sm font-semibold shadow dark:bg-indigo-900 dark:text-white md:px-5 md:py-2">
#feign </span> </a> </div> <!-- related posts --> <footer> <h2 class="mb-6 text-lg font-bold dark:text-white">Related Posts</h2> <section class="flex flex-col md:flex-row sm:justify-between gap-8"> <div class="flex flex-wrap gap-2"> <div class="min-h-full"> <img src="/_astro/cat-27_11KuUl.webp" class="h-16 w-16 rounded-full object-cover" alt="img of Single test coverage statistical principle" width="200" height="200" loading="lazy" decoding="async"> </div> <header class="flex items-center justify-center"> <a class="font-medium hover:underline" href="/post/zh-cn/interview/unittest/single-test-coverage-statistical-principle/"> 单测覆盖率是如何统计的?原理是什么? </a> </header> </div><div class="flex flex-wrap gap-2"> <div class="min-h-full"> <img src="/_astro/bird-8_1aXH60.webp" class="h-16 w-16 rounded-full object-cover" alt="img of How to unit test the JDBC layer" width="200" height="200" loading="lazy" decoding="async"> </div> <header class="flex items-center justify-center"> <a class="font-medium hover:underline" href="/post/zh-cn/interview/unittest/how-to-unit-test-the-jdbc-layer/"> 如何对JDBC这一层做单元测试 </a> </header> </div><div class="flex flex-wrap gap-2"> <div class="min-h-full"> <img src="/_astro/pexels-valeriia-harbuz-2161259-27322181_Z1evgWL.webp" class="h-16 w-16 rounded-full object-cover" alt="img of How to make a single test Mock" width="200" height="200" loading="lazy" decoding="async"> </div> <header class="flex items-center justify-center"> <a class="font-medium hover:underline" href="/post/zh-cn/interview/unittest/how-to-make-a-single-test-mock/"> 什么是Mock?怎么做单测的Mock? </a> </header> </div> </section> </footer> </article> </div>  </div> </article> <button aria-label="Back to Top" class="z-90 fixed bottom-8 end-4 flex h-10 w-10 translate-y-28 items-center justify-center rounded-full border-2 border-transparent bg-[#f8f9fa99] text-3xl opacity-0 transition-all duration-300 hover:border-zinc-400 data-[show=true]:translate-y-0 data-[show=true]:opacity-100 dark:border-slate-50/[0.06] dark:bg-slate-900/75 sm:end-8 sm:h-12 sm:w-12" data-show="false" id="to-top-btn" style="opacity: 1;--tw-translate-y: -26px;
		transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));"> <svg aria-hidden="true" class="h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M4.5 15.75l7.5-7.5 7.5 7.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button>  <footer class="flex h-28 w-full items-center justify-center border-t-2 px-16">
&copy; 2024 chou403 · Powered by &nbsp;<a href="https://astro.build" style="color:cornflowerblue;">Astro</a>&nbsp;& &nbsp;<a href="https://blog-template-gray.vercel.app" style="color:cornflowerblue;">OpenBlog</a> </footer> </main>    </body> </html>  <div> <div class="fixed inset-0 z-50 hidden" id="headlessui-dialog-:Rlb6:" role="dialog" aria-modal="true" data-headlessui-state="open"> <div class="fixed inset-0 bg-black/20 backdrop-blur-sm dark:bg-slate-900/80" id="" aria-hidden="true" data-headlessui-state="open"></div> <div class="relative w-80 max-w-[calc(100%-3rem)] bg-white p-6 dark:bg-slate-800" id="toc_content"> <button id="close-dialog-page" type="button" class="absolute right-5 top-5 z-10 flex h-8 w-8 items-center justify-center text-slate-500 hover:text-slate-600 dark:text-slate-400 dark:hover:text-slate-300" tabindex="0"><span class="sr-only">Close navigation</span> <svg viewBox="0 0 10 10" class="h-2.5 w-2.5 overflow-visible"> <path d="M0 0L10 10M10 0L0 10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path> </svg> </button> <nav class="h-[59rem] max-w-xs dark:text-black"> <h1 class="mb-3 text-2xl font-bold dark:text-white">On this page</h1> <ul class="sidebar flex flex-col gap-4 [text-wrap:balance]"> <li class="flex flex-col"> <a href="#什么是feign" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 什么是Feign </a>  </li><li class="flex flex-col"> <a href="#什么是openfeign" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 什么是openFeign </a>  </li><li class="flex flex-col"> <a href="#feign与openfeign的对比" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Feign与OpenFeign的对比 </a>  </li><li class="flex flex-col"> <a href="#openfeign使用" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> openFeign使用 </a>  </li><li class="flex flex-col"> <a href="#openfeign超时处理" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> OpenFeign超时处理 </a>  </li><li class="flex flex-col"> <a href="#openfeign日志增强" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> OpenFeign日志增强 </a>  </li><li class="flex flex-col"> <a href="#openfeign-实现-requestinterceptor" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> OpenFeign 实现 RequestInterceptor </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#requestinterceptor-实现类" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> RequestInterceptor 实现类 </a>  </li><li class="flex flex-col"> <a href="#使-requestinterceptor-生效" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 使 RequestInterceptor 生效 </a>  </li><li class="flex flex-col"> <a href="#服务提供者增加拦截器用于获取请求头中的数据" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 服务提供者增加拦截器(用于获取请求头中的数据) </a>  </li><li class="flex flex-col"> <a href="#结合-hystrix-限流使用的坑" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 结合 Hystrix 限流使用的坑 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#原因分析" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 原因分析 </a>  </li><li class="flex flex-col"> <a href="#解决方案" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 解决方案 </a>  </li><li class="flex flex-col"> <a href="#hystrix-线程池和信号量隔离区别" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> hystrix 线程池和信号量隔离区别 </a>  </li><li class="flex flex-col"> <a href="#线程和信号量隔离的使用场景" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 线程和信号量隔离的使用场景 </a>  </li> </ul> </li> </ul> </li><li class="flex flex-col"> <a href="#openfeign-核心组件" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> openfeign 核心组件 </a>  </li><li class="flex flex-col"> <a href="#openfeign-如何扫描所有-feignclient基于低版本-springcloud-20200x版本之前" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> openfeign 如何扫描所有 FeignClient(基于低版本 SpringCloud 2020.0.x版本之前) </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#feignclient解析" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> @FeignClient解析 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#feignclient注解解释" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> @FeignClient注解解释 </a>  </li><li class="flex flex-col"> <a href="#feignclient-注解作用" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> @FeignClient 注解作用 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#使用-ribbonclient-自定义负载均衡策略" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 使用 @RibbonClient 自定义负载均衡策略 </a>  </li> </ul> </li> </ul> </li><li class="flex flex-col"> <a href="#enablefeignclients-解析" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> @EnableFeignClients 解析 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#feignclientsregistrar-类" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> FeignClientsRegistrar 类 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#注册默认配置" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 注册默认配置 </a>  </li><li class="flex flex-col"> <a href="#注册所有的-feignclient" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 注册所有的 FeignClient </a>  </li><li class="flex flex-col"> <a href="#获取包扫描路径" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 获取包扫描路径 </a>  </li><li class="flex flex-col"> <a href="#扫描所有的-feignclient" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 扫描所有的 FeignClient </a>  </li><li class="flex flex-col"> <a href="#注册feignclient" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 注册FeignClient </a>  </li> </ul> </li> </ul> </li><li class="flex flex-col"> <a href="#feignclient-的动态代理类" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> FeignClient 的动态代理类 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#feignclientfactorybean-创建动态代理类的入口" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> FeignClientFactoryBean 创建动态代理类的入口 </a>  </li><li class="flex flex-col"> <a href="#feignbuilder的构建过程" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Feign.Builder的构建过程 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#feigncontext-上下文的获取" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> FeignContext 上下文的获取 </a>  </li><li class="flex flex-col"> <a href="#从-feignclient-中获取-feignbuilder" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 从 FeignClient 中获取 Feign.Builder </a>  </li><li class="flex flex-col"> <a href="#处理配置信息" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 处理配置信息 </a>  </li><li class="flex flex-col"> <a href="#使用-feignbuilder-构建出一个-feignclient" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 使用 Feign.Builder 构建出一个 FeignClient </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#loadbalancerfeignclient-在哪里注入到-spring-容器" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> LoadBalancerFeignClient 在哪里注入到 Spring 容器 </a>  </li><li class="flex flex-col"> <a href="#hystrixtargeter-在哪里注入到-spring-容器" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> HystrixTargeter 在哪里注入到 Spring 容器 </a>  </li><li class="flex flex-col"> <a href="#hystrixtargetertarget方法" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> HystrixTargeter#target()方法 </a>  </li><li class="flex flex-col"> <a href="#reflectivefeignnewinstance生成动态代理类" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> ReflectiveFeign#newInstance()生成动态代理类 </a>  </li><li class="flex flex-col"> <a href="#parsehandlersbynameapply解析feignclient中的方法" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> ParseHandlersByName#apply()解析FeignClient中的方法 </a>  </li><li class="flex flex-col"> <a href="#springmvccontract组件的工作原理" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> SpringMvcContract组件的工作原理 </a>  </li> </ul> </li> </ul> </li> </ul> </li><li class="flex flex-col"> <a href="#openfeign处理http请求" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> OpenFeign处理HTTP请求 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#动态代理处理请求的入口" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 动态代理处理请求的入口 </a>  </li><li class="flex flex-col"> <a href="#synchronousmethodhandler-处理请求机制" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> SynchronousMethodHandler 处理请求机制 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#创建请求模版springmvccontract-解析方法参数" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 创建请求模版(SpringMvcContract 解析方法参数) </a>  </li><li class="flex flex-col"> <a href="#执行请求并解码返回值" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 执行请求并解码返回值 </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#应用所有的-requestinterceptor" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 应用所有的 RequestInterceptor </a>  </li><li class="flex flex-col"> <a href="#loadbalancerfeignclient-负载均衡执行请求详述" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> LoadBalancerFeignClient 负载均衡执行请求详述 </a>  </li><li class="flex flex-col"> <a href="#指定decoder时对请求返回结果解码" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 指定Decoder时对请求返回结果解码 </a>  </li><li class="flex flex-col"> <a href="#默认情况下feign接收到服务返回的结果后如何处理" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 默认情况下,Feign接收到服务返回的结果后,如何处理? </a>  </li> </ul> </li> </ul> </li><li class="flex flex-col"> <a href="#总结" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 总结 </a>  </li> </ul> </li> </ul> </li><li class="flex flex-col"> <a href="#openfeign新版本和旧版本之间的差异高版本openfeign底层不使用ribbon做负载均衡" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> OpenFeign新版本和旧版本之间的差异(高版本OpenFeign底层不使用Ribbon做负载均衡) </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#feignclientsregistrar开启对feignclient的扫描" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> @FeignClientsRegistrar开启对FeignClient的扫描 </a>  </li><li class="flex flex-col"> <a href="#为feignclient生成动态代理类" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> 为FeignClient生成动态代理类 </a>  </li><li class="flex flex-col"> <a href="#client处理负载均衡核心区别" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Client处理负载均衡(核心区别) </a>  </li> </ul> </li> </ul> </nav> </div> </div> </div> 